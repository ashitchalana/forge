<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Forge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ══════════════════════════════════════════
   FORGE DESIGN SYSTEM
══════════════════════════════════════════ */
/* MISSION CONTROL */
.mc-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:24px; }
.mc-agent-card { background:rgba(255,255,255,0.65); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px); border:1px solid var(--bd); border-radius:12px; padding:16px; cursor:pointer; transition:all .2s; animation:slideUp .3s ease both; }
[data-theme="dark"] .mc-agent-card { background:rgba(15,13,28,0.55); }
.mc-agent-card:hover { border-color:var(--bd2); transform:translateY(-2px); box-shadow:0 8px 24px var(--glow2); }
.mc-spawn-card { display:flex; align-items:center; justify-content:center; gap:8px; border:1px dashed var(--bd2) !important; color:var(--tx4); font-size:12px; }
.mc-spawn-card:hover { border-color:var(--acc) !important; color:var(--acc); background:var(--glow); }
.mc-status-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.mc-status-dot.idle    { background:var(--green); box-shadow:0 0 6px rgba(22,163,74,.5); animation:mcpulse 2s infinite; }
.mc-status-dot.working { background:var(--amber); box-shadow:0 0 6px rgba(217,119,6,.5); animation:mcpulse 1.5s infinite; }
.mc-status-dot.busy    { background:var(--red);   box-shadow:0 0 6px rgba(220,38,38,.5); animation:mcpulse 1s infinite; }
@keyframes mcpulse { 0%,100%{opacity:1} 50%{opacity:.45} }
@keyframes slideUp  { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
/* KANBAN */
.kanban { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.kanban-col { background:var(--bg2); border-radius:10px; padding:12px; min-height:280px; }
.kanban-col-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.usage-bar { display:flex; gap:12px; padding:10px 20px; border-bottom:1px solid var(--bd); background:var(--bg); flex-wrap:wrap; align-items:center; }
.usage-stat { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--tx4); font-family:var(--font-m); }
.usage-stat strong { color:var(--tx2); font-weight:700; font-size:11px; }
.usage-dot { width:6px; height:6px; border-radius:50%; background:var(--green); display:inline-block; }
.kanban-col-title { font-size:11px; font-weight:600; letter-spacing:.05em; text-transform:uppercase; color:var(--tx3); }
.kanban-col-count { font-size:10px; background:var(--bg3); color:var(--tx3); padding:1px 7px; border-radius:20px; }
.task-card { background:rgba(255,255,255,0.72); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:1px solid var(--bd); border-radius:10px; padding:14px 14px 0 14px; margin-bottom:8px; cursor:pointer; transition:all .2s; overflow:hidden; }
[data-theme="dark"] .task-card { background:rgba(15,13,28,0.6); }
.task-card:hover { border-color:var(--bd2); box-shadow:0 4px 16px var(--glow); transform:translateY(-1px); }
.task-card.age-warn { box-shadow:0 0 0 1px rgba(217,119,6,.35), 0 0 10px rgba(217,119,6,.14); }
.task-card-body { padding-bottom:12px; }
.task-title { font-size:10.5px; font-weight:500; color:var(--tx); line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:6px; }
.task-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.priority-badge { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; }
.pb-p1 { background:rgba(220,38,38,.12);  color:#dc2626; }
.pb-p2 { background:rgba(217,119,6,.12);  color:#d97706; }
.pb-p3 { background:rgba(59,130,246,.12); color:#3b82f6; }
.pb-p4 { background:rgba(107,114,128,.12);color:#6b7280; }
.task-assignee { font-size:9px; font-weight:700; padding:2px 7px; border-radius:20px; background:rgba(99,102,241,.1); color:var(--acc); letter-spacing:.03em; font-family:var(--font-m); }
.task-eta { font-size:10px; color:var(--tx4); }
.assignee-chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
.assignee-chip { display:flex; align-items:center; gap:6px; padding:5px 11px 5px 6px; border-radius:20px; border:1.5px solid var(--bd); font-size:11px; font-weight:500; cursor:pointer; transition:all .15s; font-family:var(--font-b); color:var(--tx2); background:var(--sur); }
.assignee-chip:hover { border-color:var(--bd2); color:var(--tx); background:var(--bg3); }
.assignee-chip.selected { border-color:var(--acc); background:rgba(109,40,217,.06); color:var(--acc); font-weight:600; }
.assignee-chip-avatar { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:8px; font-weight:700; color:#fff; flex-shrink:0; }
.task-progress-wrap { margin-top:10px; }
.task-progress-bar  { height:3px; background:var(--bg3); border-radius:0 0 10px 10px; overflow:hidden; }
.task-progress-fill { height:100%; background:var(--acc); border-radius:0; transition:width .6s cubic-bezier(.4,0,.2,1); position:relative; }
.task-progress-fill::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.4) 50%,transparent 100%); animation:progress-shimmer 2s infinite; }
.task-progress-fill.pct-100 { background:linear-gradient(90deg,#16a34a,#22c55e); }
.task-progress-fill.pct-0 { background:var(--bg3); }
.task-card.is-done { opacity: 0.7; }
.task-card.is-done .task-title { text-decoration: line-through; color: var(--tx3); }
.task-card.is-done .task-progress-fill { background: var(--green); }
@keyframes progress-shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(200%)} }
/* TASK MODAL FIELDS */
.tmf { margin-bottom:14px; }
.tmf label { font-size:9.5px; font-weight:600; color:var(--tx3); display:block; margin-bottom:6px; text-transform:uppercase; letter-spacing:.08em; }
.tmf input,.tmf select,.tmf textarea { width:100%; background:var(--bg2); border:1px solid var(--bd); border-radius:7px; padding:9px 12px; font-size:12.5px; color:var(--tx); font-family:var(--font-b); box-sizing:border-box; transition:border-color .18s; }
.tmf input:focus,.tmf select:focus,.tmf textarea:focus { outline:none; border-color:var(--acc); }
.tmf textarea { resize:vertical; min-height:56px; }
/* MODAL HEADER */
.modal-header { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:20px; }
.modal-header-left { display:flex; flex-direction:column; gap:3px; flex:1; }
.modal-close { width:28px; height:28px; border:none; background:var(--bg3); color:var(--tx3); border-radius:7px; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background .15s,color .15s; }
.modal-close:hover { background:rgba(220,38,38,.12); color:#dc2626; }
.slider-row { display:flex; align-items:center; gap:10px; }
.slider-row input[type=range] { flex:1; accent-color:var(--acc); }
.slider-val { font-size:12px; color:var(--tx2); min-width:32px; text-align:right; }
/* COMMAND PALETTE */
.cmd-overlay { position:fixed; inset:0; background:rgba(0,0,0,.52); z-index:2000; display:none; align-items:flex-start; justify-content:center; padding-top:15vh; backdrop-filter:blur(5px); }
.cmd-overlay.open { display:flex; }
.cmd-box { background:var(--sur); border:1px solid var(--bd2); border-radius:12px; width:560px; max-width:92vw; box-shadow:0 24px 64px rgba(0,0,0,.35); overflow:hidden; }
.cmd-input-wrap { display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid var(--bd); }
.cmd-kbd { font-size:10px; font-family:var(--font-m); background:var(--bg3); color:var(--tx3); padding:2px 6px; border-radius:4px; white-space:nowrap; }
.cmd-input { flex:1; background:transparent; border:none; outline:none; font-size:14px; color:var(--tx); font-family:var(--font-b); }
.cmd-results { max-height:300px; overflow-y:auto; padding:6px; }
.cmd-item { padding:9px 12px; border-radius:6px; cursor:pointer; font-size:12px; color:var(--tx2); display:flex; align-items:center; gap:8px; }
.cmd-item:hover,.cmd-item.sel { background:var(--bg3); color:var(--tx); }
.cmd-item-icon { width:20px; font-size:13px; text-align:center; color:var(--tx4); }
/* CLOCK */
.top-clock { font-size:11px; color:var(--tx3); font-family:var(--font-m); letter-spacing:.04em; }
/* AGENT LOAD BAR IN SIDEBAR */
.agent-load { height:2px; background:var(--bg3); border-radius:1px; margin-top:4px; overflow:hidden; }
.agent-load-fill { height:100%; border-radius:1px; transition:width .3s; background:var(--acc); }
:root {
  /* Light / Day */
  --bg:        #f8f7fc;
  --bg2:       #f1f0f8;
  --bg3:       #e9e7f5;
  --sur:       #ffffff;
  --bd:        #e0ddf2;
  --bd2:       #c8c3e8;
  --tx:        #0a0914;
  --tx2:       #32305a;
  --tx3:       #6e6b9a;
  --tx4:       #a09dc0;
  --acc:       #6d28d9;
  --acc2:      #7c3aed;
  --acc3:      #a78bfa;
  --gold:      #c9a227;
  --gold2:     #e8b830;
  --gold-glow: rgba(201,162,39,.18);
  --glow:      rgba(109,40,217,.1);
  --glow2:     rgba(109,40,217,.2);
  --green:     #16a34a;
  --amber:     #d97706;
  --red:       #dc2626;
  --side-w:    228px;
  --panel-w:   264px;
  --top-h:     56px;
  --topbar-bg: rgba(255,255,255,0.88);
  --font-d:    'Syne', sans-serif;
  --font-b:    'Inter', sans-serif;
  --font-m:    'JetBrains Mono', monospace;
  /* ── AGENT CHAT THEME VARS (defaults — overridden per agent) ── */
  --chat-bg:           transparent;
  --chat-header-tint:  var(--sur);
  --chat-accent:       var(--acc);
  --chat-accent-rgb:   109, 40, 217;
  --chat-input-bg:     var(--sur);
}

[data-theme="dark"] {
  --bg:        #07060e;
  --bg2:       #0d0b1a;
  --bg3:       #131022;
  --sur:       #0d0b1a;
  --bd:        #1c1930;
  --bd2:       #2a264a;
  --tx:        #ede9ff;
  --tx2:       #b5aee8;
  --tx3:       #7470a0;
  --tx4:       #44416a;
  --acc:       #8b5cf6;
  --acc2:      #7c3aed;
  --acc3:      #c4b5fd;
  --gold:      #d4a843;
  --gold2:     #f0c050;
  --gold-glow: rgba(212,168,67,.2);
  --glow:      rgba(139,92,246,.15);
  --glow2:     rgba(139,92,246,.28);
  --topbar-bg: rgba(7,6,14,0.82);
  --chat-bg:           transparent;
  --chat-header-tint:  var(--sur);
  --chat-accent:       var(--acc);
  --chat-accent-rgb:   139, 92, 246;
  --chat-input-bg:     var(--sur);
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; background:var(--bg); color:var(--tx); font-family:var(--font-b); font-size:13px; font-feature-settings:'ss01'; overflow:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
::selection { background:var(--acc3); color:var(--bg); }

/* ── ANIMATED GRADIENT MESH (Layer 0) ── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background:
    radial-gradient(ellipse 60% 50% at 15% 20%, rgba(109,40,217,.13) 0%, transparent 60%),
    radial-gradient(ellipse 50% 60% at 85% 75%, rgba(139,92,246,.09) 0%, transparent 55%),
    radial-gradient(ellipse 40% 40% at 65% 10%, rgba(109,40,217,.07) 0%, transparent 50%);
  animation: meshDrift 24s ease-in-out infinite alternate;
}
[data-theme="dark"] body::before {
  background:
    radial-gradient(ellipse 60% 50% at 15% 20%, rgba(139,92,246,.18) 0%, transparent 60%),
    radial-gradient(ellipse 50% 60% at 85% 75%, rgba(109,40,217,.14) 0%, transparent 55%),
    radial-gradient(ellipse 40% 40% at 65% 10%, rgba(139,92,246,.10) 0%, transparent 50%);
}
@keyframes meshDrift {
  0%   { transform: scale(1) translate(0, 0); opacity: 1; }
  50%  { transform: scale(1.06) translate(-1%, 1.5%); opacity: .85; }
  100% { transform: scale(1.1) translate(1.5%, -1%); opacity: .9; }
}

/* Scrollbars */
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bd2); border-radius:2px; }

/* ── LAYOUT ── */
.layout {
  display: grid;
  grid-template-columns: var(--side-w) 1fr var(--panel-w);
  grid-template-rows: var(--top-h) 1fr;
  height: 100vh;
}

/* ── TOPBAR ── */
.topbar {
  grid-column: 1 / -1;
  background: var(--topbar-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--bd);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 22px;
  position: relative;
  z-index: 20;
}

/* Forge logomark - geometric anvil shape */
.logo-mark {
  width: 34px;
  height: 34px;
  flex-shrink: 0;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.top-center {
  display: flex;
  align-items: center;
  gap: 28px;
}

.stat {
  text-align: center;
}
.stat-val {
  font-family: var(--font-m);
  font-size: 13px;
  font-weight: 500;
  color: var(--acc);
  line-height: 1;
}
.stat-lbl {
  font-size: 9px;
  color: var(--tx4);
  text-transform: uppercase;
  letter-spacing: .1em;
  margin-top: 2px;
}

.top-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.top-btn {
  height: 30px;
  padding: 0 12px;
  border-radius: 6px;
  border: 1px solid var(--bd);
  background: var(--bg2);
  color: var(--tx3);
  font-family: var(--font-b);
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: all .18s;
}
.top-btn:hover { border-color: var(--bd2); color: var(--tx2); background: var(--bg3); }

.top-btn-p {
  background: var(--acc);
  color: #fff;
  border-color: var(--acc);
}
.top-btn-p:hover { background: var(--acc2); border-color: var(--acc2); color: #fff; }

.theme-toggle {
  width: 30px;
  height: 30px;
  border-radius: 6px;
  border: 1px solid var(--bd);
  background: var(--bg2);
  color: var(--tx3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .18s;
  font-size: 13px;
}
.theme-toggle:hover { border-color: var(--bd2); color: var(--acc); }

/* ── SIDEBAR (LEFT) ── */
.sidebar {
  background: var(--bg2);
  border-right: 1px solid var(--bd);
  overflow-y: auto;
  padding: 16px 0;
  display: flex;
  flex-direction: column;
}

.sidebar-section { margin-bottom: 6px; }

.sidebar-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: .07em;
  text-transform: uppercase;
  color: var(--tx4);
  padding: 10px 16px 5px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 9px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  color: var(--tx3);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  border-left: 2px solid transparent;
  transition: all .16s;
  font-family: var(--font-b);
  position: relative;
}
.sidebar-item:hover { color: var(--tx2); background: var(--bg3); }
.sidebar-item.active {
  color: var(--acc);
  border-left-color: var(--acc);
  background: linear-gradient(90deg, var(--glow) 0%, transparent 100%);
}

.sidebar-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  opacity: .7;
}
.sidebar-item.active .sidebar-icon { opacity: 1; }

.sidebar-badge {
  font-size: 9px;
  font-family: var(--font-m);
  color: var(--tx4);
  margin-left: auto;
  background: var(--bg);
  border: 1px solid var(--bd);
  padding: 1px 6px;
  border-radius: 3px;
}

.sidebar-div { height: 1px; background: var(--bd); margin: 8px 12px; }

.status-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--green);
  margin-left: auto;
  flex-shrink: 0;
  box-shadow: 0 0 5px rgba(22,163,74,.5);
}

/* Agent items */
.agent-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 16px;
  cursor: pointer;
  font-size: 11.5px;
  color: var(--tx3);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  border-left: 2px solid transparent;
  transition: all .16s;
  font-family: var(--font-b);
}
.agent-item:hover { color: var(--tx2); background: var(--bg3); }
.agent-item.active { color: var(--acc); border-left-color: var(--acc); background: linear-gradient(90deg,var(--glow),transparent); }
.agent-marker {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--acc3);
  flex-shrink: 0;
}
.agent-item.active .agent-marker { background: var(--acc); box-shadow: 0 0 6px var(--glow2); }
.agent-name { font-weight: 600; font-size: 11px; letter-spacing: .04em; }
.agent-role { font-size: 10px; color: var(--tx4); margin-top: 1px; }

/* ── MAIN CONTENT ── */
.main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
  background: transparent;
  position: relative;
  z-index: 1;
}

/* Views */
.view { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.view.visible { display: flex; }

/* ── VIEW HEADER ── */
.view-head {
  padding: 14px 22px;
  border-bottom: 1px solid var(--bd);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  background: var(--sur);
}
.view-title {
  font-family: var(--font-d);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: .06em;
  color: var(--tx);
}
.view-sub {
  font-size: 10px;
  color: var(--tx4);
  margin-top: 2px;
  font-family: var(--font-m);
}

.model-selector {
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 6px 10px;
  border-radius: 6px;
  font-family: var(--font-m);
  font-size: 10.5px;
  cursor: pointer;
  appearance: none;
  outline: none;
}
.model-selector:focus { border-color: var(--acc); }

/* ── CHAT ── */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  background: var(--chat-bg);
  transition: background 0.4s ease;
}

.msg {
  display: flex;
  gap: 11px;
  max-width: 78%;
  animation: msgIn .22s ease;
}
@keyframes msgIn {
  from { opacity:0; transform:translateY(6px); }
  to   { opacity:1; transform:none; }
}

.msg.from-user { align-self: flex-end; flex-direction: row-reverse; }

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  font-family: var(--font-d);
  letter-spacing: .06em;
}
.msg-avatar.forge-av {
  background: var(--acc);
  color: #fff;
  /* Forge logomark in avatar */
}
.msg-avatar.user-av {
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx3);
}

.msg-body { display: flex; flex-direction: column; gap: 4px; }

.msg-bubble {
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  line-height: 1.65;
  white-space: pre-wrap;
  word-break: break-word;
  background: var(--sur);
  border: 1px solid var(--bd);
  color: var(--tx);
}

.from-user .msg-bubble {
  background: var(--acc);
  color: #fff;
  border-color: var(--acc);
}

.msg-time {
  font-size: 9.5px;
  color: var(--tx4);
  font-family: var(--font-m);
}
.from-user .msg-time { text-align: right; }

/* Typing indicator */
.typing-dots {
  display: flex;
  gap: 3px;
  align-items: center;
  padding: 4px 0;
}
.typing-dots span {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--acc);
  animation: tdot .7s infinite;
}
.typing-dots span:nth-child(2) { animation-delay: .15s; }
.typing-dots span:nth-child(3) { animation-delay: .3s; }
@keyframes tdot {
  0%,80%,100% { opacity:.2; transform:scale(.7); }
  40%          { opacity:1;  transform:scale(1); }
}

/* Empty state */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--tx4);
  gap: 8px;
  padding: 40px;
}
.empty-logo { margin-bottom: 8px; opacity: .5; }
.empty-title { font-family: var(--font-d); font-size: 16px; font-weight: 700; color: var(--tx3); letter-spacing: .03em; }
.empty-sub { font-size: 12px; text-align: center; line-height: 1.7; max-width: 280px; }

/* ── INPUT ── */
.input-area {
  padding: 14px 22px;
  border-top: 1px solid var(--bd);
  display: flex;
  gap: 8px;
  align-items: flex-end;
  flex-shrink: 0;
  background: var(--sur);
}

.input-field {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 10px 14px;
  border-radius: 8px;
  font-family: var(--font-b);
  font-size: 13px;
  resize: none;
  min-height: 40px;
  max-height: 120px;
  line-height: 1.5;
  transition: border-color .18s;
}
.input-field::placeholder { color: var(--tx4); }
.input-field:focus { outline: none; border-color: var(--acc); }

.send-btn {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  border: none;
  background: var(--acc);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .18s;
  flex-shrink: 0;
}
.send-btn:hover { background: var(--acc2); transform: translateY(-1px); }
.send-btn:active { transform: none; }

/* ── CHAT VIEW: agent-themed header + input ── */
#view-chat .view-head {
  background: var(--chat-header-tint);
  transition: background 0.4s ease;
}
#view-chat .view-head .view-title {
  color: var(--chat-accent);
  transition: color 0.4s ease;
}
#view-chat .view-head .view-sub {
  color: var(--chat-accent);
  opacity: 0.55;
  transition: color 0.4s ease;
}
#view-chat .input-area {
  background: var(--chat-input-bg);
  transition: background 0.4s ease;
}
#view-chat .input-field:focus {
  border-color: var(--chat-accent);
}
#view-chat .send-btn {
  background: var(--chat-accent);
  transition: background 0.4s ease, transform 0.18s;
}
#view-chat .send-btn:hover {
  background: var(--chat-accent);
  filter: brightness(1.15);
}
#view-chat .from-user .msg-bubble {
  background: var(--chat-accent);
  border-color: var(--chat-accent);
}
#view-chat .empty-title {
  color: var(--chat-accent);
  transition: color 0.4s ease;
}
#view-chat .empty-logo rect {
  fill: rgba(var(--chat-accent-rgb), 0.15);
}
#view-chat .empty-logo path {
  fill: rgba(var(--chat-accent-rgb), 0.7);
}

/* ══════════════════════════════════════════
   AGENT CHAT THEMES
   Light: faint tint (5-8% opacity bg)
   Dark:  deeper tint (12-18%)
══════════════════════════════════════════ */

/* FORGE — default purple (explicit, matches baseline) */
#view-chat[data-agent="FORGE"] {
  --chat-accent:      #6d28d9;
  --chat-accent-rgb:  109, 40, 217;
  --chat-bg:          transparent;
  --chat-header-tint: var(--sur);
  --chat-input-bg:    var(--sur);
}
[data-theme="dark"] #view-chat[data-agent="FORGE"] {
  --chat-accent:      #8b5cf6;
  --chat-accent-rgb:  139, 92, 246;
}

/* VISHVAKARMA — CTO / Engineering / Teal */
#view-chat[data-agent="vishvakarma"] {
  --chat-accent:      #0d9488;
  --chat-accent-rgb:  13, 148, 136;
  --chat-bg:          rgba(13, 148, 136, 0.04);
  --chat-header-tint: rgba(13, 148, 136, 0.06);
  --chat-input-bg:    rgba(13, 148, 136, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="vishvakarma"] {
  --chat-accent:      #14b8a6;
  --chat-accent-rgb:  20, 184, 166;
  --chat-bg:          rgba(20, 184, 166, 0.07);
  --chat-header-tint: rgba(20, 184, 166, 0.09);
  --chat-input-bg:    rgba(20, 184, 166, 0.05);
}

/* SOPHIA — CMO / Creative / Rose */
#view-chat[data-agent="sophia"] {
  --chat-accent:      #e11d48;
  --chat-accent-rgb:  225, 29, 72;
  --chat-bg:          rgba(225, 29, 72, 0.04);
  --chat-header-tint: rgba(225, 29, 72, 0.06);
  --chat-input-bg:    rgba(225, 29, 72, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="sophia"] {
  --chat-accent:      #f43f5e;
  --chat-accent-rgb:  244, 63, 94;
  --chat-bg:          rgba(244, 63, 94, 0.07);
  --chat-header-tint: rgba(244, 63, 94, 0.09);
  --chat-input-bg:    rgba(244, 63, 94, 0.05);
}

/* LAKSHMI — CFO / Wealth / Deep Gold */
#view-chat[data-agent="lakshmi"] {
  --chat-accent:      #c9a227;
  --chat-accent-rgb:  201, 162, 39;
  --chat-bg:          rgba(201, 162, 39, 0.05);
  --chat-header-tint: rgba(201, 162, 39, 0.07);
  --chat-input-bg:    rgba(201, 162, 39, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="lakshmi"] {
  --chat-accent:      #f0c040;
  --chat-accent-rgb:  240, 192, 64;
  --chat-bg:          rgba(240, 192, 64, 0.07);
  --chat-header-tint: rgba(240, 192, 64, 0.09);
  --chat-input-bg:    rgba(240, 192, 64, 0.05);
}

/* ATHENA — Research / Intel / Indigo */
#view-chat[data-agent="athena"] {
  --chat-accent:      #4338ca;
  --chat-accent-rgb:  67, 56, 202;
  --chat-bg:          rgba(67, 56, 202, 0.04);
  --chat-header-tint: rgba(67, 56, 202, 0.06);
  --chat-input-bg:    rgba(67, 56, 202, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="athena"] {
  --chat-accent:      #818cf8;
  --chat-accent-rgb:  129, 140, 248;
  --chat-bg:          rgba(129, 140, 248, 0.07);
  --chat-header-tint: rgba(129, 140, 248, 0.09);
  --chat-input-bg:    rgba(129, 140, 248, 0.05);
}

/* HERMES — Sales / Momentum / Vivid Orange */
#view-chat[data-agent="hermes"] {
  --chat-accent:      #ea580c;
  --chat-accent-rgb:  234, 88, 12;
  --chat-bg:          rgba(234, 88, 12, 0.04);
  --chat-header-tint: rgba(234, 88, 12, 0.06);
  --chat-input-bg:    rgba(234, 88, 12, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="hermes"] {
  --chat-accent:      #f97316;
  --chat-accent-rgb:  249, 115, 22;
  --chat-bg:          rgba(249, 115, 22, 0.07);
  --chat-header-tint: rgba(249, 115, 22, 0.09);
  --chat-input-bg:    rgba(249, 115, 22, 0.05);
}

/* PROMETHEUS — Revenue / Fire / Crimson */
#view-chat[data-agent="prometheus"] {
  --chat-accent:      #b91c1c;
  --chat-accent-rgb:  185, 28, 28;
  --chat-bg:          rgba(185, 28, 28, 0.04);
  --chat-header-tint: rgba(185, 28, 28, 0.06);
  --chat-input-bg:    rgba(185, 28, 28, 0.03);
}
[data-theme="dark"] #view-chat[data-agent="prometheus"] {
  --chat-accent:      #ef4444;
  --chat-accent-rgb:  239, 68, 68;
  --chat-bg:          rgba(239, 68, 68, 0.07);
  --chat-header-tint: rgba(239, 68, 68, 0.09);
  --chat-input-bg:    rgba(239, 68, 68, 0.05);
}

/* Send icon SVG */
.send-icon { width:15px; height:15px; }

/* ── PANEL (RIGHT) ── */
.panel {
  background: var(--bg2);
  border-left: 1px solid var(--bd);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Panel sections */
.panel-section {
  border-bottom: 1px solid var(--bd);
  padding: 16px;
}
.panel-section:last-child { border-bottom: none; }

.panel-title {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx4);
  margin-bottom: 12px;
}

/* Status metrics */
.metric-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 7px;
}
.metric-key { font-size: 11px; color: var(--tx3); }
.metric-val { font-family: var(--font-m); font-size: 12px; color: var(--tx2); font-weight: 500; }

/* Heartbeat */
.hb-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.hb-key { font-size: 11px; color: var(--tx3); }
.toggle {
  width: 34px;
  height: 19px;
  border-radius: 10px;
  background: var(--bd2);
  position: relative;
  cursor: pointer;
  transition: background .2s;
  border: none;
  flex-shrink: 0;
}
.toggle.on { background: var(--acc); }
.toggle::after {
  content: '';
  position: absolute;
  width: 13px; height: 13px;
  border-radius: 50%;
  background: #fff;
  top: 3px; left: 3px;
  transition: transform .2s;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
.toggle.on::after { transform: translateX(15px); }

/* Panel nav items */
.panel-nav {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.panel-nav-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11.5px;
  color: var(--tx3);
  transition: all .16s;
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  font-family: var(--font-b);
}
.panel-nav-item:hover { background: var(--bg3); color: var(--tx2); }
.panel-nav-chevron { font-size: 10px; color: var(--tx4); }

/* ── SETTINGS REBUILD ── */
.settings-layout {
  display: grid;
  grid-template-columns: 196px 1fr;
  height: 100%;
  overflow: hidden;
}
.settings-sidenav {
  border-right: 1px solid var(--bd);
  padding: 20px 0;
  background: var(--bg2);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.settings-sidenav-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--tx4);
  padding: 0 16px 10px;
}
.settings-tab {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  text-align: left;
  padding: 9px 14px 9px 16px;
  font-size: 12px;
  font-weight: 500;
  color: var(--tx3);
  background: none;
  border: none;
  border-radius: 0;
  cursor: pointer;
  font-family: var(--font-b);
  transition: all 0.15s;
  letter-spacing: 0.01em;
  position: relative;
}
.settings-tab:hover { color: var(--tx2); background: var(--bg3); }
.settings-tab.active {
  color: var(--acc);
  background: linear-gradient(90deg, var(--glow2) 0%, var(--glow) 100%);
  font-weight: 700;
  border-left: 2px solid var(--acc);
}
.settings-tab.active .stab-nav-icon { opacity: 1; color: var(--acc); }
.stab-nav-icon {
  width: 15px;
  height: 15px;
  flex-shrink: 0;
  opacity: 0.55;
  color: var(--tx3);
  transition: opacity 0.15s;
}
.settings-tab:hover .stab-nav-icon { opacity: 0.85; }
.settings-content {
  overflow-y: auto;
  padding: 32px;
  background: var(--bg);
}
.stab-hero {
  margin-bottom: 28px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}
.stab-hero-text .stab-title {
  font-family: var(--font-b);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.03em;
  color: var(--tx);
  margin-bottom: 4px;
}
.stab-hero-text .stab-sub {
  font-size: 11px;
  color: var(--tx4);
  font-family: var(--font-m);
  margin-bottom: 0;
}
.stab-last-saved {
  font-size: 9.5px;
  font-family: var(--font-m);
  color: var(--tx4);
  background: var(--bg2);
  border: 1px solid var(--bd);
  padding: 3px 10px;
  border-radius: 20px;
  white-space: nowrap;
  flex-shrink: 0;
  margin-top: 2px;
}
.stab-pane { display: none; }
.stab-pane.visible { display: block; }
.stab-group {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.stab-group-title {
  padding: 12px 18px;
  border-bottom: 1px solid var(--bd);
  font-size: 10px;
  font-weight: 700;
  color: var(--tx3);
  background: var(--bg2);
  font-family: var(--font-b);
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

/* Premium profile card */
.profile-hero-row {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 24px;
  background: linear-gradient(135deg, var(--bg2) 0%, var(--sur) 100%);
  border: 1px solid var(--bd);
  border-radius: 14px;
  margin-bottom: 24px;
  box-shadow: var(--sh2);
}
.profile-avatar {
  width: 60px; height: 60px;
  border-radius: 16px;
  background: var(--acc-gradient);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-d);
  font-size: 22px;
  font-weight: 800;
  color: #fff;
  flex-shrink: 0;
  box-shadow: 0 4px 16px var(--glow2), inset 0 1px 0 rgba(255,255,255,.2);
  letter-spacing: 0.02em;
}
.profile-name {
  font-family: var(--font-b);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0;
  color: var(--tx);
}
.profile-workspace { font-size: 11px; color: var(--tx3); margin-top: 2px; }
.workspace-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-family: var(--font-m);
  font-size: 8.5px;
  font-weight: 700;
  letter-spacing: .12em;
  color: var(--green);
  background: rgba(22,163,74,.1);
  border: 1px solid rgba(22,163,74,.2);
  padding: 3px 8px;
  border-radius: 4px;
  margin-top: 6px;
}

/* AI Model selection cards */
.model-cards-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  padding: 16px 18px;
}
.agent-detail-card { background:var(--sur); border:1px solid var(--bd); border-radius:12px; padding:18px; transition:all .2s; }
.agent-detail-card:hover { border-color:var(--bd2); box-shadow:var(--sh2); }
.agent-detail-header { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
.agent-detail-avatar { width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:800; color:#fff; flex-shrink:0; }
.agent-detail-name { font-size:14px; font-weight:700; color:var(--tx); font-family:var(--font-d); }
.agent-detail-role { font-size:11px; color:var(--tx4); margin-top:2px; }
.agent-model-row { display:flex; align-items:center; gap:8px; margin-top:12px; }
.agent-model-select { flex:1; font-size:11px; padding:6px 10px; border-radius:7px; border:1px solid var(--bd); background:var(--bg2); color:var(--tx); font-family:var(--font-m); cursor:pointer; }
.agent-model-save { font-size:10px; padding:6px 12px; border-radius:7px; border:none; background:var(--acc); color:#fff; font-weight:700; cursor:pointer; font-family:var(--font-m); }
.agent-model-save:hover { opacity:.85; }

.model-card {
  border: 1.5px solid var(--bd);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: var(--transition-smooth);
  background: var(--bg2);
  position: relative;
  overflow: hidden;
}
.model-card:hover { border-color: var(--bd2); box-shadow: var(--sh2); }
.model-card.selected {
  border-color: var(--acc);
  background: linear-gradient(135deg, var(--glow2) 0%, var(--bg2) 100%);
  box-shadow: 0 0 0 1px var(--acc), var(--sh2);
}
.model-card-check {
  position: absolute; top: 10px; right: 10px;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--acc-gradient);
  display: none;
  align-items: center; justify-content: center;
}
.model-card.selected .model-card-check { display: flex; }
.model-card-name {
  font-family: var(--font-d);
  font-size: 13px;
  font-weight: 700;
  color: var(--tx);
  margin-bottom: 4px;
  letter-spacing: 0.04em;
}
.model-card-desc { font-size: 10px; color: var(--tx4); line-height: 1.5; margin-bottom: 10px; }
.model-card-badges { display: flex; flex-wrap: wrap; gap: 4px; }
.model-badge {
  font-size: 8.5px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 4px;
  font-family: var(--font-m);
  letter-spacing: .04em;
}
.mb-fast    { background: rgba(59,130,246,.12); color: #3b82f6; }
.mb-balance { background: rgba(109,40,217,.12); color: #7c3aed; }
.mb-smart   { background: rgba(22,163,74,.12);  color: #16a34a; }
.badge-gold { background: rgba(201,162,39,.15); color: var(--gold); }

/* System tab stat cards */
.sys-stat-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  padding: 16px 18px;
}
.sys-stat-card {
  background: var(--bg2);
  border: 1px solid var(--bd);
  border-radius: 10px;
  padding: 16px;
}
.sys-stat-card-val {
  font-family: var(--font-m);
  font-size: 18px;
  font-weight: 700;
  color: var(--tx);
  background: var(--acc-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.sys-stat-card-lbl { font-size: 10px; color: var(--tx4); margin-top: 4px; letter-spacing: .05em; text-transform: uppercase; }
.sys-status-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 18px;
  border-bottom: 1px solid var(--bd);
}
.sys-status-row:last-child { border-bottom: none; }
.sys-status-key { font-size: 12px; color: var(--tx2); font-weight: 500; }
.sys-status-val { font-size: 11px; color: var(--tx3); font-family: var(--font-m); }
.sys-status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

.stab-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 1px solid var(--bd);
  gap: 20px;
}
.stab-row:last-child { border-bottom: none; }
.stab-row-key { font-size: 12.5px; color: var(--tx2); font-weight: 500; }
.stab-row-desc { font-size: 10px; color: var(--tx4); margin-top: 2px; }
.stab-input {
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-family: var(--font-m);
  min-width: 180px;
  transition: border-color 0.18s, box-shadow 0.18s;
  flex-shrink: 0;
}
.stab-input:focus {
  outline: none;
  border-color: var(--acc);
  box-shadow: 0 0 0 3px var(--glow);
}
/* Danger zone */
.danger-zone {
  border: 1px solid rgba(220,38,38,0.25);
  border-radius: 12px; overflow: hidden; margin-top: 24px;
}
.danger-zone-title {
  padding: 12px 18px; background: rgba(220,38,38,0.06);
  border-bottom: 1px solid rgba(220,38,38,0.15);
  font-size: 10px; font-weight: 700; color: var(--red);
  font-family: var(--font-d); letter-spacing: 0.10em; text-transform: uppercase;
}
.danger-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; border-bottom: 1px solid rgba(220,38,38,0.1);
  gap: 16px;
}
.danger-row:last-child { border-bottom: none; }
.btn-danger {
  height: 30px; padding: 0 14px; border-radius: 7px;
  border: 1px solid rgba(220,38,38,0.3);
  background: rgba(220,38,38,0.06); color: var(--red);
  font-family: var(--font-b); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.18s; flex-shrink: 0;
}
.btn-danger:hover {
  background: rgba(220,38,38,0.12);
  border-color: var(--red);
  box-shadow: 0 2px 8px rgba(220,38,38,0.2);
}
/* Model card upgrades */
.model-cards { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; padding: 16px 18px; }
.model-card {
  border: 1.5px solid var(--bd); border-radius: 10px; padding: 14px;
  cursor: pointer; transition: all 0.18s; background: var(--bg2); position: relative;
}
.model-card:hover { border-color: var(--bd2); transform: translateY(-1px); box-shadow: 0 4px 14px var(--glow); }
.model-card.selected { border-color: var(--acc); background: var(--glow); box-shadow: 0 0 0 1px var(--acc), 0 4px 14px var(--glow2); }
.model-card-name { font-size: 12px; font-weight: 700; color: var(--tx); font-family: var(--font-d); letter-spacing: 0.04em; margin-bottom: 3px; }
.model-card-provider { font-size: 9px; color: var(--tx4); font-family: var(--font-m); margin-bottom: 10px; }
.model-card-badge { position: absolute; top: 8px; right: 8px; font-size: 8px; padding: 1px 5px; border-radius: 3px; font-family: var(--font-m); font-weight: 700; }
.model-card-meta { display: flex; flex-direction: column; gap: 4px; }
.model-meta-row { display: flex; align-items: center; justify-content: space-between; }
.model-meta-key { font-size: 9px; color: var(--tx4); }
.model-meta-val { font-size: 9px; font-family: var(--font-m); color: var(--tx3); }
.model-speed-bar { height: 2px; background: var(--bg3); border-radius: 1px; margin-top: 6px; overflow: hidden; }
.model-speed-fill { height: 100%; border-radius: 1px; background: var(--acc); }
/* Heartbeat timeline */
.hb-timeline {
  display: flex; gap: 5px; align-items: center;
  padding: 14px 18px; flex-wrap: wrap;
}
.hb-timeline-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  transition: transform 0.15s;
}
.hb-timeline-dot:hover { transform: scale(1.4); }
.hb-timeline-dot.ok    { background: var(--green); box-shadow: 0 0 4px rgba(22,163,74,0.4); }
.hb-timeline-dot.warn  { background: var(--amber); box-shadow: 0 0 4px rgba(217,119,6,0.4); }
.hb-timeline-dot.error { background: var(--red);   box-shadow: 0 0 4px rgba(220,38,38,0.4); }
.hb-timeline-dot.empty { background: var(--bg3); }
.hb-countdown { font-family: var(--font-m); font-size: 11px; color: var(--acc); font-weight: 600; }
/* Heartbeat chart view */
.hb-chart-wrap {
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.hb-stat-cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.hb-stat-card {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 12px;
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.hb-stat-val {
  font-family: var(--font-m);
  font-size: 28px;
  font-weight: 700;
  color: var(--tx);
  letter-spacing: -0.5px;
}
.hb-stat-val.green { color: var(--green); }
.hb-stat-val.amber { color: var(--amber); }
.hb-stat-lbl {
  font-size: 11px;
  color: var(--tx2);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.hb-chart-card {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 12px;
  padding: 18px 20px;
}
.hb-chart-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--tx2);
  margin-bottom: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.hb-svg-chart {
  width: 100%;
  height: 120px;
  display: block;
  overflow: visible;
}
.hb-chart-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.hb-chart-legend {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--tx2);
}
.hb-chart-legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}
.hb-recent-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 4px;
}
.hb-recent-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--bg2);
  font-size: 12px;
}
.hb-recent-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: var(--tx);
}
.hb-recent-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
}
.hb-recent-time { font-size: 11px; color: var(--tx2); }
/* Saved toast */
.saved-toast {
  position: fixed; bottom: 24px; right: 24px;
  background: var(--sur); border: 1px solid var(--bd);
  border-radius: 10px; padding: 10px 16px;
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; font-weight: 500; color: var(--tx);
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  z-index: 500; opacity: 0; transform: translateY(8px);
  transition: all 0.2s; pointer-events: none;
}
.saved-toast.show { opacity: 1; transform: translateY(0); }
.saved-toast-icon { color: var(--green); font-size: 14px; }

/* ── PARALLEL VIEW — MISSION TERMINAL ── */
.parallel-layout {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}
.parallel-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  padding: 20px;
  overflow-y: auto;
  flex: 1;
}
.ptc-card {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--sh2);
  transition: var(--transition-smooth);
}
.ptc-card:hover { box-shadow: var(--sh3); border-color: var(--bd2); }
.ptc-card.running { border-color: var(--acc); box-shadow: 0 0 0 1px var(--acc), var(--sh3); }
.ptc-card.done    { border-color: var(--green); box-shadow: 0 0 0 1px var(--green), var(--sh2); }
/* macOS-style title bar */
.ptc-titlebar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 14px;
  background: var(--bg2);
  border-bottom: 1px solid var(--bd);
  user-select: none;
}
.ptc-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.ptc-dot-r { background: #ff5f57; }
.ptc-dot-y { background: #febc2e; }
.ptc-dot-g { background: #28c840; }
.ptc-agent-label {
  font-size: 11px;
  font-family: var(--font-m);
  font-weight: 600;
  color: var(--tx2);
  letter-spacing: .06em;
  margin-left: 4px;
  flex: 1;
}
.ptc-status-line {
  font-size: 9.5px;
  font-family: var(--font-m);
  color: var(--tx4);
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 5px;
}
.ptc-status-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--tx4);
  flex-shrink: 0;
}
.ptc-status-dot.idle    { background: var(--tx4); }
.ptc-status-dot.running { background: var(--acc); box-shadow: 0 0 5px var(--glow2); animation: mcpulse 1s infinite; }
.ptc-status-dot.done    { background: var(--green); }
.ptc-status-dot.error   { background: var(--red); }
.ptc-body { padding: 14px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
.ptc-input {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 10px 12px;
  border-radius: 8px;
  font-family: var(--font-m);
  font-size: 11.5px;
  resize: vertical;
  min-height: 72px;
  transition: border-color .18s;
  line-height: 1.6;
}
.ptc-input:focus { outline: none; border-color: var(--acc); box-shadow: 0 0 0 3px var(--glow); }
.ptc-input::placeholder { color: var(--tx4); }
.ptc-meta-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.ptc-token-est {
  font-size: 9.5px;
  color: var(--tx4);
  font-family: var(--font-m);
  display: flex;
  align-items: center;
  gap: 4px;
}
.ptc-response {
  background: var(--bg2);
  border: 1px solid var(--bd);
  border-radius: 8px;
  padding: 10px 12px;
  font-family: var(--font-m);
  font-size: 11px;
  color: var(--tx2);
  min-height: 48px;
  line-height: 1.65;
  white-space: pre-wrap;
  word-break: break-word;
  display: none;
  animation: viewEnter 0.2s ease both;
}
.ptc-response.has-content { display: block; }
.ptc-response-running { color: var(--acc3); }
/* Dispatch progress */
.parallel-progress {
  padding: 10px 20px;
  border-top: 1px solid var(--bd);
  background: var(--bg2);
  display: none;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}
.parallel-progress.visible { display: flex; }
.parallel-prog-bar { flex: 1; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
.parallel-prog-fill { height: 100%; background: var(--acc-gradient); border-radius: 2px; transition: width 0.4s ease; }
.parallel-prog-label { font-size: 10px; color: var(--tx3); font-family: var(--font-m); white-space: nowrap; }
/* Footer dispatch bar */
.parallel-bar {
  padding: 14px 20px;
  border-top: 1px solid var(--bd);
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  background: var(--sur);
  align-items: center;
}
.parallel-bar-left { font-size: 10px; color: var(--tx4); font-family: var(--font-m); flex: 1; }

/* ── SPAWN MODAL ── */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s;
}
.overlay.open { opacity: 1; pointer-events: all; }

.modal { transform-origin: center bottom; }
.overlay .modal { transform: scale(0.92) translateY(24px); opacity:0; transition: transform .28s cubic-bezier(.34,1.56,.64,1), opacity .2s ease; }
.overlay.open .modal { transform: scale(1) translateY(0); opacity:1; }

.modal {
  background: var(--sur);
  border: 1px solid var(--bd2);
  border-radius: 14px;
  padding: 28px;
  width: 400px;
  max-width: 94vw;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
}
.modal-title {
  font-family: var(--font-d);
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 4px;
  letter-spacing: .04em;
}
.modal-sub { font-size: 11px; color: var(--tx4); margin-bottom: 22px; }
.field { margin-bottom: 14px; }
.field label {
  font-size: 9.5px;
  font-weight: 600;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--tx3);
  display: block;
  margin-bottom: 6px;
}
.field input, .field select, .field textarea {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 9px 12px;
  border-radius: 7px;
  font-family: var(--font-b);
  font-size: 12.5px;
  transition: border-color .18s;
  box-sizing: border-box;
}
.field textarea { resize: vertical; min-height: 60px; }
.field input:focus, .field select:focus, .field textarea:focus { outline: none; border-color: var(--acc); }
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

/* ── BUTTONS ── */
.btn {
  height: 32px;
  padding: 0 14px;
  border-radius: 7px;
  border: none;
  font-family: var(--font-b);
  font-size: 11.5px;
  font-weight: 600;
  cursor: pointer;
  transition: all .18s;
}
.btn-primary { background: var(--acc); color: #fff; }
.btn-primary:hover { background: var(--acc2); }
.btn-ghost { background: var(--bg2); color: var(--tx3); border: 1px solid var(--bd); }
.btn-ghost:hover { border-color: var(--bd2); color: var(--tx2); }

/* ── STATUS BADGE ── */
.badge {
  font-size: 9px;
  padding: 2px 7px;
  border-radius: 3px;
  font-family: var(--font-m);
  font-weight: 600;
}
.badge-ok      { background: rgba(22,163,74,.1);  color: var(--green); }
.badge-warn    { background: rgba(217,119,6,.1);  color: var(--amber); }
.badge-error   { background: rgba(220,38,38,.1);  color: var(--red); }
.badge-pending { background: var(--bg3); color: var(--tx4); }

/* ── HEARTBEAT VIEW ── */
.hb-list { padding: 20px; overflow-y: auto; }
.hb-item {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 8px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.hb-time { font-family: var(--font-m); font-size: 10px; color: var(--tx4); }
.hb-notes { font-size: 11px; color: var(--tx3); margin-top: 3px; }

/* ── MEMORY VIEW — PREMIUM ── */
.mem-stats-bar {
  display: flex;
  gap: 0;
  padding: 0;
  margin-bottom: 0;
  border-bottom: 1px solid var(--bd);
  background: var(--bg2);
  flex-shrink: 0;
}
.mem-stat-cell {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 14px 20px;
  border-right: 1px solid var(--bd);
  min-width: 120px;
}
.mem-stat-cell:last-child { border-right: none; margin-left: auto; flex-direction: row; align-items: center; gap: 8px; }
.mem-stat-val {
  font-family: var(--font-m);
  font-size: 20px;
  font-weight: 700;
  color: var(--tx);
  line-height: 1;
  background: var(--acc-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.mem-stat-lbl {
  font-size: 9px;
  font-weight: 600;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--tx4);
  margin-top: 4px;
}
.mem-toolbar {
  padding: 14px 24px;
  border-bottom: 1px solid var(--bd);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  background: var(--bg);
}
.mem-search-wrap {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg2);
  border: 1px solid var(--bd);
  border-radius: 8px;
  padding: 7px 12px;
  transition: var(--transition-smooth);
}
.mem-search-wrap:focus-within {
  border-color: var(--acc);
  box-shadow: 0 0 0 3px var(--glow);
}
.mem-search {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  font-size: 12px;
  color: var(--tx);
  font-family: var(--font-b);
}
.mem-search::placeholder { color: var(--tx4); }
.mem-filters { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.mem-chip {
  font-size: 10px; font-weight: 600;
  padding: 4px 11px;
  border-radius: 20px;
  border: 1px solid var(--bd);
  background: var(--bg2);
  color: var(--tx3);
  cursor: pointer;
  transition: var(--transition-smooth);
  font-family: var(--font-b);
  letter-spacing: 0.02em;
  white-space: nowrap;
}
.mem-chip:hover { border-color: var(--acc); color: var(--acc); }
.mem-chip.active { background: var(--acc); border-color: var(--acc); color: #fff; box-shadow: 0 2px 8px var(--glow2); }
.memory-list {
  display: flex;
  flex-direction: column;
  gap: 0;
  padding: 0;
  overflow-y: auto;
  align-content: start;
}
.memory-item {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--bd);
  padding: 14px 24px;
  cursor: default;
  transition: background .15s;
  position: relative;
  display: flex;
  align-items: flex-start;
  gap: 14px;
}
.memory-item:last-child { border-bottom: none; }
[data-theme="dark"] .memory-item { background: transparent; }
.memory-item::before { display: none; }
.memory-item:hover { background: var(--bg2); }
.memory-cat-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.memory-icon-col {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: var(--bg3);
  border: 1px solid var(--bd);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
  font-size: 13px;
}
.memory-content-col { flex: 1; min-width: 0; }
.memory-ts {
  font-size: 9px;
  color: var(--tx4);
  font-family: var(--font-m);
  margin-top: 6px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.memory-ts::before {
  content: '';
  display: inline-block;
  width: 4px; height: 4px;
  border-radius: 50%;
  background: var(--bd2);
}
.memory-cat {
  font-family: var(--font-m);
  font-size: 9px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: .1em;
}
/* Category color palette */
.mc-synfiction  { background: rgba(109,40,217,.12); color: #7c3aed; }
.mc-code        { background: rgba(22,163,74,.12);  color: #16a34a; }
.mc-system      { background: rgba(217,119,6,.12);  color: #d97706; }
.mc-user        { background: rgba(59,130,246,.12); color: #3b82f6; }
.mc-forge       { background: rgba(201,162,39,.12); color: var(--gold); }
.mc-general     { background: rgba(107,114,128,.12);color: #6b7280; }
.mc-default     { background: var(--bg3); color: var(--tx4); }
.memory-text { font-size: 12px; color: var(--tx2); line-height: 1.6; }

/* Misc */
.no-data { padding: 40px; text-align: center; color: var(--tx4); font-size: 12px; }

/* ── PREMIUM TOPBAR BRAND ── */
.brand-name {
  font-family: var(--font-d);
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.06em;
  color: var(--tx);
  text-transform: uppercase;
  transition: background 0.2s, -webkit-text-fill-color 0.2s;
}
.brand-name span.brand-dot {
  color: var(--gold);
}
.brand-name:hover {
  background: linear-gradient(90deg, var(--acc) 0%, var(--gold) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.brand-v2 {
  font-family: var(--font-m);
  font-size: 8px;
  color: var(--tx4);
  background: var(--bg3);
  border: 1px solid var(--bd);
  padding: 1px 5px;
  border-radius: 3px;
  margin-left: 2px;
  letter-spacing: 0.04em;
  display: none;
}
[data-theme="dark"] .brand-v2 { display: inline; }

/* Model card badge colors */
.mb-fast    { background: rgba(22,163,74,.12); color: var(--green); }
.mb-smart   { background: rgba(109,40,217,.12); color: var(--acc); }
.mb-balance { background: rgba(217,119,6,.12);  color: var(--amber); }

/* Appearance theme preview */
.theme-preview-row {
  display: flex;
  gap: 12px;
  padding: 16px 18px;
}
.theme-prev {
  flex: 1;
  border: 1.5px solid var(--bd);
  border-radius: 10px;
  padding: 14px;
  cursor: pointer;
  transition: all .18s;
  background: var(--bg2);
  text-align: center;
}
.theme-prev:hover { border-color: var(--bd2); }
.theme-prev.selected { border-color: var(--acc); box-shadow: 0 0 0 1px var(--acc); }
.theme-prev-swatch {
  width: 100%;
  height: 44px;
  border-radius: 6px;
  margin-bottom: 8px;
}
.theme-prev-label { font-size: 11px; font-weight: 600; color: var(--tx2); }

/* Usage stats */
.usage-stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 18px;
  border-bottom: 1px solid var(--bd);
}
.usage-stat-row:last-child { border-bottom: none; }
.usage-bar-wrap { width: 120px; }
.usage-bar { height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
.usage-bar-fill { height: 100%; border-radius: 2px; background: var(--acc); }
.usage-pct { font-size: 10px; font-family: var(--font-m); color: var(--tx3); margin-top: 3px; text-align: right; }

/* ── CHANNELS VIEW — PREMIUM COMMAND CENTER ── */
.ch-layout {
  display: grid;
  grid-template-columns: 220px 1fr;
  height: 100%;
  overflow: hidden;
}
.ch-rail {
  border-right: 1px solid var(--bd);
  background: var(--bg2);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 16px 0;
}
.ch-rail-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: .07em;
  text-transform: uppercase;
  color: var(--tx4);
  padding: 0 16px 10px;
}
.ch-rail-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  transition: var(--transition-smooth);
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  border-left: 2px solid transparent;
  font-family: var(--font-b);
}
.ch-rail-item:hover { background: var(--bg3); }
.ch-rail-item.active {
  border-left-color: var(--acc);
  background: linear-gradient(90deg, var(--glow2) 0%, transparent 100%);
}
.ch-rail-icon {
  width: 32px; height: 32px;
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}
.ch-icon-tg { background: rgba(0,136,204,.12); }
.ch-icon-dc { background: rgba(88,101,242,.12); }
.ch-icon-wh { background: rgba(109,40,217,.12); }
.ch-icon-wa { background: rgba(37,211,102,.12); }
.ch-rail-name { font-size: 12px; font-weight: 600; color: var(--tx2); }
.ch-rail-sub  { font-size: 9.5px; color: var(--tx4); margin-top: 1px; font-family: var(--font-m); }
.ch-rail-dot  {
  width: 7px; height: 7px;
  border-radius: 50%;
  margin-left: auto;
  flex-shrink: 0;
  background: var(--tx4);
}
.ch-rail-dot.active { background: var(--green); box-shadow: 0 0 6px rgba(22,163,74,.5); }
/* Detail panel */
.ch-detail {
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 28px;
  background: var(--bg);
}
.ch-detail-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 28px;
}
.ch-detail-icon {
  width: 48px; height: 48px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
  box-shadow: var(--sh2);
}
.ch-detail-name {
  font-family: var(--font-b);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0;
  color: var(--tx);
}
.ch-detail-provider { font-size: 11px; color: var(--tx4); font-family: var(--font-b); margin-top: 2px; letter-spacing: 0; }
.ch-detail-status {
  margin-left: auto;
  display: flex; align-items: center; gap: 8px;
  font-size: 11px; font-weight: 500;
  font-family: var(--font-b);
}
.ch-status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
}
.ch-dot-active { background: var(--green); box-shadow: 0 0 6px rgba(22,163,74,.5); }
.ch-dot-inactive { background: var(--tx4); }
/* Config group */
.ch-config-group {
  background: var(--sur);
  border: 1px solid var(--bd);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  box-shadow: var(--sh1);
}
.ch-config-group-title {
  padding: 11px 18px;
  border-bottom: 1px solid var(--bd);
  font-size: 10px; font-weight: 700;
  color: var(--tx3);
  background: var(--bg2);
  text-transform: uppercase;
  letter-spacing: .05em;
  font-family: var(--font-b);
}
.ch-config-row {
  display: flex;
  align-items: center;
  padding: 12px 18px;
  gap: 14px;
  border-bottom: 1px solid var(--bd);
}
.ch-config-row:last-child { border-bottom: none; }
.ch-config-label {
  font-size: 12px; color: var(--tx2); font-weight: 500;
  min-width: 90px;
}
.ch-input {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--bd);
  border-radius: 7px;
  padding: 7px 11px;
  font-size: 12px;
  color: var(--tx);
  font-family: var(--font-b);
  transition: var(--transition-smooth);
}
.ch-input:focus { outline: none; border-color: var(--acc); box-shadow: 0 0 0 3px var(--glow); }
/* Event toggles */
.ch-events-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 18px;
  border-bottom: 1px solid var(--bd);
}
.ch-events-row:last-child { border-bottom: none; }
.ch-event-label { font-size: 12px; color: var(--tx2); }
.ch-event-desc  { font-size: 10px; color: var(--tx4); margin-top: 1px; }
.ch-actions {
  display: flex;
  gap: 8px;
  padding: 0;
  margin-top: 4px;
}
.ch-note {
  font-size: 10.5px;
  color: var(--tx4);
  line-height: 1.6;
  padding: 14px 18px;
  border-top: 1px solid var(--bd);
  background: var(--bg2);
}

/* ── MEMORY UPGRADE ── */
.mem-toolbar {
  flex-shrink: 0;
  padding: 14px 20px;
  border-bottom: 1px solid var(--bd);
  background: var(--sur);
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 10px;
}
.mem-filters { display: none !important; }
.mem-search-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg2);
  border: 1px solid var(--bd);
  border-radius: 8px;
  padding: 0 12px;
  transition: border-color .18s;
}
.mem-search-wrap:focus-within { border-color: var(--acc); }
.mem-search {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  font-size: 12px;
  color: var(--tx);
  font-family: var(--font-b);
  padding: 9px 0;
}
.mem-search::placeholder { color: var(--tx4); }
.mem-filters {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.mem-chip {
  font-size: 9.5px;
  padding: 3px 10px;
  border-radius: 20px;
  border: 1px solid var(--bd);
  color: var(--tx3);
  background: var(--bg2);
  cursor: pointer;
  font-family: var(--font-m);
  font-weight: 600;
  transition: all .15s;
  letter-spacing: .04em;
  white-space: nowrap;
}
.mem-chip:hover { border-color: var(--bd2); color: var(--tx2); }
.mem-chip.active { background: var(--acc); color: #fff; border-color: var(--acc); }


/* ── PREMIUM PANEL UPGRADES ── */
.panel-section { padding: 18px; }
.panel-title {
  font-size: 9.5px;
  font-weight: 700;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: var(--tx4);
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.panel-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--bd);
}

/* ── PREMIUM MC CARDS ── */
.mc-agent-card {
  box-shadow: 0 2px 8px rgba(0,0,0,.04) !important;
}
[data-theme="dark"] .mc-agent-card {
  box-shadow: 0 2px 10px rgba(0,0,0,.18) !important;
}

/* ── PREMIUM VIEW HEADER ── */
.view-head {
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

/* ── GOLD ACCENT BADGE ── */
.badge-gold { background: var(--gold-glow); color: var(--gold); border: 1px solid var(--gold-glow); }

/* ── CORTEX AVATAR ── */
.msg-avatar.cortex-av {
  background: linear-gradient(135deg, var(--acc) 0%, var(--acc2) 100%);
  color: #fff;
  font-size: 9px;
  font-weight: 800;
  letter-spacing: .04em;
  box-shadow: 0 2px 8px var(--glow2);
}

/* ══════════════════════════════════════
   LUXURY LAYER — FORGE PREMIUM SYSTEM
══════════════════════════════════════ */

/* 4-level shadow system */
:root {
  --sh1: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
  --sh2: 0 4px 12px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.05);
  --sh3: 0 8px 28px rgba(0,0,0,.12), 0 4px 10px rgba(0,0,0,.07);
  --sh4: 0 20px 60px rgba(0,0,0,.18), 0 8px 20px rgba(0,0,0,.10);
  --gold-gradient: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 100%);
  --acc-gradient: linear-gradient(135deg, #5b21b6 0%, #7c3aed 50%, #8b5cf6 100%);
  --border-premium: 1px solid rgba(255,255,255,0.12);
  --transition-smooth: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
}
[data-theme="dark"] {
  --sh1: 0 1px 3px rgba(0,0,0,.2), 0 1px 2px rgba(0,0,0,.15);
  --sh2: 0 4px 12px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.2);
  --sh3: 0 8px 28px rgba(0,0,0,.5), 0 4px 10px rgba(0,0,0,.25);
  --sh4: 0 20px 60px rgba(0,0,0,.65), 0 8px 20px rgba(0,0,0,.4);
}

/* Premium primary button — gradient with glow */
.btn-primary {
  background: var(--acc-gradient) !important;
  box-shadow: 0 2px 12px rgba(109,40,217,.35), inset 0 1px 0 rgba(255,255,255,.12) !important;
  border: none !important;
  letter-spacing: 0.02em;
}
.btn-primary:hover {
  box-shadow: 0 4px 20px rgba(109,40,217,.55), inset 0 1px 0 rgba(255,255,255,.15) !important;
  transform: translateY(-1px);
}
.btn-primary:active { transform: translateY(0); }

/* View slide-in transition */
@keyframes viewEnter {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.view.visible { animation: viewEnter 0.22s cubic-bezier(0.4, 0, 0.2, 1) both; }

/* Premium cards baseline */
.mc-agent-card, .task-card, .stab-group {
  box-shadow: var(--sh2) !important;
  transition: var(--transition-smooth) !important;
}
.mc-agent-card:hover, .task-card:hover {
  box-shadow: var(--sh3) !important;
}

/* ── API Key Vault ── */
.key-vault-group { margin-bottom: 20px; }
.key-vault-group-title {
  font-size: 9px; font-weight: 600; letter-spacing: .14em;
  text-transform: uppercase; color: var(--tx4); margin-bottom: 10px;
}
.key-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--bd);
}
.key-row:last-child { border-bottom: none; }
.key-row-label { font-size: 11.5px; color: var(--tx2); font-weight: 500; white-space: nowrap; line-height: 1.3; }
.key-row-desc  { font-size: 9.5px; color: var(--tx4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.key-input-wrap { flex: 1; position: relative; min-width: 0; }
.key-input {
  width: 100%; background: var(--bg2); border: 1px solid var(--bd);
  border-radius: 6px; padding: 7px 34px 7px 10px; font-size: 12px;
  font-family: var(--font-m); color: var(--tx1); outline: none;
  box-sizing: border-box; transition: border-color .15s;
}
.key-input:focus { border-color: var(--acc); }
.key-eye {
  position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
  background: none; border: none; cursor: pointer; color: var(--tx4);
  line-height: 1; padding: 4px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  transition: color .15s, background .15s;
}
.key-eye:hover { color: var(--acc); background: var(--glow); }
.key-save-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green); flex-shrink: 0; opacity: 0;
  transition: opacity .3s;
}
.key-save-dot.dirty { background: var(--amber); opacity: 1; }
.key-save-dot.saved { background: var(--green); opacity: 1; }
.custom-key-row {
  display: flex; gap: 6px; align-items: center;
  margin-bottom: 6px;
}
.custom-key-name {
  width: 120px; background: var(--bg2); border: 1px solid var(--bd);
  border-radius: 6px; padding: 6px 8px; font-size: 12px; color: var(--tx1);
  font-family: var(--font-m); outline: none;
}
.custom-key-name:focus { border-color: var(--acc); }
.btn-icon-del {
  background: none; border: none; cursor: pointer;
  color: var(--tx4); font-size: 14px; padding: 4px 6px;
  border-radius: 4px; line-height: 1;
}
.btn-icon-del:hover { color: var(--red); background: rgba(239,68,68,.08); }

/* ── Alarms ── */
.alarm-list { display: flex; flex-direction: column; gap: 10px; padding: 16px; }
.alarm-card {
  background: var(--bg2); border: 1px solid var(--bd); border-radius: 10px;
  padding: 14px 16px; display: flex; align-items: center; gap: 14px;
  transition: var(--transition-smooth);
}
.alarm-card:hover { border-color: var(--acc); box-shadow: var(--sh2); }
.alarm-card.disabled { opacity: .5; }
.alarm-icon {
  width: 36px; height: 36px; border-radius: 8px;
  background: rgba(var(--acc-rgb, 99,102,241),.12);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.alarm-info { flex: 1; min-width: 0; }
.alarm-name { font-size: 13px; font-weight: 600; color: var(--tx1); }
.alarm-sched { font-size: 11px; color: var(--acc); font-family: var(--font-m); margin-top: 2px; }
.alarm-task  { font-size: 11px; color: var(--tx4); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 380px; }
.alarm-status { font-size: 11px; margin-top: 6px; padding: 2px 6px; border-radius: 4px; display: inline-block; }
.status-ok    { background: rgba(34,197,94,0.15); color: #22c55e; }
.status-err   { background: rgba(239,68,68,0.15); color: #ef4444; }
.status-pending { background: rgba(148,163,184,0.1); color: #94a3b8; }
.alarm-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.alarm-toggle {
  position: relative; width: 36px; height: 20px;
  cursor: pointer; flex-shrink: 0;
}
.alarm-toggle input { opacity: 0; width: 0; height: 0; }
.alarm-toggle-slider {
  position: absolute; inset: 0; border-radius: 10px;
  background: var(--bg3); transition: .2s;
}
.alarm-toggle input:checked + .alarm-toggle-slider { background: var(--acc); }
.alarm-toggle-slider::before {
  content: ''; position: absolute; width: 14px; height: 14px;
  border-radius: 50%; background: #fff; top: 3px; left: 3px; transition: .2s;
}
.alarm-toggle input:checked + .alarm-toggle-slider::before { transform: translateX(16px); }
.alarm-empty {
  text-align: center; padding: 60px 20px; color: var(--tx4);
}
.alarm-empty-icon { font-size: 32px; margin-bottom: 10px; opacity: .4; }
.alarm-empty-text { font-size: 13px; }

/* Alarm Modal */
.alarm-modal-body { display: flex; flex-direction: column; gap: 14px; padding: 0 2px; }
.alarm-field label { display: block; font-size: 9.5px; font-weight: 600; letter-spacing: .08em; text-transform: uppercase; color: var(--tx3); margin-bottom: 6px; }
.alarm-field input, .alarm-field select, .alarm-field textarea {
  width: 100%; background: var(--bg2); border: 1px solid var(--bd);
  border-radius: 7px; padding: 9px 12px; font-size: 12.5px; color: var(--tx);
  font-family: var(--font-b); outline: none; box-sizing: border-box;
  transition: border-color .18s;
}
.alarm-field input:focus, .alarm-field select:focus, .alarm-field textarea:focus { outline: none; border-color: var(--acc); }
.alarm-field textarea { resize: vertical; min-height: 72px; }
.alarm-field select option { background: var(--bg1); }
.alarm-sched-row { display: flex; gap: 8px; }
.alarm-sched-row .alarm-field { flex: 1; }

/* View header premium */
.view-head {
  padding: 20px 24px !important;
  border-bottom: 1px solid var(--bd);
  background: var(--bg);
  position: relative;
  z-index: 2;
}
.view-head::after {
  content: '';
  position: absolute;
  bottom: -1px; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--bd2), transparent);
}

/* Sidebar premium item */
.sidebar-item { border-radius: 0 8px 8px 0; margin-right: 10px; }
.sidebar-item.active {
  background: linear-gradient(90deg, var(--glow2) 0%, var(--glow) 100%) !important;
  box-shadow: inset 0 0 0 1px var(--glow2);
}

/* Topbar stat gradient text */
.stat-val {
  background: var(--acc-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700 !important;
}

/* Input focus premium */
input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: var(--acc) !important;
  box-shadow: 0 0 0 3px var(--glow) !important;
}

/* View title typography */
.view-title {
  font-family: var(--font-d);
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: var(--tx);
  line-height: 1;
}
.view-sub {
  font-size: 11px;
  color: var(--tx4);
  margin-top: 3px;
  font-family: var(--font-b);
  letter-spacing: 0;
}

/* ── MISSION CONTROL SECTIONS ── */
.mc-body {
  overflow-y: auto;
  flex: 1;
  display: flex;
  flex-direction: column;
}
.mc-section {
  padding: 20px 24px;
  flex-shrink: 0;
}
.mc-section + .mc-section {
  border-top: 1px solid var(--bd);
}
.mc-section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
}
.mc-section-title {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--tx4);
}
.mc-section-action {
  font-size: 10px;
  color: var(--acc);
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-family: var(--font-b);
  padding: 0;
  transition: opacity .15s;
}
.mc-section-action:hover { opacity: .7; }

/* Kanban refinement */
.kanban { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.kanban-col {
  background: transparent;
  border: 1px solid var(--bd);
  border-radius: 10px;
  padding: 10px;
  min-height: 220px;
}
[data-theme="dark"] .kanban-col { background: rgba(255,255,255,.02); }
.kanban-col-title { font-size:10px; font-weight:600; letter-spacing:.04em; text-transform:uppercase; color:var(--tx4); }
.kanban-col-count { font-size:9px; background:var(--bg3); color:var(--tx4); padding:1px 6px; border-radius:20px; font-family:var(--font-m); }

/* Task card refinement */
.task-card {
  background:rgba(255,255,255,0.68);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--bd);
  border-radius:9px;
  padding:12px 12px 0 12px;
  margin-bottom:6px;
  cursor:pointer;
  transition: var(--transition-smooth);
  overflow:hidden;
}
[data-theme="dark"] .task-card { background:rgba(15,13,28,0.55); }
.task-card:hover { border-color:var(--bd2); box-shadow:var(--sh3); transform:translateY(-1px); }
.task-title { font-size:10.5px; font-weight:500; color:var(--tx); line-height:1.4; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:0; }

/* ── PRIORITY CHIPS (modal) ── */
.priority-chips { display:flex; gap:6px; flex-wrap:wrap; }
.priority-chip {
  padding: 5px 14px;
  border-radius: 20px;
  border: 1.5px solid var(--bd);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
  color: var(--tx3);
  background: var(--bg2);
  font-family: var(--font-b);
  user-select: none;
}
.priority-chip:hover { border-color: var(--bd2); color: var(--tx2); }
.priority-chip.active[data-val="P1 Critical"] { border-color: #dc2626; background: rgba(220,38,38,.08); color: #dc2626; }
.priority-chip.active[data-val="P2 High"]     { border-color: #d97706; background: rgba(217,119,6,.08); color: #d97706; }
.priority-chip.active[data-val="P3 Normal"]   { border-color: var(--acc); background: var(--glow); color: var(--acc); }
.priority-chip.active[data-val="P4 Low"]      { border-color: var(--tx4); background: var(--bg3); color: var(--tx4); }

/* ── IMPROVED TASK CARD ── */
.task-footer {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: nowrap;
  overflow: hidden;
  height: 18px;
}
.task-pri-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
  display: inline-block;
}
.task-pri-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: .02em;
}
.task-assignee-avatar {
  width: 18px; height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: 700;
  color: #fff;
  background: var(--acc);
  margin-left: auto;
  flex-shrink: 0;
  border: 1.5px solid var(--bg);
}
.task-eta-compact {
  font-size: 9.5px;
  color: var(--tx4);
  font-family: var(--font-m);
  white-space: nowrap;
}
.task-card-body { padding-bottom: 10px; }

/* Luxury empty state */
.no-data { padding: 40px; text-align: center; color: var(--tx4); font-size: 12px; }
.empty-luxury {
  padding: 60px 40px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.empty-luxury-icon {
  width: 52px; height: 52px;
  border-radius: 16px;
  background: linear-gradient(135deg, var(--bg3) 0%, var(--bg2) 100%);
  border: 1px solid var(--bd);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
  box-shadow: var(--sh2);
  margin-bottom: 4px;
}
.empty-luxury-title {
  font-family: var(--font-d);
  font-size: 14px;
  font-weight: 700;
  color: var(--tx2);
  letter-spacing: 0.04em;
}
.empty-luxury-sub { font-size: 11px; color: var(--tx4); line-height: 1.6; max-width: 280px; }
/* ── CUSTOM SELECT — PROFESSIONAL DROPDOWN ── */
select {
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23a09dc0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 30px !important;
  cursor: pointer;
}
[data-theme="dark"] select {
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%237470a0' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
}
select option {
  background: var(--sur);
  color: var(--tx);
  font-family: var(--font-b);
  font-size: 12px;
  padding: 8px 12px;
}
/* Model selector premium */
.model-selector {
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  padding: 6px 30px 6px 10px !important;
  border-radius: 6px;
  font-family: var(--font-m);
  font-size: 10.5px;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  outline: none;
  transition: border-color .18s;
}
.model-selector:hover { border-color: var(--bd2); }
.model-selector:focus { border-color: var(--acc); box-shadow: 0 0 0 3px var(--glow); }
/* Field selects — premium feel */
.field select, .alarm-field select, .tmf select {
  background: var(--bg2);
  border: 1px solid var(--bd);
  color: var(--tx);
  border-radius: 7px;
  font-family: var(--font-b);
  font-size: 12.5px;
  transition: border-color .18s, box-shadow .18s;
}
.field select:hover, .alarm-field select:hover, .tmf select:hover { border-color: var(--bd2); }
.protocol-banner { background: rgba(109,40,217,0.08); border-left: 3px solid var(--acc); padding: 8px 22px; font-size: 11px; color: var(--tx3); font-family: var(--font-m); flex-shrink: 0; }
.protocol-banner code { color: var(--acc); font-family: var(--font-m); }
.protocol-banner strong { color: var(--tx2); }
</style>
</head>
<body data-theme="light">

<!-- ══════════ MAIN LAYOUT ══════════ -->
<div class="layout" id="app">

  <!-- TOP BAR -->
  <header class="topbar">
    <div class="brand">
      <!-- Forge Logomark v3 — Premium Geometric Anvil Mark -->
      <svg class="logo-mark" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="forge-bg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#2d1160"/>
            <stop offset="50%" stop-color="#5b21b6"/>
            <stop offset="100%" stop-color="#7c3aed"/>
          </linearGradient>
          <linearGradient id="forge-face" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#6d28d9"/>
            <stop offset="100%" stop-color="#4c1d95"/>
          </linearGradient>
          <linearGradient id="forge-gold" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fde68a"/>
            <stop offset="100%" stop-color="#f59e0b"/>
          </linearGradient>
          <filter id="logo-glow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="1.5" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <filter id="spark-glow" x="-60%" y="-60%" width="220%" height="220%">
            <feGaussianBlur stdDeviation="1" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <!-- Outer hexagon base — forged-metal feel -->
        <path d="M18 2 L32 10 L32 26 L18 34 L4 26 L4 10 Z" fill="url(#forge-bg)" filter="url(#logo-glow)"/>
        <!-- Inner hex accent ring -->
        <path d="M18 5.5 L29 12 L29 24 L18 30.5 L7 24 L7 12 Z" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.6"/>
        <!-- Subtle face plane -->
        <path d="M18 7 L28 13 L28 23 L18 29 L8 23 L8 13 Z" fill="url(#forge-face)" opacity="0.5"/>
        <!-- F letterform — sharp, geometric, premium -->
        <path d="M13 11.5 L23 11.5 L23 14 L15.5 14 L15.5 17.2 L22 17.2 L22 19.7 L15.5 19.7 L15.5 24.5 L13 24.5 Z" fill="white" opacity="0.95"/>
        <!-- Gold spark cluster — top right -->
        <circle cx="27.5" cy="5.5" r="1.1" fill="url(#forge-gold)" filter="url(#spark-glow)" opacity="0.95"/>
        <circle cx="30" cy="8" r="0.65" fill="#fde68a" opacity="0.75"/>
        <circle cx="25.5" cy="7.5" r="0.5" fill="#f59e0b" opacity="0.6"/>
        <!-- Spark streak -->
        <path d="M26.2 6.2 L29.2 7.8" stroke="#fde68a" stroke-width="0.55" stroke-linecap="round" opacity="0.55"/>
      </svg>
      <span class="brand-name" id="brand-name-label">FORGE</span><span class="brand-v2">v1</span>
    </div>

    <div class="top-center">
      <div class="stat"><div class="stat-val" id="s-mem">—</div><div class="stat-lbl">Memory</div></div>
      <div class="stat"><div class="stat-val" id="s-tasks">—</div><div class="stat-lbl">Tasks</div></div>
      <div class="stat"><div class="stat-val" id="s-agents">—</div><div class="stat-lbl">Agents</div></div>
    </div>

    <div class="top-right">
      <span class="top-clock" id="top-clock"></span>
      <button class="top-btn" onclick="switchView('channels')">Channels</button>
      <button class="top-btn" onclick="openOverlay('spawn-modal')">New Agent</button>
    </div>
  </header>

  <!-- SIDEBAR LEFT -->
  <nav class="sidebar">

    <div class="sidebar-section">
      <div class="sidebar-label">Navigation</div>
      <button class="sidebar-item active" id="nav-mission" onclick="switchView('mission', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="2"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.22 3.22l1.42 1.42M11.36 11.36l1.42 1.42M3.22 12.78l1.42-1.42M11.36 4.64l1.42-1.42" stroke="currentColor" stroke-width="1.3" fill="none"/></svg>
        Mission Control
      </button>
      <button class="sidebar-item" id="nav-chat" onclick="switchView('chat', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H5l-3 3V3a1 1 0 0 1 1-1z"/></svg>
        Chat
      </button>
      <button class="sidebar-item" id="nav-memory" onclick="switchView('memory', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.22 3.22l1.42 1.42M11.36 11.36l1.42 1.42M3.22 12.78l1.42-1.42M11.36 4.64l1.42-1.42" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>
        Memory
      </button>
      <button class="sidebar-item" id="nav-heartbeat" onclick="switchView('heartbeat', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M1 8h3l2-4 2 8 2-5 1 1h4" stroke="currentColor" stroke-width="1.4" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Heartbeat
      </button>
      <button class="sidebar-item" id="nav-channels" onclick="switchView('channels', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><circle cx="4" cy="8" r="2"/><circle cx="12" cy="4" r="2"/><circle cx="12" cy="12" r="2"/><path d="M6 7l4-2M6 9l4 2"/></svg>
        Channels
      </button>
      <button class="sidebar-item" id="nav-alarms" onclick="switchView('alarms', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="9" r="5"/><path d="M8 7v2.5l1.5 1.5M5.5 1.5L3 4M10.5 1.5L13 4"/></svg>
        Alarms
      </button>
      <button class="sidebar-item" id="nav-skills" onclick="switchView('skills', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><circle cx="8" cy="8" r="6"/><path d="M8 5v3l2 2"/></svg>
        Skills
      </button>
      <button class="sidebar-item" id="nav-settings" onclick="switchView('settings', this)">
        <svg class="sidebar-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M13.3 7.5h1V8a5 5 0 0 1-.4 2l-.9-.5c-.2.4-.4.7-.7 1l.5.9a5 5 0 0 1-1.4 1.4l-.9-.5a5 5 0 0 1-1 .7l.5.9A5 5 0 0 1 8 14h-.5v-1c-.7 0-1.4-.15-2-.4l-.5.9A5 5 0 0 1 3.6 12l.5-.9A5 5 0 0 1 3.4 10l-.9.5A5 5 0 0 1 2 8.5V8h1a6 6 0 0 1 0-1H2v-.5a5 5 0 0 1 .4-2l.9.5c.2-.4.4-.7.7-1l-.5-.9A5 5 0 0 1 5 1.6l.9.5A5 5 0 0 1 7 1.7V.8H8a5 5 0 0 1 2 .4l-.5.9c.4.2.7.4 1 .7l.9-.5a5 5 0 0 1 1.4 1.4l-.5.9c.3.6.5 1.3.5 2v.5h.5z" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>
        Settings
      </button>
    </div>

    <div class="sidebar-div"></div>

    <div class="sidebar-section">
      <div class="sidebar-label">Agents</div>
      <!-- Master agent always present -->
      <button class="agent-item active" id="ag-FORGE" onclick="selectAgent('FORGE', this)">
        <div class="agent-marker" style="background:var(--green);box-shadow:0 0 5px var(--green)"></div>
        <div style="flex:1;min-width:0">
          <div class="agent-name" id="sidebar-agent-name">FORGE</div>
          <div class="agent-role" id="sidebar-agent-role">Master · active</div>
          <div class="agent-load" id="forge-load-bar"><div class="agent-load-fill" style="width:0%;background:var(--green)"></div></div>
        </div>
      </button>
      <div id="agent-list"></div>
    </div>

  </nav>

  <!-- MAIN CONTENT AREA -->
  <main class="main">

    <!-- MISSION CONTROL VIEW -->
    <div class="view visible" id="view-mission">
      <div class="view-head">
        <div>
          <div class="view-title">Mission Control</div>
          <div class="view-sub" id="mc-sub">Loading…</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:10px;font-family:var(--font-m);color:var(--tx4)" id="mc-model-badge"></span>
          <button class="btn btn-primary" onclick="openNewTaskModal()">+ New Task</button>
        </div>
      </div>
      <div class="protocol-banner">
        ⚡ Agents must call <code>forge-task progress</code> on every significant step. Dashboard updates are <strong>mandatory</strong>.
      </div>
      <!-- Hidden usage elements kept for JS compatibility -->
      <span id="usage-model" style="display:none"></span>
      <span id="usage-provider" style="display:none"></span>
      <span id="usage-memories" style="display:none"></span>
      <span id="usage-agents" style="display:none"></span>
      <span id="usage-tasks" style="display:none"></span>
      <div class="mc-body">
        <div class="mc-section">
          <div class="mc-section-head">
            <span class="mc-section-title">Agents</span>
            <button class="mc-section-action" onclick="openOverlay('spawn-modal')">+ Spawn Agent</button>
          </div>
          <div class="mc-grid" id="mc-agent-grid">
            <div style="color:var(--tx4);font-size:11px;padding:8px">Loading…</div>
          </div>
        </div>
        <div class="mc-section" style="flex:1">
          <div class="mc-section-head">
            <span class="mc-section-title">Task Board</span>
          </div>
          <div class="kanban" id="kanban-board">
            <div style="color:var(--tx4);font-size:11px;padding:8px">Loading…</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div class="view" id="view-chat">
      <div class="view-head">
        <div>
          <div class="view-title" id="chat-agent-name">FORGE</div>
          <div class="view-sub" id="chat-agent-sub">Autonomous Execution Engine · active</div>
        </div>
        <select class="model-selector" id="model-select" onchange="onModelSelectChange(this.value)">
          <option value="">— select model —</option>
        </select>
      </div>

      <!-- Empty state -->
      <div class="empty-state" id="empty-state">
        <svg class="empty-logo" width="48" height="48" viewBox="0 0 32 32" fill="none" style="margin-bottom:4px">
          <rect width="32" height="32" rx="8" fill="#6d28d9" opacity=".15"/>
          <path d="M9 8h14v3.5H12.5v3.5h9v3.5h-9v7.5H9z" fill="#8b5cf6" opacity=".7"/>
          <circle cx="24.5" cy="6" r="1.4" fill="#f0c050" opacity=".6"/>
          <circle cx="27" cy="9.5" r="0.9" fill="#f0c050" opacity=".4"/>
        </svg>
        <div class="empty-title" id="empty-agent-title">FORGE</div>
        <div class="empty-sub">Autonomous execution engine.<br>Assign tasks, deploy code, research anything.</div>
      </div>

      <div class="messages" id="messages" style="display:none"></div>

      <div class="input-area">
        <textarea class="input-field" id="input-field"
          placeholder="Message Forge…"
          rows="1"
          onkeydown="handleKey(event)"
          oninput="autoResize(this)">
        </textarea>
        <button class="send-btn" onclick="sendMessage()">
          <svg class="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
          </svg>
        </button>
      </div>
    </div>


    <!-- CHANNELS VIEW — PREMIUM COMMAND CENTER -->
    <div class="view" id="view-channels">
      <div class="view-head">
        <div>
          <div class="view-title">Channels</div>
          <div class="view-sub">Integrations, notifications, and event routing</div>
        </div>
      </div>
      <div class="ch-layout">
        <!-- Left rail -->
        <div class="ch-rail">
          <div class="ch-rail-label">Integrations</div>
          <button class="ch-rail-item active" onclick="selectChannel('telegram',this)">
            <div class="ch-rail-icon ch-icon-tg">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21.8 4.2L2.8 11.4c-1.4.5-1.4 1.3-.2 1.6l4.8 1.5 1.8 5.4c.3.8.5 1.1 1.3.8l2.4-2.3 4.7 3.5c.9.5 1.5.2 1.7-.8l3.1-14.6c.3-1.3-.5-1.9-1.6-1.3z" fill="rgba(0,136,204,.85)"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">Telegram</div>
              <div class="ch-rail-sub">Bot API</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-telegram"></div>
          </button>
          <button class="ch-rail-item" onclick="selectChannel('discord',this)">
            <div class="ch-rail-icon ch-icon-dc">
              <svg width="16" height="16" viewBox="0 0 24 24"><path d="M20.3 3A18.7 18.7 0 0 0 15.8 1.7a13 13 0 0 0-.6 1.1 17.3 17.3 0 0 0-10.2 0 11.1 11.1 0 0 0-.6-1.1A18.7 18.7 0 0 0 3.7 3a19.1 19.1 0 0 0-2.7 15.5 18.8 18.8 0 0 0 5.7 2.9 13.5 13.5 0 0 0 1.2-1.9 12.3 12.3 0 0 1-1.7-.8l.3-.3a13.4 13.4 0 0 0 11.3 0l.4.3a12.3 12.3 0 0 1-1.8.8 15.2 15.2 0 0 0 1.2 1.9 18.7 18.7 0 0 0 5.7-2.9A19 19 0 0 0 20.3 3z" fill="rgba(88,101,242,.85)"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">Discord</div>
              <div class="ch-rail-sub">Bot API</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-discord"></div>
          </button>
          <button class="ch-rail-item" onclick="selectChannel('whatsapp',this)">
            <div class="ch-rail-icon ch-icon-wa">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(37,211,102,.85)"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">WhatsApp</div>
              <div class="ch-rail-sub">Twilio · Business API</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-whatsapp"></div>
          </button>
          <button class="ch-rail-item" onclick="selectChannel('slack',this)">
            <div class="ch-rail-icon" style="background:rgba(74,21,75,.15)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(74,21,75,.85)"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">Slack</div>
              <div class="ch-rail-sub">Bot API</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-slack"></div>
          </button>
          <button class="ch-rail-item" onclick="selectChannel('gmail',this)">
            <div class="ch-rail-icon" style="background:rgba(234,67,53,.12)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(234,67,53,.85)"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.907 1.528-1.147C21.69 2.28 24 3.434 24 5.457z"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">Gmail</div>
              <div class="ch-rail-sub">App Password</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-gmail"></div>
          </button>
          <button class="ch-rail-item" onclick="selectChannel('icloud',this)">
            <div class="ch-rail-icon" style="background:rgba(0,122,255,.12)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(0,122,255,.85)"><path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
            </div>
            <div>
              <div class="ch-rail-name">iCloud Mail</div>
              <div class="ch-rail-sub">App Password</div>
            </div>
            <div class="ch-rail-dot" id="rail-dot-icloud"></div>
          </button>
        </div>

        <!-- Right detail panel — Telegram (default visible) -->
        <div class="ch-detail" id="ch-panel-telegram">
          <div class="ch-detail-header">
            <div class="ch-detail-icon ch-icon-tg">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M21.8 4.2L2.8 11.4c-1.4.5-1.4 1.3-.2 1.6l4.8 1.5 1.8 5.4c.3.8.5 1.1 1.3.8l2.4-2.3 4.7 3.5c.9.5 1.5.2 1.7-.8l3.1-14.6c.3-1.3-.5-1.9-1.6-1.3z" fill="rgba(0,136,204,.85)"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">Telegram</div>
              <div class="ch-detail-provider">Bot API · Notifications + Commands</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-tg-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-tg-status-label">Not configured</span>
              <span class="badge" id="ch-tg-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Bot token</span>
              <input class="ch-input" type="password" id="ch-tg-token" placeholder="Configure via terminal: forge setup">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">Chat ID</span>
              <input class="ch-input" type="text" id="ch-tg-chat" placeholder="Your Telegram user ID">
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Event Routing</div>
            <div class="ch-events-row"><div><div class="ch-event-label">Task completed</div><div class="ch-event-desc">Notify when a task moves to completed</div></div><button class="toggle on" id="tg-evt-task" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Heartbeat alerts</div><div class="ch-event-desc">System health warnings and check-ins</div></div><button class="toggle on" id="tg-evt-hb" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Autonomous updates</div><div class="ch-event-desc">Proactive briefings from Forge</div></div><button class="toggle" id="tg-evt-auto" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Errors</div><div class="ch-event-desc">System errors and failures</div></div><button class="toggle on" id="tg-evt-err" onclick="this.classList.toggle('on')"></button></div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('telegram')">Test connection</button>
            <button class="btn btn-primary" onclick="saveChannel('telegram')">Save</button>
          </div>
          <div class="ch-config-group" style="margin-top:16px">
            <div class="ch-note">Forge sends Telegram messages for configured events. Run <code style="font-family:var(--font-m);color:var(--acc)">forge setup</code> in terminal for guided configuration.</div>
          </div>
        </div>

        <!-- Discord panel (hidden by default) -->
        <div class="ch-detail" id="ch-panel-discord" style="display:none">
          <div class="ch-detail-header">
            <div class="ch-detail-icon ch-icon-dc">
              <svg width="22" height="22" viewBox="0 0 24 24"><path d="M20.3 3A18.7 18.7 0 0 0 15.8 1.7a13 13 0 0 0-.6 1.1 17.3 17.3 0 0 0-10.2 0 11.1 11.1 0 0 0-.6-1.1A18.7 18.7 0 0 0 3.7 3a19.1 19.1 0 0 0-2.7 15.5 18.8 18.8 0 0 0 5.7 2.9 13.5 13.5 0 0 0 1.2-1.9 12.3 12.3 0 0 1-1.7-.8l.3-.3a13.4 13.4 0 0 0 11.3 0l.4.3a12.3 12.3 0 0 1-1.8.8 15.2 15.2 0 0 0 1.2 1.9 18.7 18.7 0 0 0 5.7-2.9A19 19 0 0 0 20.3 3z" fill="rgba(88,101,242,.85)"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">Discord</div>
              <div class="ch-detail-provider">Bot API · Server notifications</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-dc-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-dc-status-label">Not configured</span>
              <span class="badge" id="ch-dc-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Bot Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Bot Token</span>
              <input class="ch-input" type="password" id="ch-dc-token" placeholder="Bot token from Discord Developer Portal">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">Server ID</span>
              <input class="ch-input" type="text" id="ch-dc-guild" placeholder="Right-click server → Copy Server ID">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">Channel ID <span style="font-size:9px;color:var(--tx4);font-weight:400">(optional)</span></span>
              <input class="ch-input" type="text" id="ch-dc-channel" placeholder="Right-click channel → Copy Channel ID">
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Event Routing</div>
            <div class="ch-events-row"><div><div class="ch-event-label">Task completed</div><div class="ch-event-desc">Post to channel on task completion</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Errors</div><div class="ch-event-desc">System errors and failures</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('discord')">Test connection</button>
            <button class="btn btn-primary" onclick="saveChannel('discord')">Save</button>
          </div>
          <div class="ch-config-group" style="margin-top:16px">
            <div class="ch-note">Enable Developer Mode in Discord (Settings → Advanced) to copy Server/Channel IDs. Bot must be invited to your server with <code style="font-family:var(--font-m);color:var(--acc)">Send Messages</code> permission.</div>
          </div>
        </div>

        <!-- Webhook panel (hidden by default) -->
        <div class="ch-detail" id="ch-panel-whatsapp" style="display:none">
          <div class="ch-detail-header">
            <div class="ch-detail-icon ch-icon-wa">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(37,211,102,.85)"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">WhatsApp</div>
              <div class="ch-detail-provider">Twilio · Business API · Notifications</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-wa-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-wa-status-label">Not configured</span>
              <span class="badge" id="ch-wa-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Twilio Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Account SID</span>
              <input class="ch-input" type="text" id="ch-wa-sid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">Auth Token</span>
              <input class="ch-input" type="password" id="ch-wa-token" placeholder="Your Twilio Auth Token">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">From number</span>
              <input class="ch-input" type="text" id="ch-wa-from" placeholder="whatsapp:+14155238886">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">To number</span>
              <input class="ch-input" type="text" id="ch-wa-to" placeholder="whatsapp:+614xxxxxxxx">
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Event Routing</div>
            <div class="ch-events-row"><div><div class="ch-event-label">Task completed</div><div class="ch-event-desc">Notify when a task moves to completed</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Heartbeat alerts</div><div class="ch-event-desc">System health warnings and check-ins</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Autonomous updates</div><div class="ch-event-desc">Proactive briefings from Forge</div></div><button class="toggle" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Errors</div><div class="ch-event-desc">System errors and failures</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('whatsapp')">Send test message</button>
            <button class="btn btn-primary" onclick="saveChannel('whatsapp')">Save</button>
          </div>
        </div>
        <!-- Slack panel -->
        <div class="ch-detail" id="ch-panel-slack" style="display:none">
          <div class="ch-detail-header">
            <div class="ch-detail-icon" style="background:rgba(74,21,75,.15)">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(74,21,75,.85)"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">Slack</div>
              <div class="ch-detail-provider">Bot API · Channel notifications</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-sl-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-sl-status-label">Not configured</span>
              <span class="badge" id="ch-sl-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Bot Token</span>
              <input class="ch-input" type="password" id="ch-sl-token" placeholder="xoxb-…">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">Default Channel</span>
              <input class="ch-input" type="text" id="ch-sl-channel" placeholder="#general or channel ID">
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Event Routing</div>
            <div class="ch-events-row"><div><div class="ch-event-label">Task completed</div><div class="ch-event-desc">Post on task completion</div></div><button class="toggle on" onclick="this.classList.toggle('on')"></button></div>
            <div class="ch-events-row"><div><div class="ch-event-label">Errors</div><div class="ch-event-desc">System errors and failures</div></div><button class="toggle" onclick="this.classList.toggle('on')"></button></div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('slack')">Test connection</button>
            <button class="btn btn-primary" onclick="saveChannel('slack')">Save</button>
          </div>
          <div class="ch-config-group" style="margin-top:16px">
            <div class="ch-note">Create a Slack App at <code style="font-family:var(--font-m);color:var(--acc)">api.slack.com/apps</code>, add <code style="font-family:var(--font-m);color:var(--acc)">chat:write</code> scope, install to workspace, copy the Bot User OAuth Token.</div>
          </div>
        </div>

        <!-- Gmail panel -->
        <div class="ch-detail" id="ch-panel-gmail" style="display:none">
          <div class="ch-detail-header">
            <div class="ch-detail-icon" style="background:rgba(234,67,53,.12)">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(234,67,53,.85)"><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.907 1.528-1.147C21.69 2.28 24 3.434 24 5.457z"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">Gmail</div>
              <div class="ch-detail-provider">SMTP · App Password</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-gm-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-gm-status-label">Not configured</span>
              <span class="badge" id="ch-gm-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Gmail Address</span>
              <input class="ch-input" type="email" id="ch-gm-email" placeholder="you@gmail.com">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">App Password</span>
              <input class="ch-input" type="password" id="ch-gm-password" placeholder="16-character app password">
            </div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('gmail')">Send test email</button>
            <button class="btn btn-primary" onclick="saveChannel('gmail')">Save</button>
          </div>
          <div class="ch-config-group" style="margin-top:16px">
            <div class="ch-note">Enable 2FA on your Google account, then go to <code style="font-family:var(--font-m);color:var(--acc)">myaccount.google.com/apppasswords</code> to generate an App Password.</div>
          </div>
        </div>

        <!-- iCloud Mail panel -->
        <div class="ch-detail" id="ch-panel-icloud" style="display:none">
          <div class="ch-detail-header">
            <div class="ch-detail-icon" style="background:rgba(0,122,255,.12)">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(0,122,255,.85)"><path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
            </div>
            <div>
              <div class="ch-detail-name">iCloud Mail</div>
              <div class="ch-detail-provider">SMTP · App Password</div>
            </div>
            <div class="ch-detail-status">
              <div class="ch-status-dot" id="ch-ic-dot" style="background:var(--tx4);width:8px;height:8px;border-radius:50%"></div>
              <span id="ch-ic-status-label">Not configured</span>
              <span class="badge" id="ch-ic-badge" style="margin-left:4px">—</span>
            </div>
          </div>
          <div class="ch-config-group">
            <div class="ch-config-group-title">Credentials</div>
            <div class="ch-config-row">
              <span class="ch-config-label">Apple ID (email)</span>
              <input class="ch-input" type="email" id="ch-ic-email" placeholder="you@icloud.com">
            </div>
            <div class="ch-config-row">
              <span class="ch-config-label">App Password</span>
              <input class="ch-input" type="password" id="ch-ic-password" placeholder="App-specific password from appleid.apple.com">
            </div>
          </div>
          <div class="ch-actions">
            <button class="btn btn-ghost" onclick="testChannel('icloud')">Send test email</button>
            <button class="btn btn-primary" onclick="saveChannel('icloud')">Save</button>
          </div>
          <div class="ch-config-group" style="margin-top:16px">
            <div class="ch-note">Generate an App Password at <code style="font-family:var(--font-m);color:var(--acc)">appleid.apple.com → Sign-In and Security → App-Specific Passwords</code>.</div>
          </div>
        </div>

      </div>
    </div>

    <!-- ALARMS VIEW -->
    <div class="view" id="view-alarms">
      <div class="view-head">
        <div>
          <div class="view-title">Alarms</div>
          <div class="view-sub">Schedule recurring tasks — Forge executes them on time, every time</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="alarms-count-badge" class="badge" style="display:none"></span>
          <button class="btn btn-primary" onclick="openAlarmModal()">+ New Alarm</button>
        </div>
      </div>
      <div style="flex:1;overflow-y:auto">
        <div id="alarms-list" class="alarm-list"></div>
      </div>
    </div>

    <!-- ALARM MODAL -->
    <div class="overlay" id="alarm-modal" onclick="if(event.target===this)closeAlarmModal()">
      <div class="modal" style="width:460px;max-width:96vw">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title" id="alarm-modal-title">New Alarm</div>
            <div class="modal-sub" style="margin-bottom:0">Schedule a recurring task for Forge</div>
          </div>
          <button class="modal-close" onclick="closeAlarmModal()">✕</button>
        </div>
        <div class="alarm-modal-body">
          <input type="hidden" id="alarm-edit-id">
          <div class="alarm-field">
            <label>Alarm Name</label>
            <input type="text" id="alarm-name" placeholder="e.g. Morning Briefing">
          </div>
          <div class="alarm-sched-row">
            <div class="alarm-field">
              <label>Frequency</label>
              <select id="alarm-freq" onchange="updateAlarmCronPreview()">
                <option value="daily">Daily</option>
                <option value="weekdays">Weekdays only</option>
                <option value="weekly">Weekly</option>
                <option value="hourly">Every hour</option>
                <option value="custom">Custom (cron)</option>
              </select>
            </div>
            <div class="alarm-field" id="alarm-time-wrap">
              <label>Time</label>
              <input type="time" id="alarm-time" value="09:00" onchange="updateAlarmCronPreview()">
            </div>
            <div class="alarm-field" id="alarm-day-wrap" style="display:none">
              <label>Day</label>
              <select id="alarm-day" onchange="updateAlarmCronPreview()">
                <option value="1">Monday</option><option value="2">Tuesday</option>
                <option value="3">Wednesday</option><option value="4">Thursday</option>
                <option value="5">Friday</option><option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
            </div>
          </div>
          <div class="alarm-field" id="alarm-cron-wrap" style="display:none">
            <label>Cron Expression</label>
            <input type="text" id="alarm-cron" placeholder="0 9 * * *">
          </div>
          <div style="font-size:10.5px;color:var(--acc);font-family:var(--font-m)" id="alarm-cron-preview">Schedule: every day at 09:00</div>
          <div class="alarm-field">
            <label>Task / Prompt</label>
            <textarea id="alarm-task" placeholder="What should Forge do when this alarm fires? e.g. 'Send me a morning briefing with today's top news and my calendar'"></textarea>
          </div>
          <div class="alarm-field">
            <label>Output Channel</label>
            <select id="alarm-channel">
              <option value="telegram">Telegram</option>
              <option value="chat">Dashboard Chat</option>
            </select>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeAlarmModal()">Cancel</button>
          <button class="btn btn-primary" onclick="submitAlarm()">Save Alarm</button>
        </div>
      </div>
    </div>

    <!-- SKILLS VIEW -->
    <div class="view" id="view-skills">
      <div class="view-head">
        <div>
          <div class="view-title">Skills</div>
          <div class="view-sub" id="skills-count-label">Forge's installed capabilities</div>
        </div>
        <button class="btn btn-primary" onclick="openSkillCreator()">+ New Skill</button>
      </div>
      <div style="flex:1;overflow-y:auto;padding:16px 20px">
        <div id="skills-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px"></div>
      </div>
    </div>

    <!-- SKILL CREATOR MODAL -->
    <div class="overlay" id="skill-creator-modal" onclick="if(event.target===this)closeSkillCreator()">
      <div class="modal" style="width:600px;max-width:96vw">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">New Skill</div>
            <div class="modal-sub" style="margin-bottom:0">Add a Python capability to Forge</div>
          </div>
          <button class="modal-close" onclick="closeSkillCreator()">✕</button>
        </div>
        <div class="field">
          <label>Skill Name</label>
          <input type="text" id="skill-name-input" placeholder="e.g. send_report, check_weather">
        </div>
        <div class="field">
          <label>Description</label>
          <input type="text" id="skill-desc-input" placeholder="What does this skill do?">
        </div>
        <div class="field">
          <label>What should this skill do?</label>
          <textarea id="skill-behavior-input" style="min-height:80px;resize:vertical" placeholder="Describe what this skill should do in plain English. e.g. Check the weather for a given city and return a summary."></textarea>
        </div>
        <div class="field">
          <label>Required Inputs <span style="text-transform:none;letter-spacing:0;font-weight:400;font-size:9px;color:var(--tx4)">comma-separated parameter names</span></label>
          <input type="text" id="skill-params-input" placeholder="e.g. city, date — or leave blank if none">
        </div>
        <!-- code is generated automatically — hidden from user -->
        <textarea id="skill-code-input" style="display:none" aria-hidden="true"></textarea>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeSkillCreator()">Cancel</button>
          <button class="btn btn-primary" onclick="saveNewSkill()">Save Skill</button>
        </div>
      </div>
    </div>

    <!-- SKILL DETAIL MODAL -->
    <div class="overlay" id="skill-detail-modal" onclick="if(event.target===this)closeOverlay('skill-detail-modal')">
      <div class="modal" style="width:600px;max-width:96vw">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title" id="sdm-title">Skill</div>
            <div class="modal-sub" id="sdm-desc" style="margin-bottom:0">—</div>
          </div>
          <button class="modal-close" onclick="closeOverlay('skill-detail-modal')">✕</button>
        </div>
        <div class="field">
          <label>File</label>
          <div id="sdm-file" style="font-family:var(--font-m);font-size:11px;color:var(--tx3);padding:8px 12px;background:var(--bg3);border-radius:6px;border:1px solid var(--bd)">—</div>
        </div>
        <!-- code loaded for internal use, not shown to user -->
        <textarea id="sdm-code" style="display:none" aria-hidden="true" readonly></textarea>
        <div class="modal-actions" style="justify-content:space-between">
          <button class="btn btn-ghost" style="color:var(--red)" id="sdm-delete-btn">Delete Skill</button>
          <button class="btn btn-ghost" onclick="closeOverlay('skill-detail-modal')">Close</button>
        </div>
      </div>
    </div>

    <!-- MEMORY VIEW — PREMIUM INTELLIGENCE DASHBOARD -->
    <div class="view" id="view-memory">
      <div class="view-head">
        <div>
          <div class="view-title">Memory</div>
          <div class="view-sub" id="memory-count-label">Forge's persistent knowledge base</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" style="font-size:11px" onclick="exportMemory()">
            <svg width="11" height="11" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" style="margin-right:4px"><path d="M8 2v9M4 7l4 4 4-4"/><path d="M2 14h12"/></svg>
            Export
          </button>
          <button class="btn btn-primary" style="font-size:11px" onclick="loadMemory()">
            <svg width="11" height="11" viewBox="0 0 16 16" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" style="margin-right:4px"><path d="M14 10v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-3"/><path d="M8 2v9M4 6l4-4 4 4"/></svg>
            Sync
          </button>
        </div>
      </div>
      <!-- Stats bar -->
      <div class="mem-stats-bar">
        <div class="mem-stat-cell">
          <div class="mem-stat-val" id="mem-stat-total">—</div>
          <div class="mem-stat-lbl">Total memories</div>
        </div>
        <div class="mem-stat-cell">
          <div class="mem-stat-val" id="mem-stat-cats">—</div>
          <div class="mem-stat-lbl">Categories</div>
        </div>
        <div class="mem-stat-cell">
          <div class="mem-stat-val" id="mem-stat-learnings">—</div>
          <div class="mem-stat-lbl">Learnings</div>
        </div>
        <div class="mem-stat-cell">
          <span style="font-size:10px;color:var(--tx4);font-family:var(--font-m)">Last sync</span>
          <span style="font-size:10px;color:var(--tx2);font-family:var(--font-m)" id="mem-stat-sync">—</span>
        </div>
      </div>
      <div class="mem-toolbar">
        <div class="mem-search-wrap">
          <svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" style="flex-shrink:0;color:var(--tx4)"><circle cx="6.5" cy="6.5" r="4.5"/><path d="M10.5 10.5l3 3" stroke-linecap="round"/></svg>
          <input class="mem-search" id="mem-search" placeholder="Search memories and learnings…" oninput="filterMemory(this.value)">
        </div>
        <div class="mem-filters" id="mem-filters" style="display:none"></div>
      </div>
      <div class="memory-list" id="memory-list">
        <div class="no-data">Loading memories…</div>
      </div>
    </div>

    <!-- HEARTBEAT VIEW -->
    <div class="view" id="view-heartbeat">
      <div class="view-head">
        <div>
          <div class="view-title">❤️ Heartbeat — The Lifeblood of Forge</div>
          <div class="view-sub">The Heartbeat is the lifeblood of Forge. Every 30 minutes, it checks system vitals, confirms the pulse is strong, and records the result. If the heartbeat flatlines — Forge goes dark. Keep it beating.</div>
        </div>
      </div>
      <div class="hb-chart-wrap">
        <div class="hb-stat-cards">
          <div class="hb-stat-card">
            <div class="hb-stat-val green" id="hb-uptime-val">—</div>
            <div class="hb-stat-lbl">Uptime</div>
          </div>
          <div class="hb-stat-card">
            <div class="hb-stat-val" id="hb-total-val">—</div>
            <div class="hb-stat-lbl">Pulse Count</div>
          </div>
          <div class="hb-stat-card">
            <div class="hb-stat-val amber" id="hb-warn-val">—</div>
            <div class="hb-stat-lbl">Warnings</div>
          </div>
        </div>
        <div class="hb-chart-card">
          <div class="hb-chart-title">Status over time (last 48 checks)</div>
          <svg class="hb-svg-chart" id="hb-svg" viewBox="0 0 800 120" preserveAspectRatio="none"></svg>
          <div class="hb-chart-row">
            <div class="hb-chart-legend"><div class="hb-chart-legend-dot" style="background:var(--green)"></div>Beating</div>
            <div class="hb-chart-legend"><div class="hb-chart-legend-dot" style="background:var(--amber)"></div>Weak Pulse</div>
            <div class="hb-chart-legend"><div class="hb-chart-legend-dot" style="background:var(--red)"></div>Flatline</div>
          </div>
        </div>
        <div class="hb-chart-card">
          <div class="hb-chart-title">Recent checks</div>
          <div class="hb-recent-list" id="hb-recent-list">
            <div class="no-data">No heartbeat data yet. Forge checks every 30 minutes.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS VIEW -->
<div class="view" id="view-settings">
  <div class="view-head">
    <div>
      <div class="view-title">Settings</div>
      <div class="view-sub">System configuration — tokens stored locally, never transmitted</div>
    </div>
  </div>
  <div class="settings-layout">
    <!-- Left nav -->
    <div class="settings-sidenav">
      <div class="settings-sidenav-label">Configuration</div>
      <button class="settings-tab active" onclick="switchSettingsTab(this,'profile')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="5" r="3"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
        Profile
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'model')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><rect x="2" y="3" width="12" height="10" rx="2"/><path d="M5 7h6M5 10h4"/></svg>
        AI Model
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'appearance')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><circle cx="8" cy="8" r="6"/><circle cx="8" cy="8" r="2.5"/></svg>
        Appearance
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'heartbeat')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><path d="M1 8h3l2-4 2 8 2-5 1 1h4"/></svg>
        Heartbeat
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'integrations')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><circle cx="4" cy="8" r="2"/><circle cx="12" cy="4" r="2"/><circle cx="12" cy="12" r="2"/><path d="M6 7l4-2M6 9l4 2"/></svg>
        Connections
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'keys')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="7" r="3"/><path d="M9 9.5l5 5M11 12l1.5 1.5"/><path d="M6 5v.5M4.5 6.5h.5"/></svg>
        API Keys
      </button>
      <button class="settings-tab" onclick="switchSettingsTab(this,'system')">
        <svg class="stab-nav-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
        System
      </button>
    </div>
    <!-- Right content -->
    <div class="settings-content">

      <!-- PROFILE -->
      <div class="stab-pane visible" id="stab-profile">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">Profile</div>
            <div class="stab-sub">Identity and workspace configuration</div>
          </div>
          <span class="stab-last-saved" id="profile-saved-ts">Not saved yet</span>
        </div>
        <div class="profile-hero-row">
          <div class="profile-avatar" id="profile-avatar-initials">?</div>
          <div class="profile-hero-info">
            <div class="profile-name" id="profile-display-name">Loading…</div>
            <div class="profile-workspace" id="profile-workspace-label">Forge Workspace</div>
            <div class="workspace-badge">
              <svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="3"/></svg>
              ACTIVE
            </div>
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Owner</div>
          <div class="stab-row">
            <div><div class="stab-row-key">Name</div><div class="stab-row-desc">Displayed in reports and briefings</div></div>
            <input class="stab-input" id="cfg-owner" placeholder="Your name" oninput="updateProfileHero(this.value)">
          </div>
          <div class="stab-row">
            <div><div class="stab-row-key">Brand</div><div class="stab-row-desc">System and product identity</div></div>
            <input class="stab-input" id="cfg-brand-name" value="Forge" readonly style="opacity:0.5;cursor:default">
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">System</div>
          <div class="stab-row">
            <div><div class="stab-row-key">AI Name</div><div class="stab-row-desc">How the AI identifies itself in chat</div></div>
            <input class="stab-input" id="cfg-ai-name" value="Forge" readonly style="opacity:0.5;cursor:default">
          </div>
          <div class="stab-row">
            <div><div class="stab-row-key">Active model</div><div class="stab-row-desc">Current inference model</div></div>
            <input class="stab-input" id="cfg-primary-model" placeholder="Loading…" readonly style="cursor:default;opacity:0.6">
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:4px">
          <button class="btn btn-primary" onclick="saveSettings()">Save changes</button>
        </div>
        <!-- DANGER ZONE -->
        <div class="danger-zone">
          <div class="danger-zone-title">Danger Zone</div>
          <div class="danger-row">
            <div>
              <div class="stab-row-key" style="color:var(--tx2)">Reset Memory</div>
              <div class="stab-row-desc">Delete all stored learnings from forge.db</div>
            </div>
            <button class="btn-danger" onclick="if(confirm('Delete all memory? This cannot be undone.')) api('/memory/reset',{confirm:true}).then(r=>{ if(r.success){ loadStatus(); showSavedToast('Memory cleared'); } else { alert('Failed: '+(r.error||'unknown error')); } })">Reset Memory</button>
          </div>
          <div class="danger-row">
            <div>
              <div class="stab-row-key" style="color:var(--tx2)">Clear All Tasks</div>
              <div class="stab-row-desc">Remove all tasks from the board</div>
            </div>
            <button class="btn-danger" onclick="if(confirm('Clear all tasks? This cannot be undone.')) api('/tasks/clear',{confirm:true}).then(r=>{ if(r.success){ loadMissionControl(); showSavedToast('Tasks cleared'); } else { alert('Failed: '+(r.error||'unknown error')); } })">Clear Tasks</button>
          </div>
        </div>
      </div>

      <!-- AI MODEL -->
      <div class="stab-pane" id="stab-model">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">AI Model</div>
            <div class="stab-sub">Select the inference model for Forge</div>
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Model Selection</div>
          <div class="model-cards-grid" id="model-cards">
            <!-- Populated dynamically by renderModelCards() based on active provider -->
          </div>
          <div style="padding:12px 18px;border-top:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between">
            <span style="font-size:11px;color:var(--tx3)">Active model</span>
            <span style="font-size:12px;font-weight:600;color:var(--acc);font-family:var(--font-m)" id="cfg-current-model-label">—</span>
          </div>
        </div>
        <div style="display:flex;justify-content:flex-end;padding:0 2px">
          <button class="btn btn-primary" onclick="saveSettings()">Save model</button>
        </div>
      </div>

      <!-- APPEARANCE -->
      <div class="stab-pane" id="stab-appearance">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">Appearance</div>
            <div class="stab-sub">Visual preferences and display</div>
          </div>
          <span class="stab-last-saved" id="appearance-theme-label">Light theme</span>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Theme</div>
          <div class="theme-preview-row">
            <div class="theme-prev selected" id="prev-light" onclick="setTheme('light',this)">
              <div class="theme-prev-swatch" style="background:linear-gradient(135deg,#f8f7fc,#e9e7f5);border:1px solid #e0ddf2"></div>
              <div class="theme-prev-label">Light</div>
            </div>
            <div class="theme-prev" id="prev-dark" onclick="setTheme('dark',this)">
              <div class="theme-prev-swatch" style="background:linear-gradient(135deg,#07060e,#131022);border:1px solid #1c1930"></div>
              <div class="theme-prev-label">Dark</div>
            </div>
          </div>
        </div>
      </div>

      <!-- HEARTBEAT -->
      <div class="stab-pane" id="stab-heartbeat">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">❤️ Heartbeat — The Lifeblood of Forge</div>
            <div class="stab-sub">Autonomous health monitoring. The heartbeat runs every 30 minutes — non-negotiable. This is what keeps Forge alive.</div>
          </div>
          <span class="stab-last-saved" id="hb-next-label">Next: —</span>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Configuration</div>
          <div class="stab-row">
            <div><div class="stab-row-key">Enabled</div><div class="stab-row-desc">Run health checks on a schedule</div></div>
            <button class="toggle" id="hb-toggle" onclick="toggleHeartbeat('enabled')"></button>
          </div>
          <div class="stab-row">
            <div><div class="stab-row-key">Interval</div><div class="stab-row-desc">The heartbeat runs every 30 minutes — non-negotiable. This is what keeps Forge alive.</div></div>
            <span class="badge badge-ok" style="font-size:10px">30-min interval</span>
          </div>
          <div class="stab-row">
            <div><div class="stab-row-key">Notify via Telegram</div><div class="stab-row-desc">Push alerts to your bot on issues</div></div>
            <button class="toggle" id="hb-notify-toggle" onclick="toggleHeartbeat('notify_telegram')"></button>
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Check History (last 10)</div>
          <div class="hb-timeline" id="hb-timeline-dots">
            <!-- Dots rendered by JS -->
          </div>
          <div class="stab-row" style="border-top:1px solid var(--bd)">
            <div><div class="stab-row-key">Last heartbeat</div></div>
            <span class="badge badge-ok" id="hb-last-status">—</span>
          </div>
          <div class="stab-row">
            <div><div class="stab-row-key">Next scheduled</div></div>
            <span style="font-size:11px;font-family:var(--font-m);color:var(--acc);font-weight:600" id="hb-next">—</span>
          </div>
        </div>
      </div>

      <!-- CONNECTIONS (was Integrations) -->
      <div class="stab-pane" id="stab-integrations">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">Connections</div>
            <div class="stab-sub">External channels and notification services</div>
          </div>
          <span class="stab-last-saved" id="connections-status-label">Loading…</span>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Active connections</div>
          <div class="stab-row">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:30px;height:30px;border-radius:8px;background:rgba(0,136,204,.1);display:flex;align-items:center;justify-content:center;font-size:15px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(0,136,204,0.8)"><path d="M21.8 4.2L2.8 11.4c-1.4.5-1.4 1.3-.2 1.6l4.8 1.5 1.8 5.4c.3.8.5 1.1 1.3.8l2.4-2.3 4.7 3.5c.9.5 1.5.2 1.7-.8l3.1-14.6c.3-1.3-.5-1.9-1.6-1.3z"/></svg>
              </div>
              <div><div class="stab-row-key">Telegram</div><div class="stab-row-desc">Bot notifications</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge" id="stab-tg-badge">—</span>
              <button class="btn btn-ghost" style="font-size:10px;height:26px;padding:0 10px" onclick="switchView('channels')">Configure</button>
            </div>
          </div>
          <div class="stab-row">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="width:30px;height:30px;border-radius:8px;background:rgba(88,101,242,.1);display:flex;align-items:center;justify-content:center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="rgba(88,101,242,0.8)"><path d="M20.3 3A18.7 18.7 0 0 0 15.8 1.7a13 13 0 0 0-.6 1.1 17.3 17.3 0 0 0-10.2 0 11.1 11.1 0 0 0-.6-1.1A18.7 18.7 0 0 0 3.7 3a19.1 19.1 0 0 0-2.7 15.5 18.8 18.8 0 0 0 5.7 2.9 13.5 13.5 0 0 0 1.2-1.9 12.3 12.3 0 0 1-1.7-.8l.3-.3a13.4 13.4 0 0 0 11.3 0l.4.3a12.3 12.3 0 0 1-1.8.8 15.2 15.2 0 0 0 1.2 1.9 18.7 18.7 0 0 0 5.7-2.9A19 19 0 0 0 20.3 3z"/></svg>
              </div>
              <div><div class="stab-row-key">Discord</div><div class="stab-row-desc">Server notifications</div></div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <span class="badge" id="stab-dc-badge">—</span>
              <button class="btn btn-ghost" style="font-size:10px;height:26px;padding:0 10px" onclick="switchView('channels')">Configure</button>
            </div>
          </div>
        </div>
        <div style="font-size:10.5px;color:var(--tx4);margin-top:4px;line-height:1.7">
          Tokens and API keys are stored in <code style="font-family:var(--font-m);color:var(--acc)">forge.json</code> on this machine only. Never transmitted externally.
        </div>
      </div>

      <!-- API KEYS VAULT -->
      <div class="stab-pane" id="stab-keys">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">API Key Vault</div>
            <div class="stab-sub">Stored locally in forge.json — never transmitted externally</div>
          </div>
          <button class="btn btn-primary" style="font-size:11px" onclick="saveAllKeys()">Save All</button>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:0 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>Communication</div>

        <!-- Google / Gmail / Calendar -->
        <div class="stab-group">
          <div class="stab-group-title">Google (Gmail · Calendar · Drive)</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Client ID</div><div class="key-row-desc">OAuth client ID</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-google-client-id" placeholder="xxxxxxxx.apps.googleusercontent.com" oninput="markKeyDirty('google-client-id')"><button class="key-eye" onclick="toggleKeyVis('key-google-client-id',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-google-client-id"></div>
          </div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Client Secret</div><div class="key-row-desc">OAuth client secret</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-google-client-secret" placeholder="GOCSPX-…" oninput="markKeyDirty('google-client-secret')"><button class="key-eye" onclick="toggleKeyVis('key-google-client-secret',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-google-client-secret"></div>
          </div>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:24px 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>Development & Productivity</div>

        <!-- GitHub -->
        <div class="stab-group">
          <div class="stab-group-title">GitHub</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Personal Token</div><div class="key-row-desc">repo, issues, PRs</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-github-token" placeholder="ghp_…" oninput="markKeyDirty('github-token')"><button class="key-eye" onclick="toggleKeyVis('key-github-token',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-github-token"></div>
          </div>
        </div>

        <!-- Notion -->
        <div class="stab-group">
          <div class="stab-group-title">Notion</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Integration Token</div><div class="key-row-desc">Internal integration</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-notion-token" placeholder="secret_…" oninput="markKeyDirty('notion-token')"><button class="key-eye" onclick="toggleKeyVis('key-notion-token',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-notion-token"></div>
          </div>
        </div>

        <!-- Slack -->
        <div class="stab-group">
          <div class="stab-group-title">Slack</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Bot Token</div><div class="key-row-desc">xoxb- bot token</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-slack-bot-token" placeholder="xoxb-…" oninput="markKeyDirty('slack-bot-token')"><button class="key-eye" onclick="toggleKeyVis('key-slack-bot-token',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-slack-bot-token"></div>
          </div>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:24px 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>Search & Intelligence</div>

        <!-- Web Search -->
        <div class="stab-group">
          <div class="stab-group-title">Web Search (Serper)</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Serper API Key</div><div class="key-row-desc">serper.dev</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-serper-key" placeholder="xxxxxxxx" oninput="markKeyDirty('serper-key')"><button class="key-eye" onclick="toggleKeyVis('key-serper-key',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-serper-key"></div>
          </div>
        </div>

        <!-- Brave Search -->
        <div class="stab-group">
          <div class="stab-group-title">Brave Search</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">API Key</div><div class="key-row-desc">search.brave.com</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-brave-key" placeholder="BSA…" oninput="markKeyDirty('brave-key')"><button class="key-eye" onclick="toggleKeyVis('key-brave-key',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-brave-key"></div>
          </div>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:24px 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>AI Providers</div>

        <!-- Kimi (Moonshot AI) -->
        <div class="stab-group">
          <div class="stab-group-title">Kimi (Moonshot AI)</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">API Key</div><div class="key-row-desc">Get your key from <a href="https://platform.moonshot.ai/api-keys" target="_blank" style="color:var(--acc)">platform.moonshot.ai</a></div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-kimi-key" placeholder="sk-…" oninput="markKeyDirty('kimi-key')"><button class="key-eye" onclick="toggleKeyVis('key-kimi-key',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-kimi-key"></div>
          </div>
        </div>

        <!-- Cursor AI -->
        <div class="stab-group">
          <div class="stab-group-title">Cursor AI</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">API Key</div><div class="key-row-desc">cursor.com API</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-cursor-key" placeholder="cursor-…" oninput="markKeyDirty('cursor-key')"><button class="key-eye" onclick="toggleKeyVis('key-cursor-key',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-cursor-key"></div>
          </div>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:24px 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>Utilities</div>

        <!-- iCloud Mail -->
        <div class="stab-group">
          <div class="stab-group-title">iCloud Mail</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Apple ID</div><div class="key-row-desc">your@icloud.com</div></div>
            <div class="key-input-wrap"><input class="key-input" type="text" id="key-icloud-email" placeholder="you@icloud.com" oninput="markKeyDirty('icloud-email')"></div>
            <div class="key-save-dot" id="dot-icloud-email"></div>
          </div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">App Password</div><div class="key-row-desc">appleid.apple.com → Security</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-icloud-app-password" placeholder="xxxx-xxxx-xxxx-xxxx" oninput="markKeyDirty('icloud-app-password')"><button class="key-eye" onclick="toggleKeyVis('key-icloud-app-password',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-icloud-app-password"></div>
          </div>
        </div>

        <!-- Weather -->
        <div class="stab-group">
          <div class="stab-group-title">Weather (OpenWeatherMap)</div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">API Key</div><div class="key-row-desc">openweathermap.org</div></div>
            <div class="key-input-wrap"><input class="key-input" type="password" id="key-weather-key" placeholder="abc123…" oninput="markKeyDirty('weather-key')"><button class="key-eye" onclick="toggleKeyVis('key-weather-key',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button></div>
            <div class="key-save-dot" id="dot-weather-key"></div>
          </div>
          <div class="key-row">
            <div style="width:168px;flex-shrink:0;min-width:0;overflow:hidden"><div class="key-row-label">Default City</div><div class="key-row-desc">Fallback location</div></div>
            <div class="key-input-wrap"><input class="key-input" type="text" id="key-weather-city" placeholder="Melbourne" oninput="markKeyDirty('weather-city')"></div>
            <div class="key-save-dot" id="dot-weather-city"></div>
          </div>
        </div>

        <div style="font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx4);margin:24px 0 14px;padding:8px 12px;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;display:flex;align-items:center;gap:6px"><span style="width:3px;height:12px;background:var(--acc);border-radius:2px;display:inline-block"></span>Custom</div>

        <!-- Custom Keys -->
        <div class="stab-group">
          <div class="stab-group-title" style="display:flex;align-items:center;justify-content:space-between">
            Custom Keys
            <button class="btn btn-ghost" style="font-size:10px;height:24px;padding:0 8px" onclick="addCustomKeyRow()">+ Add</button>
          </div>
          <div id="custom-keys-list"></div>
        </div>
      </div>

      <!-- SYSTEM -->
      <div class="stab-pane" id="stab-system">
        <div class="stab-hero">
          <div class="stab-hero-text">
            <div class="stab-title">System</div>
            <div class="stab-sub">Forge runtime health and session diagnostics</div>
          </div>
          <button class="btn btn-ghost" style="font-size:11px" onclick="loadSystemStats()">Refresh</button>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Runtime Metrics</div>
          <div class="sys-stat-grid">
            <div class="sys-stat-card"><div class="sys-stat-card-val" id="sys-tasks-total">—</div><div class="sys-stat-card-lbl">Total tasks logged</div></div>
            <div class="sys-stat-card"><div class="sys-stat-card-val" id="sys-mem-count">—</div><div class="sys-stat-card-lbl">Memory entries</div></div>
            <div class="sys-stat-card"><div class="sys-stat-card-val" id="sys-learnings">—</div><div class="sys-stat-card-lbl">Learnings saved</div></div>
            <div class="sys-stat-card"><div class="sys-stat-card-val" id="sys-hb-count">—</div><div class="sys-stat-card-lbl">Heartbeats recorded</div></div>
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Service Status</div>
          <div class="sys-status-row">
            <div style="display:flex;align-items:center;gap:8px"><div class="sys-status-dot" style="background:var(--green);box-shadow:0 0 6px rgba(22,163,74,.5)"></div><div class="sys-status-key">Gateway API</div></div>
            <div class="sys-status-val" id="sys-api-status">Checking…</div>
          </div>
          <div class="sys-status-row">
            <div style="display:flex;align-items:center;gap:8px"><div class="sys-status-dot" id="sys-db-dot" style="background:var(--tx4)"></div><div class="sys-status-key">forge.db (SQLite)</div></div>
            <div class="sys-status-val" id="sys-db-status">—</div>
          </div>
          <div class="sys-status-row">
            <div style="display:flex;align-items:center;gap:8px"><div class="sys-status-dot" id="sys-daemon-dot" style="background:var(--tx4)"></div><div class="sys-status-key">Daemon (port 2079)</div></div>
            <div class="sys-status-val" id="sys-daemon-status">—</div>
          </div>
        </div>
        <div class="stab-group">
          <div class="stab-group-title">Session</div>
          <div class="sys-status-row">
            <div class="sys-status-key">Dashboard version</div>
            <div class="sys-status-val">v1</div>
          </div>
          <div class="sys-status-row">
            <div class="sys-status-key">DB path</div>
            <div class="sys-status-val" style="font-size:10px">~/.forge/forge.db</div>
          </div>
          <div class="sys-status-row">
            <div class="sys-status-key">Brain path</div>
            <div class="sys-status-val" style="font-size:10px">~/Forge/.forge_brain/core/</div>
          </div>
        </div>
      </div>

    </div><!-- end settings-content -->
  </div><!-- end settings-layout -->
</div>

  </main>

  <!-- RIGHT PANEL -->
  <aside class="panel">

    <div class="panel-section">
      <div class="panel-title">Status</div>
      <div class="metric-row"><span class="metric-key">Memories</span><span class="metric-val" id="p-mem">—</span></div>
      <div class="metric-row"><span class="metric-key">Tasks done</span><span class="metric-val" id="p-tasks">—</span></div>
      <div class="metric-row"><span class="metric-key">Agents</span><span class="metric-val" id="p-agents">—</span></div>
      <div class="metric-row"><span class="metric-key">Model</span><span class="metric-val" id="p-model" style="font-size:10px;color:var(--tx3)">—</span></div>
    </div>

    <div class="panel-section">
      <div class="panel-title">Quick actions</div>
      <div class="panel-nav">
        <button class="panel-nav-item" onclick="quickAction('What can you do? Give me a brief overview of your capabilities.')">Capabilities overview<span class="panel-nav-chevron">›</span></button>
        <button class="panel-nav-item" onclick="quickAction('Find me a revenue opportunity I can ship this week.')">Revenue scan<span class="panel-nav-chevron">›</span></button>
        <button class="panel-nav-item" onclick="quickAction('Research the top 5 AI tools or trends this week.')">AI research<span class="panel-nav-chevron">›</span></button>
        <button class="panel-nav-item" onclick="quickAction('What did we work on recently? Give me a recap.')">Today recap<span class="panel-nav-chevron">›</span></button>
        <button class="panel-nav-item" onclick="quickAction('Check and summarise my email inbox.')">Check email<span class="panel-nav-chevron">›</span></button>
      </div>
    </div>

    <div class="panel-section" id="channel-panel" style="display:none">
      <div class="panel-title">Channels</div>
      <div style="font-size:11px;color:var(--tx3);margin-bottom:10px">Configure in terminal:<br><code style="font-family:var(--font-m);color:var(--acc);font-size:10px">forge setup</code></div>
      <div class="metric-row">
        <span class="metric-key">Telegram</span>
        <span class="badge" id="tg-status">—</span>
      </div>
      <div class="metric-row">
        <span class="metric-key">Discord</span>
        <span class="badge" id="dc-status">—</span>
      </div>
    </div>

  </aside>

</div><!-- end .layout -->

<!-- TASK DETAIL MODAL -->
<div class="overlay" id="task-detail-modal" onclick="if(event.target===this)closeOverlay('task-detail-modal')">
  <div class="modal" style="max-width:480px;width:100%">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-title">Task Detail</div>
        <div class="modal-sub" id="td-created-wrap" style="margin:0">Created: <span id="td-created">—</span></div>
      </div>
      <button class="modal-close" onclick="closeOverlay('task-detail-modal')">✕</button>
    </div>
    <div class="field">
      <label>Title</label>
      <input id="td-title" placeholder="Task title" style="font-size:13px;font-weight:600">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea id="td-description" placeholder="Details, context, notes…" style="min-height:72px"></textarea>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field" style="margin-bottom:0">
        <label>Priority</label>
        <div class="priority-chips" id="td-priority-chips">
          <div class="priority-chip" data-val="P1 Critical" onclick="selectPriorityChip(this)">Critical</div>
          <div class="priority-chip" data-val="P2 High" onclick="selectPriorityChip(this)">High</div>
          <div class="priority-chip active" data-val="P3 Normal" onclick="selectPriorityChip(this)">Normal</div>
          <div class="priority-chip" data-val="P4 Low" onclick="selectPriorityChip(this)">Low</div>
        </div>
        <input type="hidden" id="td-priority" value="P3 Normal">
      </div>
      <div class="field" style="margin-bottom:0">
        <label>Status</label>
        <div id="td-status-display" style="padding:9px 12px;background:var(--bg3);border:1px solid var(--bd);border-radius:7px;font-size:12px;font-weight:500;color:var(--tx3);cursor:default;user-select:none">—</div>
        <input type="hidden" id="td-status" value="pending">
      </div>
    </div>
    <div class="field" style="margin-top:14px">
      <label>Assignee</label>
      <div class="assignee-chips" id="td-assignee-chips"></div>
      <input type="hidden" id="td-assignee" value="FORGE">
    </div>
    <div class="field">
      <label>ETA <span style="font-size:9px;color:var(--tx4);text-transform:none;letter-spacing:0;font-weight:400">optional</span></label>
      <input id="td-eta" type="datetime-local">
    </div>
    <div class="modal-actions" style="justify-content:space-between">
      <button class="btn btn-ghost" style="color:var(--red)" onclick="deleteTaskDetail()">Delete</button>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="closeOverlay('task-detail-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTaskDetail()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- NEW TASK MODAL -->
<div class="overlay" id="new-task-modal" onclick="if(event.target===this)closeOverlay('new-task-modal')">
  <div class="modal" style="max-width:440px;width:100%">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-title">New Task</div>
        <div class="modal-sub" style="margin-bottom:0">Add a task to the backlog</div>
      </div>
      <button class="modal-close" onclick="closeOverlay('new-task-modal')">✕</button>
    </div>
    <div class="field">
      <label>Title <span style="color:var(--red);text-transform:none;letter-spacing:0">*</span></label>
      <input id="nt-title" placeholder="What needs to be done?">
    </div>
    <div class="field">
      <label>Description</label>
      <textarea id="nt-description" placeholder="Optional details…"></textarea>
    </div>
    <div class="field">
      <label>Priority</label>
      <div class="priority-chips" id="nt-priority-chips">
        <div class="priority-chip" data-val="P1 Critical" onclick="selectPriorityChip(this)">Critical</div>
        <div class="priority-chip" data-val="P2 High" onclick="selectPriorityChip(this)">High</div>
        <div class="priority-chip active" data-val="P3 Normal" onclick="selectPriorityChip(this)">Normal</div>
        <div class="priority-chip" data-val="P4 Low" onclick="selectPriorityChip(this)">Low</div>
      </div>
      <input type="hidden" id="nt-priority" value="P3 Normal">
    </div>
    <div class="field">
      <label>Assignee</label>
      <div class="assignee-chips" id="nt-assignee-chips"></div>
      <input type="hidden" id="nt-assignee" value="FORGE">
    </div>
    <div class="field">
      <label>ETA <span style="font-size:9px;color:var(--tx4);text-transform:none;letter-spacing:0;font-weight:400">optional</span></label>
      <input id="nt-eta" type="datetime-local">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeOverlay('new-task-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="createNewTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- COMMAND PALETTE -->
<div class="cmd-overlay" id="cmd-palette" onclick="if(event.target===this)closeCmdPalette()">
  <div class="cmd-box">
    <div class="cmd-input-wrap">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="6.5" cy="6.5" r="4.5"/><path d="M10.5 10.5l3 3" stroke-linecap="round"/></svg>
      <input class="cmd-input" id="cmd-input" placeholder="Search commands, tasks, agents…" oninput="renderCmdResults(this.value)" onkeydown="handleCmdKey(event)">
      <span class="cmd-kbd">Esc</span>
    </div>
    <div class="cmd-results" id="cmd-results"></div>
  </div>
</div>

<!-- SPAWN MODAL -->
<div class="overlay" id="spawn-modal" onclick="if(event.target===this)closeOverlay('spawn-modal')">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-title">Spawn Agent</div>
        <div class="modal-sub" style="margin-bottom:0">Forge generates the system prompt automatically</div>
      </div>
      <button class="modal-close" onclick="closeOverlay('spawn-modal')">✕</button>
    </div>
    <div class="field">
      <label>Agent Name</label>
      <input id="spawn-name" placeholder="e.g. TITAN, ARIA, PRISM">
    </div>
    <div class="field">
      <label>Role</label>
      <input id="spawn-role" placeholder="e.g. CTO, Content Strategist, Revenue Analyst">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field" style="margin-bottom:0">
        <label>Provider</label>
        <select id="spawn-provider">
          <option value="anthropic">Anthropic</option>
          <option value="openai">OpenAI</option>
          <option value="google">Google</option>
          <option value="kimi">Kimi (Moonshot AI)</option>
        </select>
      </div>
      <div class="field" style="margin-bottom:0">
        <label>Model</label>
        <select id="spawn-model">
          <option value="claude-sonnet-4-6">Claude Sonnet 4</option>
          <option value="claude-opus-4-6">Claude Opus 4</option>
          <option value="claude-haiku-4-5-20251001">Claude Haiku 4</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeOverlay('spawn-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="spawnAgent()">Spawn Agent</button>
    </div>
  </div>
</div>

<!-- SAVED TOAST -->
<div class="saved-toast" id="saved-toast">
  <span class="saved-toast-icon">✓</span>
  <span id="saved-toast-msg">Settings saved</span>
</div>

<script>
// ══════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════
let curAgent    = 'FORGE';
document.addEventListener('DOMContentLoaded', () => { const vc = document.getElementById('view-chat'); if(vc) vc.dataset.agent = 'FORGE'; });
let curModel    = '';
let curProvider = 'anthropic';
let agents    = [];
const API = 'http://localhost:2079';

// Auto theme: dark from 7pm–7am, light otherwise. Manual override stored in localStorage.
function getAutoTheme() {
  const h = new Date().getHours();
  return (h >= 19 || h < 7) ? 'dark' : 'light';
}
function applyTheme(t, manual) {
  theme = t;
  document.body.setAttribute('data-theme', t);
  if (manual) localStorage.setItem('forge-theme', t);
  // sync Appearance previews
  const pl = document.getElementById('prev-light');
  const pd = document.getElementById('prev-dark');
  if (pl) pl.classList.toggle('selected', t === 'light');
  if (pd) pd.classList.toggle('selected', t === 'dark');
}
const savedTheme = localStorage.getItem('forge-theme');
let theme = savedTheme || getAutoTheme();
applyTheme(theme, false);
// Re-evaluate every 5 minutes — only auto-switch if no manual override
setInterval(() => {
  if (!localStorage.getItem('forge-theme')) applyTheme(getAutoTheme(), false);
}, 5 * 60 * 1000);

// ══════════════════════════════════════════
//  API
// ══════════════════════════════════════════
async function api(path, body) {
  const opts = body
    ? { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) }
    : { method:'GET' };
  const r = await fetch(API + path, opts);
  return r.json();
}

// ══════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════
async function init() {
  await loadStatus();
  await loadAgents();
  populateModels();
  setInterval(loadStatus, 15000);
  setInterval(loadMissionControl, 4000); // auto-refresh MC every 4s (real-time tasks)
  loadMissionControl();
}

async function loadStatus() {
  const d = await api('/status').catch(()=>({error:true}));
  if (d.error) return;
  const memEl    = document.getElementById('s-mem');
  const tasksEl  = document.getElementById('s-tasks');
  const agentsEl = document.getElementById('s-agents');
  if (memEl)    animateNumber(memEl,    d.memories||0);
  if (tasksEl)  animateNumber(tasksEl,  d.tasks||0);
  if (agentsEl) animateNumber(agentsEl, d.agents||1);
  document.getElementById('p-mem').textContent    = (d.memories||0).toLocaleString();
  document.getElementById('p-tasks').textContent  = d.tasks||0;
  document.getElementById('p-agents').textContent = d.agents||1;
  document.getElementById('p-model').textContent  = d.primary_model || '—';
  document.getElementById('cfg-owner').value         = d.owner || '';
  const activeModel = d.primary_model || curModel || '—';
  document.getElementById('cfg-primary-model').value = activeModel;
  const curModelLabel = document.getElementById('cfg-current-model-label');
  if (curModelLabel) curModelLabel.textContent = activeModel;

  // Update profile hero
  updateProfileHero(d.owner);
  const aiNameEl   = document.getElementById('cfg-ai-name');
  const brandNameEl = document.getElementById('cfg-brand-name');
  const workspaceEl = document.getElementById('profile-workspace-label');
  if (aiNameEl)    aiNameEl.value   = d.name || 'Forge';
  if (brandNameEl) brandNameEl.value = d.name || 'Forge';
  if (workspaceEl) workspaceEl.textContent = `${d.name || 'Forge'} Workspace · ${d.provider || 'AI'}`;

  // Render model cards for this provider
  if (d.provider) {
    curProvider = d.provider;
    curModel    = d.primary_model || curModel;
    renderModelCards(d.provider, d.primary_model);
    populateModels(); // refresh chat model selector to show only this provider's models
  }
  // Update hidden usage elements (kept for compatibility)
  const uModel = document.getElementById('usage-model');
  const uProv  = document.getElementById('usage-provider');
  const uMem   = document.getElementById('usage-memories');
  const uAg    = document.getElementById('usage-agents');
  const uTasks = document.getElementById('usage-tasks');
  if (uModel) uModel.textContent = d.primary_model || '—';
  if (uProv)  uProv.textContent  = d.provider || '—';
  if (uMem)   uMem.textContent   = d.memories || 0;
  if (uAg)    uAg.textContent    = d.agents || 1;
  if (uTasks) uTasks.textContent = d.tasks || 0;
  // Update model badge in Mission Control header
  const mcBadge = document.getElementById('mc-model-badge');
  if (mcBadge && d.primary_model) mcBadge.textContent = d.primary_model;

  // Update agent name everywhere dynamically
  const agentName = (d.name || 'FORGE').toUpperCase();
  const providerLabel = d.provider ? `${d.provider} · ${d.primary_model || ''}` : 'active';
  const sidebarName = document.getElementById('sidebar-agent-name');
  const sidebarRole = document.getElementById('sidebar-agent-role');
  const chatName    = document.getElementById('chat-agent-name');
  window._forgeName = agentName;
  const brandLabel  = document.getElementById('brand-name-label');
  if (brandLabel)  brandLabel.textContent  = agentName;
  if (sidebarName) sidebarName.textContent = agentName;
  if (sidebarRole) sidebarRole.textContent = `Master · ${d.provider || 'active'}`;
  if (chatName && chatName.dataset.locked !== 'true') chatName.textContent = agentName;
  const emptyTitle = document.getElementById('empty-agent-title');
  if (emptyTitle) emptyTitle.textContent = agentName;

  // Heartbeat toggles + channel badges — use /config (not /status which lacks channels)
  const cfg = await api('/config').catch(()=>({}));
  const hb  = cfg.heartbeat || {};
  const tg = !!(cfg.channels?.telegram?.bot_token && cfg.channels?.telegram?.user_id);
  const dc = !!(cfg.channels?.discord?.webhook_url || cfg.channels?.discord?.bot_token);
  const tgEl = document.getElementById('tg-status');
  const dcEl = document.getElementById('dc-status');
  if (tgEl) { tgEl.className = 'badge ' + (tg ? 'badge-ok' : 'badge-pending'); tgEl.textContent = tg ? 'active' : 'not set'; }
  if (dcEl) { dcEl.className = 'badge ' + (dc ? 'badge-ok' : 'badge-pending'); dcEl.textContent = dc ? 'active' : 'not set'; }
  const hbEl = document.getElementById('hb-toggle');
  const hbNEl = document.getElementById('hb-notify-toggle');
  if (hbEl)  hbEl.className  = 'toggle' + (hb.enabled !== false ? ' on' : '');
  // notify_telegram defaults OFF — only on if user explicitly toggled it on this session
  const notifyPref = localStorage.getItem('forge-hb-notify');
  if (hbNEl) hbNEl.className = 'toggle' + (notifyPref === '1' ? ' on' : '');

  // Model selector — set current
  if (d.primary_model && !curModel) curModel = d.primary_model;
}

function populateModels() {
  const sel = document.getElementById('model-select');
  if (!sel) return;
  const modelSets = {
    anthropic: [
      { v:'claude-haiku-4-5-20251001', l:'Haiku 4 — Fast' },
      { v:'claude-sonnet-4-6',         l:'Sonnet 4 — Balanced' },
      { v:'claude-opus-4-6',           l:'Opus 4 — Most Capable' },
    ],
    openai: [
      { v:'gpt-4o',          l:'GPT-4o' },
      { v:'gpt-4.5',         l:'GPT-4.5' },
      { v:'gpt-5.2',         l:'GPT-5.2' },
      { v:'gpt-5.2-codex',   l:'GPT-5.2 Codex' },
    ],
    google: [
      { v:'gemini-3.1-pro-preview', l:'Gemini 3.1 Pro Preview' },
      { v:'gemini-3-pro',           l:'Gemini 3 Pro' },
      { v:'gemini-2.5-pro',         l:'Gemini 2.5 Pro' },
      { v:'gemini-2.5-flash',       l:'Gemini 2.5 Flash' },
      { v:'gemini-2.0-flash',       l:'Gemini 2.0 Flash' },
      { v:'gemini-1.5-pro',         l:'Gemini 1.5 Pro' },
    ],
    kimi: [
      { v:'kimi-k2',          l:'Kimi K2 — Flagship' },
      { v:'kimi-k2-thinking', l:'Kimi K2 Thinking — Reasoning' },
      { v:'kimi-k2.5',        l:'Kimi K2.5 — Latest' },
    ],
  };
  const models = modelSets[curProvider] || modelSets.anthropic;
  sel.innerHTML = models.map(m =>
    `<option value="${m.v}" ${m.v===curModel?'selected':''}>${m.l}</option>`
  ).join('');
  sel.onchange = () => { curModel = sel.value; };
}

async function loadAgents() {
  agents = await api('/agents').catch(()=>[]);
  const list = document.getElementById('agent-list');
  list.innerHTML = agents.map(a => {
    const taskCount = mcTasks.filter(t => ['pending','in_progress','running'].includes(t.status) && (t.assignee||t.agent) === a.name).length;
    const pct = Math.min((taskCount / 5) * 100, 100);
    const barColor = taskCount === 0 ? 'var(--green)' : taskCount <= 2 ? 'var(--amber)' : 'var(--red)';
    const accentColor = a.color || 'var(--accent)';
    const emoji = a.emoji || '🤖';
    return `<button class="agent-item" id="ag-${a.name}" onclick="selectAgent('${a.name}',this)">
      <div style="width:28px;height:28px;border-radius:8px;background:${accentColor}22;border:1px solid ${accentColor}44;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0">${emoji}</div>
      <div style="flex:1;min-width:0">
        <div class="agent-name">${a.name}</div>
        <div class="agent-role">${a.role||''}</div>
        <div class="agent-load"><div class="agent-load-fill" style="width:${pct}%;background:${barColor}"></div></div>
      </div>
    </button>`;
  }).join('');

  // Refresh agents view if open
  if (document.getElementById('view-agents')?.classList.contains('visible')) loadAgentsView();
}

function selectAgent(name, btn) {
  curAgent = name;
  document.getElementById('view-chat').dataset.agent = name.toLowerCase();
  document.querySelectorAll('.agent-item').forEach(b => b.classList.remove('active'));
  const el = document.getElementById('ag-' + name);
  if (el) el.classList.add('active');

  const a = agents.find(x=>x.name===name) || {role:'Master', model: curModel};
  document.getElementById('chat-agent-name').textContent = name;
  document.getElementById('chat-agent-sub').textContent  = name === 'FORGE' ? 'Autonomous Execution Engine' : `${a.role||'Agent'}`;
  // Sync model selector to this agent's model
  const agentModel = name === 'FORGE' ? curModel : (a.model || curModel);
  const sel = document.getElementById('model-select');
  if (sel && agentModel) sel.value = agentModel;

  switchView('chat');
  loadHistory();
}

async function onModelSelectChange(model) {
  curModel = model;
  await saveAgentModel(curAgent, model, curProvider);
}

// ══════════════════════════════════════════
//  FIRST-RUN HATCH SEQUENCE
// ══════════════════════════════════════════
function playHatchSequence() {
  const messages = document.getElementById('messages');
  const empty    = document.getElementById('empty-state');
  if (!messages || !empty) return;

  empty.style.display = 'none';
  messages.style.display = 'flex';
  messages.innerHTML = '';

  const lines = [
    { text: '🐣 <strong>POP</strong>',                    delay: 0    },
    { text: 'who am i? and tell me about yourself?',       delay: 1400 },
  ];

  lines.forEach(({ text, delay }) => {
    setTimeout(() => {
      const html = `
        <div class="msg" style="animation:msgIn .22s ease">
          <div class="msg-avatar cortex-av">CX</div>
          <div class="msg-body">
            <div class="msg-bubble">${text}</div>
          </div>
        </div>`;
      messages.insertAdjacentHTML('beforeend', html);
      messages.scrollTop = messages.scrollHeight;
    }, delay);
  });

  setTimeout(() => {
    const inp = document.getElementById('input-field');
    if (inp) {
      inp.placeholder = 'tell me who you are and what we\'re building…';
      inp.focus();
    }
  }, 2800);
}

// ══════════════════════════════════════════
//  CHAT
// ══════════════════════════════════════════
async function loadHistory() {
  const msgs = await api(`/history?agent=${curAgent}&limit=30`).catch(()=>[]);
  const container = document.getElementById('messages');
  const empty     = document.getElementById('empty-state');

  if (!msgs.length) {
    // First-run hatch sequence — plays once
    if (!localStorage.getItem('forge_hatched') && curAgent === 'FORGE') {
      localStorage.setItem('forge_hatched', '1');
      playHatchSequence();
      return;
    }
    container.style.display = 'none';
    empty.style.display     = 'flex';
    return;
  }

  empty.style.display     = 'none';
  container.style.display = 'flex';
  container.innerHTML = msgs.map(m => renderMsg(m.role, m.content, m.timestamp)).join('');
  container.scrollTop = container.scrollHeight;
}

function renderMsg(role, content, ts) {
  const isUser = role === 'user';
  const displayName = isUser ? 'You' : curAgent;
  const t = ts ? new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
  const html = content
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\n/g,'<br>');

  const av = isUser
    ? `<div class="msg-avatar user-av">You</div>`
    : `<div class="msg-avatar cortex-av">CX</div>`;

  return `<div class="msg ${isUser?'from-user':''}">
    ${av}
    <div class="msg-body">
      <div class="msg-bubble">${html}</div>
      <div class="msg-time">${displayName} · ${t}</div>
    </div>
  </div>`;
}

async function sendMessage() {
  const field = document.getElementById('input-field');
  const text  = field.value.trim();
  if (!text) return;

  field.value = '';
  autoResize(field);

  const container = document.getElementById('messages');
  const empty     = document.getElementById('empty-state');
  empty.style.display     = 'none';
  container.style.display = 'flex';

  // Add user message
  container.innerHTML += renderMsg('user', text, new Date().toISOString());
  container.scrollTop = container.scrollHeight;

  // Typing indicator
  const tid = 'typing-' + Date.now();
  container.innerHTML += `<div class="msg" id="${tid}">
    <div class="msg-avatar forge-av">
      <svg width="14" height="14" viewBox="0 0 28 28" fill="white">
        <path d="M7 20h14v2H7v-2z"/><path d="M8 18l2-6h8l2 6H8z"/>
        <path d="M11 12V9h4v3"/>
      </svg>
    </div>
    <div class="msg-body"><div class="msg-bubble"><div class="typing-dots"><span></span><span></span><span></span></div></div></div>
  </div>`;
  container.scrollTop = container.scrollHeight;

  try {
    const body = { message: text, agent: curAgent };
    if (curModel) body.model = curModel;
    // Route to agent-specific endpoint when a permanent agent is selected
    const endpoint = (curAgent && curAgent !== 'FORGE') ? '/agent-chat' : '/chat';
    const result = await api(endpoint, body);
    document.getElementById(tid)?.remove();
    const resp = result.response || 'Something went wrong.';
    container.innerHTML += renderMsg('assistant', resp, new Date().toISOString());
  } catch {
    document.getElementById(tid)?.remove();
    container.innerHTML += renderMsg('assistant', 'Forge is not responding. Check if it is running with forge status.', new Date().toISOString());
  }

  container.scrollTop = container.scrollHeight;
  await loadStatus();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function quickAction(text) {
  document.getElementById('input-field').value = text;
  switchView('chat');
  setTimeout(sendMessage, 80);
}

// ══════════════════════════════════════════
//  VIEWS
// ══════════════════════════════════════════
function switchView(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('visible'));
  const vw = document.getElementById('view-' + name);
  if (vw) {
    // Force animation reset so viewEnter plays on every switch
    vw.style.animation = 'none';
    vw.offsetHeight; // trigger reflow
    vw.style.animation = '';
    vw.classList.add('visible');
  }

  ['mission','chat','memory','heartbeat','channels','alarms','skills','settings'].forEach(n => {
    const nb = document.getElementById('nav-' + n);
    if (nb) nb.classList.remove('active');
  });
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');

  if (name === 'memory')    loadMemory();
  if (name === 'heartbeat') loadHeartbeats();
  if (name === 'settings')  { loadStatus(); updateSettingsStatusBadges(); loadSystemStats(); }
  if (name === 'mission')   loadMissionControl();
  if (name === 'channels')  loadChannelStatuses();
  if (name === 'alarms')    loadAlarms();
  if (name === 'skills')    loadSkillsView();
}

// ══════════════════════════════════════════
//  HEARTBEAT
// ══════════════════════════════════════════
async function loadHeartbeats() {
  const raw = await api('/heartbeats').catch(()=>[]);
  const data = Array.isArray(raw) ? raw : (Array.isArray(raw?.heartbeats) ? raw.heartbeats : (Array.isArray(raw?.data) ? raw.data : []));
  const recent = data.slice(0, 20);
  const total  = data.length;
  const warns  = data.filter(h => h.status === 'warn' || h.status === 'error').length;
  const upPct  = total > 0 ? Math.round(((total - warns) / total) * 100) : 100;

  const uptimeEl = document.getElementById('hb-uptime-val');
  const totalEl  = document.getElementById('hb-total-val');
  const warnEl   = document.getElementById('hb-warn-val');
  if (uptimeEl) uptimeEl.textContent = total > 0 ? upPct + '%' : '—';
  if (totalEl)  totalEl.textContent  = total > 0 ? total : '—';
  if (warnEl)   warnEl.textContent   = total > 0 ? warns : '—';

  const svg = document.getElementById('hb-svg');
  const pts = data.slice(0, 48).reverse();
  if (svg && pts.length > 1) {
    const w = 800, h = 120, pad = 10;
    const step = (w - pad * 2) / (pts.length - 1);
    const colorMap = { ok: 'var(--green)', warn: 'var(--amber)', error: 'var(--red)' };
    const yMap = { ok: h * 0.8, warn: h * 0.5, error: h * 0.2 };
    const coords = pts.map((p, i) => ({
      x: pad + i * step,
      y: yMap[p.status] ?? h * 0.8,
      status: p.status
    }));
    const polyPts = coords.map(c => `${c.x},${c.y}`).join(' ');
    const fillPts = `${pad},${h} ` + polyPts + ` ${pad + (pts.length-1)*step},${h}`;
    svg.innerHTML = `
      <defs>
        <linearGradient id="hbGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--green)" stop-opacity="0.3"/>
          <stop offset="100%" stop-color="var(--green)" stop-opacity="0"/>
        </linearGradient>
      </defs>
      <polygon points="${fillPts}" fill="url(#hbGrad)"/>
      <polyline points="${polyPts}" fill="none" stroke="var(--green)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
      ${coords.map(c => `<circle cx="${c.x}" cy="${c.y}" r="3.5" fill="${colorMap[c.status] || 'var(--green)'}" stroke="var(--sur)" stroke-width="1.5"/>`).join('')}
    `;
  } else if (svg) {
    svg.innerHTML = `<text x="400" y="60" text-anchor="middle" fill="var(--tx2)" font-size="12">No data yet</text>`;
  }

  const listEl = document.getElementById('hb-recent-list');
  if (listEl) {
    listEl.innerHTML = recent.length
      ? recent.map(h => {
          const dotColor = h.status === 'ok' ? 'var(--green)' : h.status === 'warn' ? 'var(--amber)' : 'var(--red)';
          const notes = h.notes ? (() => { try { return JSON.parse(h.notes).join(', '); } catch(e) { return h.notes; } })() : '';
          return `<div class="hb-recent-row">
            <div class="hb-recent-status">
              <div class="hb-recent-dot" style="background:${dotColor}"></div>
              ${h.status === 'ok' ? 'Beating' : h.status === 'warn' ? 'Weak Pulse' : h.status === 'error' ? 'Flatline' : 'Beating'}${notes ? ` — <span style="color:var(--tx2);font-weight:400">${notes}</span>` : ''}
            </div>
            <div class="hb-recent-time">${(h.timestamp||'').slice(0,16).replace('T',' ')}</div>
          </div>`;
        }).join('')
      : '<div class="no-data">No heartbeat data yet. Forge checks every 30 minutes.</div>';
  }

  renderHeartbeatTimeline(data);

  // Last heartbeat + next scheduled
  const last = data[0];
  const lastStatusEl = document.getElementById('hb-last-status');
  if (lastStatusEl) {
    if (last) {
      const ts = (last.timestamp || '').slice(0, 16).replace('T', ' ');
      lastStatusEl.textContent = ts || last.status;
      lastStatusEl.className = 'badge ' + (last.status === 'ok' ? 'badge-ok' : last.status === 'warn' ? 'badge-warn' : 'badge-error');
    } else {
      lastStatusEl.textContent = 'No data yet';
      lastStatusEl.className = 'badge badge-pending';
    }
  }
  const nextEl = document.getElementById('hb-next');
  const nextLabelEl = document.getElementById('hb-next-label');
  if (last && last.timestamp) {
    const nextTime = new Date(new Date(last.timestamp).getTime() + 30 * 60 * 1000);
    const now = new Date();
    const diffMs = nextTime - now;
    if (diffMs > 0) {
      const mins = Math.round(diffMs / 60000);
      const timeStr = nextTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      if (nextEl) nextEl.textContent = `in ${mins}m (${timeStr})`;
      if (nextLabelEl) nextLabelEl.textContent = `Next: ${timeStr}`;
    } else {
      if (nextEl) nextEl.textContent = 'due now';
      if (nextLabelEl) nextLabelEl.textContent = 'Next: due now';
    }
  } else {
    if (nextEl) nextEl.textContent = '—';
    if (nextLabelEl) nextLabelEl.textContent = 'Next: —';
  }
}

async function toggleHeartbeat(key) {
  if (key === 'enabled') {
    const btn = document.getElementById('hb-toggle');
    const isOn = btn?.classList.contains('on');
    await api('/heartbeat/toggle', { enabled: !isOn }).catch(()=>{});
    if (btn) btn.className = 'toggle' + (!isOn ? ' on' : '');
  } else if (key === 'notify_telegram') {
    // Daemon has no endpoint for this — store preference locally
    const btn = document.getElementById('hb-notify-toggle');
    const isOn = btn?.classList.contains('on');
    const next = !isOn;
    if (btn) btn.className = 'toggle' + (next ? ' on' : '');
    localStorage.setItem('forge-hb-notify', next ? '1' : '0');
  }
}

// ══════════════════════════════════════════
//  SETTINGS
// ══════════════════════════════════════════
async function saveSettings() {
  const owner = document.getElementById('cfg-owner')?.value.trim();
  if (owner) await api('/config/update', { owner });
  // Save active model if changed
  if (curModel && curProvider) {
    await api('/model/change', { provider: curProvider, model: curModel }).catch(()=>{});
  }
  showSavedToast('Settings saved');
  const tsEl = document.getElementById('profile-saved-ts');
  if (tsEl) tsEl.textContent = 'Saved ' + new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  loadStatus();
}

function selectModelCard(el) {
  document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  const model = el.dataset.model;
  const modelEl = document.getElementById('cfg-primary-model');
  if (modelEl) modelEl.textContent = model;
  curModel = model;
  const sel = document.getElementById('model-select');
  if (sel) sel.value = model;
}

function loadSystemStats() {
  // Check API + tasks
  api('/tasks').then(d => {
    const el = document.getElementById('sys-tasks-total'); if(el) el.textContent = Array.isArray(d) ? d.length : '—';
    const s = document.getElementById('sys-api-status'); if(s) s.textContent = 'Connected';
    const dot = document.querySelector('#stab-system .sys-status-row:first-child .sys-status-dot');
    if(dot) { dot.style.background='var(--green)'; dot.style.boxShadow='0 0 6px rgba(22,163,74,.5)'; }
  }).catch(() => {
    const s = document.getElementById('sys-api-status'); if(s) s.textContent = 'Offline';
  });
  // Check memory + learnings
  api('/memory').then(d => {
    const mem = d.memories ? d.memories.length : 0;
    const learn = d.learnings ? d.learnings.length : 0;
    const me = document.getElementById('sys-mem-count'); if(me) me.textContent = mem;
    const le = document.getElementById('sys-learnings'); if(le) le.textContent = learn;
    const dot = document.getElementById('sys-db-dot');
    if(dot) { dot.style.background='var(--green)'; dot.style.boxShadow='0 0 6px rgba(22,163,74,.5)'; }
    const ds = document.getElementById('sys-db-status'); if(ds) ds.textContent = 'Connected';
  }).catch(() => {
    const ds = document.getElementById('sys-db-status'); if(ds) ds.textContent = 'Error';
  });
  // Check heartbeats count
  api('/heartbeats').then(d => {
    const hb = document.getElementById('sys-hb-count'); if(hb) hb.textContent = Array.isArray(d) ? d.length : '—';
  }).catch(() => {});
  // Check daemon
  fetch('http://localhost:2079/ping', {signal: AbortSignal.timeout(2000)}).then(() => {
    const dot = document.getElementById('sys-daemon-dot');
    if(dot) { dot.style.background='var(--green)'; dot.style.boxShadow='0 0 6px rgba(22,163,74,.5)'; }
    const ds = document.getElementById('sys-daemon-status'); if(ds) ds.textContent = 'Running';
  }).catch(() => {
    const ds = document.getElementById('sys-daemon-status'); if(ds) ds.textContent = 'Offline';
  });
}

function showSavedToast(msg) {
  const t = document.getElementById('saved-toast');
  const m = document.getElementById('saved-toast-msg');
  if (!t) return;
  if (m) m.textContent = msg || 'Saved';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function updateProfileHero(val) {
  const nameEl = document.getElementById('profile-display-name');
  const avatarEl = document.getElementById('profile-avatar-initials');
  if (nameEl) nameEl.textContent = val || 'User';
  if (avatarEl) avatarEl.textContent = (val || 'U').charAt(0).toUpperCase();
}

function renderModelCards(provider, currentModel) {
  const grid = document.getElementById('model-cards');
  if (!grid) return;

  const modelSets = {
    anthropic: [
      { id:'claude-haiku-4-5-20251001', name:'Haiku 4',    desc:'Fastest responses. Best for quick tasks.',         badges:[{l:'Fast',c:'mb-fast'},{l:'Low cost',c:''}] },
      { id:'claude-sonnet-4-6',         name:'Sonnet 4',   desc:'Balanced intelligence and speed. Recommended.',    badges:[{l:'Balanced',c:'mb-balance'},{l:'Recommended',c:'mb-smart'}] },
      { id:'claude-opus-4-6',           name:'Opus 4',     desc:'Maximum intelligence. Deep reasoning and strategy.',badges:[{l:'Most capable',c:'mb-smart'},{l:'Premium',c:'badge-gold'}] },
    ],
    openai: [
      { id:'gpt-4.5',                   name:'GPT-4.5',         desc:'Latest GPT generation. Powerful and fast.',        badges:[{l:'Latest',c:'mb-smart'},{l:'Fast',c:'mb-fast'}] },
      { id:'gpt-5.1-codex',             name:'GPT-5.1 Codex',   desc:'Optimised for coding and technical tasks.',        badges:[{l:'Code',c:'mb-balance'},{l:'Technical',c:''}] },
      { id:'gpt-5.2',                   name:'GPT-5.2',         desc:'Most capable OpenAI model. Full intelligence.',    badges:[{l:'Most capable',c:'mb-smart'},{l:'Premium',c:'badge-gold'}] },
      { id:'gpt-5.2-codex',             name:'GPT-5.2 Codex',   desc:'Top Codex variant. Best for autonomous tasks.',    badges:[{l:'Autonomous',c:'mb-smart'},{l:'Codex',c:'mb-balance'}] },
      { id:'gpt-4o',                    name:'GPT-4o',          desc:'Reliable multimodal model.',                       badges:[{l:'Reliable',c:'mb-fast'},{l:'Multimodal',c:''}] },
    ],
    google: [
      { id:'gemini-3.1-pro-preview',    name:'Gemini 3.1 Pro Preview', desc:'Latest Gemini. 2x reasoning vs 3 Pro. Agentic tasks.', badges:[{l:'Latest',c:'mb-smart'},{l:'Most capable',c:'badge-gold'}] },
      { id:'gemini-3-pro',              name:'Gemini 3 Pro',           desc:'State-of-the-art reasoning. Previous gen flagship.',    badges:[{l:'Powerful',c:'mb-smart'},{l:'Stable',c:''}] },
      { id:'gemini-2.5-pro',            name:'Gemini 2.5 Pro',         desc:'Most capable stable Gemini. Complex reasoning.',        badges:[{l:'Stable',c:'mb-balance'},{l:'Recommended',c:'mb-smart'}] },
      { id:'gemini-2.5-flash',          name:'Gemini 2.5 Flash',       desc:'Fast 2.5 generation. Ideal for most tasks.',           badges:[{l:'Fast',c:'mb-fast'},{l:'Efficient',c:''}] },
      { id:'gemini-2.0-flash',          name:'Gemini 2.0 Flash',       desc:'Efficient and quick. Great for real-time tasks.',      badges:[{l:'Fast',c:'mb-fast'},{l:'Low cost',c:''}] },
      { id:'gemini-1.5-pro',            name:'Gemini 1.5 Pro',         desc:'Proven Gemini 1.5 model. Strong general capability.',  badges:[{l:'Reliable',c:'mb-balance'},{l:'Legacy',c:''}] },
    ],
    kimi: [
      { id:'kimi-k2',          name:'Kimi K2',           desc:'Flagship model — 256K context, agentic tasks', badges:[{l:'Flagship',c:'badge-powerful'},{l:'256K',c:'badge-balanced'}] },
      { id:'kimi-k2-thinking', name:'Kimi K2 Thinking',  desc:'Extended reasoning with chain-of-thought',     badges:[{l:'Reasoning',c:'badge-powerful'},{l:'CoT',c:'badge-balanced'}] },
      { id:'kimi-k2.5',        name:'Kimi K2.5',         desc:'Latest generation — improved performance',     badges:[{l:'Latest',c:'badge-fast'},{l:'256K',c:'badge-balanced'}] },
    ],
  };

  const cards = modelSets[provider] || modelSets.anthropic;
  const checkSvg = `<svg width="8" height="8" viewBox="0 0 12 12" fill="white"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

  grid.innerHTML = cards.map(m => {
    const sel = m.id === currentModel ? ' selected' : '';
    const badges = m.badges.map(b => `<span class="model-badge ${b.c}">${b.l}</span>`).join('');
    return `<div class="model-card${sel}" data-model="${m.id}" onclick="selectModelCard(this)">
      <div class="model-card-check">${checkSvg}</div>
      <div class="model-card-name">${m.name}</div>
      <div class="model-card-desc">${m.desc}</div>
      <div class="model-card-badges">${badges}</div>
    </div>`;
  }).join('');
}

function renderHeartbeatTimeline(heartbeats) {
  const el = document.getElementById('hb-timeline-dots');
  if (!el) return;
  const dots = [];
  for (let i = 0; i < 10; i++) {
    const hb = heartbeats[i];
    if (hb) {
      const cls = hb.status === 'ok' ? 'ok' : hb.status === 'warn' ? 'warn' : 'error';
      const clsLabel = hb.status === 'ok' ? 'Beating' : hb.status === 'warn' ? 'Weak Pulse' : 'Flatline';
      const t = (hb.timestamp || '').slice(0, 16);
      dots.push(`<div class="hb-timeline-dot ${cls}" title="${clsLabel} · ${t}"></div>`);
    } else {
      dots.push(`<div class="hb-timeline-dot empty" title="No data"></div>`);
    }
  }
  el.innerHTML = dots.join('');
}

// ══════════════════════════════════════════
//  PARALLEL (legacy stubs — overridden below)
// ══════════════════════════════════════════
function clearParallel() {
  document.querySelectorAll('[id^="pt-"]').forEach(el => el.value = '');
  document.querySelectorAll('[id^="pr-"]').forEach(el => { el.textContent = ''; el.className = 'ptc-response'; });
  document.querySelectorAll('.ptc-card').forEach(c => { c.classList.remove('running','done'); });
  document.querySelectorAll('.ptc-status-dot').forEach(d => d.className = 'ptc-status-dot idle');
  document.querySelectorAll('[id^="ptc-status-"]').forEach(s => s.textContent = 'idle');
  updateParallelProgress(0, 0);
}

// ══════════════════════════════════════════
//  SPAWN
// ══════════════════════════════════════════
async function spawnAgent() {
  const name     = document.getElementById('spawn-name').value.trim().toUpperCase();
  const role     = document.getElementById('spawn-role').value.trim();
  const provider = document.getElementById('spawn-provider').value;
  const model    = document.getElementById('spawn-model').value;
  if (!name || !role) { alert('Name and role are required'); return; }
  closeOverlay('spawn-modal');
  await api('/spawn', { name, role, provider, model });
  await loadAgents();
}

// ══════════════════════════════════════════
//  PANEL
// ══════════════════════════════════════════
function showPanel(name) {
  const cp = document.getElementById('channel-panel');
  if (cp) cp.style.display = name === 'channels' ? 'block' : 'none';
  loadStatus();
}

// ══════════════════════════════════════════
//  OVERLAYS
// ══════════════════════════════════════════
function openOverlay(id)  { document.getElementById(id)?.classList.add('open'); }
function closeOverlay(id) { document.getElementById(id)?.classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(el =>
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); })
);

// ══════════════════════════════════════════
//  THEME
// ══════════════════════════════════════════
function toggleTheme() {
  applyTheme(theme === 'light' ? 'dark' : 'light', true);
}

// ══════════════════════════════════════════
//  AGENTS VIEW
// ══════════════════════════════════════════
async function loadAgentsView() {
  const grid = document.getElementById('agents-grid');
  if (!grid) return;
  const agents = await api('/agents').catch(()=>[]);
  const status = await api('/status').catch(()=>({}));
  const ownerName = status.owner || 'Owner';
  const mainName  = status.name  || 'FORGE';
  const mainModel = status.primary_model || 'claude-sonnet-4-6';
  const mainProv  = status.provider || 'anthropic';

  const allModels = [
    { v:'claude-haiku-4-5-20251001', l:'Claude Haiku 4' },
    { v:'claude-sonnet-4-6',         l:'Claude Sonnet 4' },
    { v:'claude-opus-4-6',           l:'Claude Opus 4' },
    { v:'gpt-4.5',                   l:'GPT-4.5' },
    { v:'gpt-5.1-codex',             l:'GPT-5.1 Codex' },
    { v:'gpt-5.2',                   l:'GPT-5.2' },
    { v:'gpt-5.2-codex',             l:'GPT-5.2 Codex' },
    { v:'gpt-4o',                    l:'GPT-4o' },
    { v:'gemini-3.1-pro-preview',     l:'Gemini 3.1 Pro Preview' },
    { v:'gemini-3-pro',              l:'Gemini 3 Pro' },
    { v:'gemini-2.5-pro',            l:'Gemini 2.5 Pro' },
    { v:'gemini-2.0-flash',          l:'Gemini 2.0 Flash' },
    { v:'gemini-1.5-pro',            l:'Gemini 1.5 Pro' },
  ];

  const modelOptions = (current) => allModels.map(m =>
    `<option value="${m.v}" ${m.v === current ? 'selected' : ''}>${m.l}</option>`
  ).join('');

  const avatarColors = ['#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];

  // Main agent card
  const mainCard = `<div class="agent-detail-card">
    <div class="agent-detail-header">
      <div class="agent-detail-avatar" style="background:${avatarColors[0]}">${mainName.charAt(0)}</div>
      <div>
        <div class="agent-detail-name">${mainName}</div>
        <div class="agent-detail-role">Master Agent · Primary</div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--tx4);margin-bottom:4px">Active model</div>
    <div class="agent-model-row">
      <select class="agent-model-select" id="model-select-FORGE">
        ${modelOptions(mainModel)}
      </select>
      <button class="agent-model-save" onclick="saveAgentModel('FORGE', document.getElementById('model-select-FORGE').value, '${mainProv}')">Save</button>
    </div>
  </div>`;

  // Spawned agent cards
  const spawnedCards = (Array.isArray(agents) ? agents : []).map((a, i) => {
    const col = a.color || avatarColors[(i + 1) % avatarColors.length];
    const emoji = a.emoji || '🤖';
    const domain = a.domain || '';
    const id = `model-select-${a.name}`;
    return `<div class="agent-detail-card" style="border-color:${col}44">
      <div class="agent-detail-header">
        <div class="agent-detail-avatar" style="background:${col}22;border:1px solid ${col}55;color:${col};font-size:18px">${emoji}</div>
        <div>
          <div class="agent-detail-name">${a.name}</div>
          <div class="agent-detail-role" style="color:${col}">${a.role || 'Agent'}</div>
          ${domain ? `<div style="font-size:9px;color:var(--tx4);margin-top:2px">${domain}</div>` : ''}
        </div>
      </div>
      <div style="font-size:10px;color:var(--tx4);margin-bottom:4px">Active model</div>
      <div class="agent-model-row">
        <select class="agent-model-select" id="${id}">
          ${modelOptions(a.model || mainModel)}
        </select>
        <button class="agent-model-save" onclick="saveAgentModel('${a.name}', document.getElementById('${id}').value, '${a.provider || mainProv}')">Save</button>
      </div>
      <div style="margin-top:10px;display:flex;gap:6px">
        <button class="btn btn-ghost" style="font-size:10px;padding:4px 10px;border-color:${col}55;color:${col}" onclick="selectAgent('${a.name}',null);switchView('chat')">Chat →</button>
      </div>
    </div>`;
  });

  grid.innerHTML = mainCard + spawnedCards.join('');
  const sub = document.getElementById('agents-sub');
  if (sub) sub.textContent = `${1 + spawnedCards.length} agent${spawnedCards.length !== 0 ? 's' : ''} · multi-model enabled`;
}

async function saveAgentModel(agentName, model, provider) {
  if (agentName === 'FORGE') {
    await api('/model/change', { provider, model });
    curModel = model; curProvider = provider;
    await loadStatus();
    showSavedToast(`${agentName} → ${model}`);
  } else {
    // Update agent record via spawn endpoint or config update
    await api('/agents/update', { name: agentName, model, provider }).catch(async () => {
      // Fallback: update via config
      await api('/config/update', { [`agent_model_${agentName}`]: model });
    });
    showSavedToast(`${agentName} → ${model}`);
  }
}

// ══════════════════════════════════════════
//  MISSION CONTROL
// ══════════════════════════════════════════
let mcTasks = [];
let mcCurrentTask = null;
let cmdSelIdx = 0;

async function loadMissionControl() {
  const data = await api('/tasks/board').catch(()=>({backlog:[],in_progress:[],completed:[]}));
  mcTasks = [...(data.backlog||[]), ...(data.in_progress||[]), ...(data.completed||[])];
  const total = mcTasks.length;
  const running = mcTasks.filter(t=>['in_progress','running'].includes(t.status)).length;
  const pending = mcTasks.filter(t=>t.status==='pending').length;
  const subEl = document.getElementById('mc-sub');
  if (subEl) subEl.textContent = `${total} tasks · ${running} in progress · ${pending} pending`;
  renderMcAgentGrid();
  renderKanbanBoard(data);
}

function renderMcAgentGrid() {
  const grid = document.getElementById('mc-agent-grid');
  if (!grid) return;
  const taskCounts = {};
  mcTasks.forEach(t => {
    if (['pending','in_progress','running'].includes(t.status)) {
      const key = t.assignee || t.agent || 'FORGE';
      taskCounts[key] = (taskCounts[key] || 0) + 1;
    }
  });
  // Update FORGE sidebar load bar
  const forgeCount = taskCounts['FORGE'] || 0;
  const forgeBar = document.querySelector('#forge-load-bar .agent-load-fill');
  if (forgeBar) {
    const pct = Math.min((forgeCount / 5) * 100, 100);
    const col = forgeCount === 0 ? 'var(--green)' : forgeCount <= 2 ? 'var(--amber)' : 'var(--red)';
    forgeBar.style.width = pct + '%';
    forgeBar.style.background = col;
  }
  // Update spawned agent sidebar load bars (without API refetch)
  agents.forEach(a => {
    const count = taskCounts[a.name] || 0;
    const pct = Math.min((count / 5) * 100, 100);
    const col = count === 0 ? 'var(--green)' : count <= 2 ? 'var(--amber)' : 'var(--red)';
    const btn = document.getElementById('ag-' + a.name);
    if (btn) {
      const fill = btn.querySelector('.agent-load-fill');
      if (fill) { fill.style.width = pct + '%'; fill.style.background = col; }
      const marker = btn.querySelector('.agent-marker');
      if (marker) { marker.style.background = col; marker.style.boxShadow = `0 0 5px ${col}`; }
    }
  });
  const forgeEntry = { name: document.getElementById('sidebar-agent-name')?.textContent || 'FORGE', role:'Master Orchestrator', model: curModel || 'claude-sonnet-4-6', color:'#6366f1', emoji:'⚡', domain:'Orchestration · All Domains' };
  const allAgents = [forgeEntry, ...agents];
  grid.innerHTML = allAgents.map((a, i) => {
    const count = taskCounts[a.name] || 0;
    const status = count === 0 ? 'idle' : count <= 2 ? 'working' : 'busy';
    const statusLabel = { idle:'Idle', working:'Active', busy:'Busy' }[status];
    const pct = Math.min((count / 5) * 100, 100);
    const barColor = status === 'idle' ? 'var(--green)' : status === 'working' ? 'var(--amber)' : 'var(--red)';
    const accentColor = a.color || '#6366f1';
    const emoji = a.emoji || '🤖';
    const domain = a.domain || a.role || 'Agent';
    return `<div class="mc-agent-card" style="animation-delay:${i*0.06}s;border-color:${accentColor}33" onclick="selectAgent('${a.name}',document.getElementById('ag-${a.name}'))">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="width:30px;height:30px;border-radius:8px;background:${accentColor}22;border:1px solid ${accentColor}55;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${emoji}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;font-weight:700;color:var(--tx);letter-spacing:.02em">${a.name}</div>
          <div style="font-size:9px;color:${accentColor};font-weight:500;letter-spacing:.01em">${a.role||'Agent'}</div>
        </div>
        <div class="mc-status-dot ${status}"></div>
      </div>
      <div style="font-size:9px;color:var(--tx4);margin-bottom:10px;letter-spacing:0;line-height:1.4">${domain}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px">
        <span style="font-size:10px;color:var(--tx3)">${statusLabel}</span>
        <span style="font-size:9px;color:var(--tx4);font-family:var(--font-m)">${count}/5</span>
      </div>
      <div class="task-progress-bar"><div class="task-progress-fill" style="width:${pct}%;background:${accentColor}"></div></div>
    </div>`;
  }).join('') + `<div class="mc-agent-card mc-spawn-card" onclick="openOverlay('spawn-modal')">
    <svg width="13" height="13" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 2v12M2 8h12"/></svg>
    Spawn Agent
  </div>`;
}

function renderKanbanBoard(data) {
  const board = document.getElementById('kanban-board');
  if (!board) return;
  const now = Date.now();
  const cols = [
    { key:'backlog',     label:'Backlog',      tasks: data.backlog||[]     },
    { key:'in_progress', label:'In Progress',  tasks: data.in_progress||[] },
    { key:'completed',   label:'Completed',    tasks: data.completed||[]   },
  ];
  board.innerHTML = cols.map(col => {
    const cards = col.tasks.map(t => {
      const age = t.created ? (now - new Date(t.created).getTime()) : 0;
      const ageWarn = col.key === 'backlog' && age > 48 * 3600000;
      const pri = t.priority || 'P3 Normal';
      const priShort = pri.startsWith('P1') ? 'Critical' : pri.startsWith('P2') ? 'High' : pri.startsWith('P4') ? 'Low' : 'Normal';
      const priDotBg = pri.startsWith('P1') ? '#dc2626' : pri.startsWith('P2') ? '#d97706' : pri.startsWith('P4') ? '#9ca3af' : '#8b5cf6';
      const eta = t.eta ? fmtEta(t.eta) : null;
      const prog = t.progress || 0;
      const autoPct = col.key === 'completed' ? 100 : col.key === 'in_progress' ? (prog || 50) : (prog || 0);
      const fillClass = autoPct >= 100 ? 'pct-100' : autoPct === 0 ? 'pct-0' : '';
      const assigneeInitial = t.assignee ? xss(t.assignee).charAt(0).toUpperCase() : null;
      const assigneeColor = t.assignee === 'FORGE' ? '#10b981' : '#6366f1';
      const isDone = col.key === 'completed';
      return `<div class="task-card${ageWarn?' age-warn':''}${isDone?' is-done':''}" onclick="openTaskDetail(${t.id})">
        <div class="task-card-body">
          <div class="task-title">${xss(t.title||'Untitled')}</div>
          <div class="task-footer">
            <span class="task-pri-dot" style="background:${priDotBg}"></span>
            <span class="task-pri-label" style="color:${priDotBg}">${priShort}</span>
            ${eta ? `<span class="task-eta-compact">${eta}</span>` : ''}
            ${assigneeInitial ? `<div class="task-assignee-avatar" style="background:${assigneeColor}" title="${xss(t.assignee)}">${assigneeInitial}</div>` : ''}
          </div>
        </div>
        <div class="task-progress-wrap"><div class="task-progress-bar"><div class="task-progress-fill ${fillClass}" style="width:${autoPct}%"></div></div></div>
      </div>`;
    });
    const addBtn = col.key === 'backlog'
      ? `<button style="font-size:10px;color:var(--acc);background:none;border:none;cursor:pointer;padding:0;font-weight:600" onclick="openNewTaskModal()">+ New</button>` : '';
    return `<div class="kanban-col">
      <div class="kanban-col-head">
        <span class="kanban-col-title">${col.label}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="kanban-col-count">${col.tasks.length}</span>
          ${addBtn}
        </div>
      </div>
      ${cards.join('')}
      ${!cards.length ? '<div style="font-size:11px;color:var(--tx4);text-align:center;padding:24px 0">Empty</div>' : ''}
    </div>`;
  }).join('');
}

function fmtEta(etaStr) {
  const d = new Date(etaStr);
  if (isNaN(d)) return etaStr;
  const diff = d - Date.now();
  if (diff < 0) return 'Overdue';
  const h = Math.floor(diff / 3600000);
  if (h > 24) return `Due in ${Math.floor(h/24)}d`;
  if (h > 0) return `Due in ${h}h`;
  return `Due in ${Math.floor((diff%3600000)/60000)}m`;
}

function xss(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Task detail
function openTaskDetail(taskId) {
  const task = mcTasks.find(t => t.id === taskId);
  if (!task) return;
  mcCurrentTask = task;
  document.getElementById('td-title').value       = task.title || '';
  document.getElementById('td-description').value = task.description || '';
  const taskPri = task.priority || 'P3 Normal';
  document.getElementById('td-priority').value = taskPri;
  document.querySelectorAll('#td-priority-chips .priority-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.val === taskPri);
  });
  document.getElementById('td-assignee').value    = task.assignee || 'FORGE';
  const taskEta = task.eta ? task.eta.slice(0,16) : '';
  document.getElementById('td-eta').value = taskEta;
  const taskStatus = task.status || 'pending';
  document.getElementById('td-status').value = taskStatus;
  // Populate read-only status display
  const statusLabels = { pending:'Backlog', in_progress:'In Progress', completed:'Completed' };
  const statusColors = { pending:'var(--tx4)', in_progress:'var(--amber)', completed:'var(--green)' };
  const statusDisplay = document.getElementById('td-status-display');
  if (statusDisplay) {
    statusDisplay.textContent = statusLabels[taskStatus] || taskStatus;
    statusDisplay.style.color = statusColors[taskStatus] || 'var(--tx3)';
    statusDisplay.style.fontWeight = taskStatus === 'completed' ? '600' : '500';
  }
  // Lock ETA if assigned to an agent (not the owner)
  const ownerName = (document.getElementById('cfg-owner')?.value || '').trim().toUpperCase();
  const assigneeUp = (task.assignee || 'FORGE').toUpperCase();
  const isAgentAssigned = !ownerName || assigneeUp !== ownerName;
  const etaInput = document.getElementById('td-eta');
  if (etaInput) {
    etaInput.disabled = isAgentAssigned;
    etaInput.style.opacity = isAgentAssigned ? '0.45' : '1';
    etaInput.style.cursor  = isAgentAssigned ? 'default' : '';
    etaInput.title = isAgentAssigned ? 'ETA is set by the assigned agent' : '';
  }
  document.getElementById('td-created').textContent = task.created ? new Date(task.created).toLocaleString() : '—';
  // Build assignee chips
  buildAssigneeChips(task.assignee || 'FORGE');
  openOverlay('task-detail-modal');
}

function buildAssigneeChips(selected) {
  buildAssigneeChipsFor('td-assignee-chips', 'td-assignee', selected);
}

function buildAssigneeChipsFor(containerId, hiddenId, selected) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const ownerRaw  = (document.getElementById('cfg-owner')?.value || '').trim();
  const agentRaw  = (document.getElementById('sidebar-agent-name')?.textContent || 'FORGE').trim();
  const seen = new Set();
  const list = [];
  const tryAdd = (id, label, color) => {
    const key = id.toUpperCase();
    if (!seen.has(key)) { seen.add(key); list.push({ id, label, color }); }
  };
  // Owner only if distinct from agent
  if (ownerRaw) tryAdd(ownerRaw, ownerRaw, '#6366f1');
  tryAdd(agentRaw, agentRaw, '#10b981');
  // Spawned agents
  agents.forEach(a => tryAdd(a.name, a.name, '#8b5cf6'));
  // Also add from task assignees seen in board
  mcTasks.forEach(t => {
    if (t.assignee) tryAdd(t.assignee, t.assignee, '#8b5cf6');
  });

  container.innerHTML = list.map(a => {
    const sel = (selected || '').toUpperCase() === a.id.toUpperCase() ? ' selected' : '';
    return `<div class="assignee-chip${sel}" onclick="selectAssigneeChip(this,'${a.id}','${hiddenId}')">
      <div class="assignee-chip-avatar" style="background:${a.color}">${a.label.charAt(0).toUpperCase()}</div>
      ${a.label}
    </div>`;
  }).join('');
  const hidEl = document.getElementById(hiddenId);
  if (hidEl && !hidEl.value) hidEl.value = selected || agentRaw;
}

function selectAssigneeChip(el, id, hiddenId) {
  const container = el.closest('.assignee-chips');
  if (container) container.querySelectorAll('.assignee-chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById(hiddenId || 'td-assignee').value = id;
}

function selectPriorityChip(el) {
  const container = el.closest('.priority-chips');
  if (!container) return;
  container.querySelectorAll('.priority-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const hidId = container.id === 'nt-priority-chips' ? 'nt-priority' : 'td-priority';
  const hidEl = document.getElementById(hidId);
  if (hidEl) hidEl.value = el.dataset.val;
}

function updateProgressFromStatus() {
  const status = document.getElementById('td-status')?.value;
  const statusLabels = { pending:'Backlog', in_progress:'In Progress', completed:'Completed' };
  const statusColors = { pending:'var(--tx4)', in_progress:'var(--amber)', completed:'var(--green)' };
  const display = document.getElementById('td-status-display');
  if (display) {
    display.textContent = statusLabels[status] || status;
    display.style.color = statusColors[status] || 'var(--tx3)';
  }
}

async function saveTaskDetail() {
  if (!mcCurrentTask) return;
  await api('/tasks/update', {
    id:          mcCurrentTask.id,
    title:       document.getElementById('td-title').value.trim(),
    description: document.getElementById('td-description').value.trim(),
    priority:    document.getElementById('td-priority').value,
    assignee:    document.getElementById('td-assignee').value.trim(),
    eta:         document.getElementById('td-eta').value || null,
    status:      document.getElementById('td-status').value,
    progress:    document.getElementById('td-status').value === 'completed' ? 100 : document.getElementById('td-status').value === 'in_progress' ? (mcCurrentTask.progress || 50) : 0,
  });
  closeOverlay('task-detail-modal');
  loadMissionControl();
}

async function deleteTaskDetail() {
  if (!mcCurrentTask) return;
  if (!confirm('Delete this task permanently?')) return;
  await api('/tasks/delete', { id: mcCurrentTask.id });
  closeOverlay('task-detail-modal');
  mcCurrentTask = null;
  loadMissionControl();
}

// New task
function openNewTaskModal() {
  ['nt-title','nt-description'].forEach(id => document.getElementById(id).value = '');
  // Reset priority chips to Normal
  document.querySelectorAll('#nt-priority-chips .priority-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.val === 'P3 Normal');
  });
  document.getElementById('nt-priority').value = 'P3 Normal';
  document.getElementById('nt-eta').value = '';
  // Build assignee chips for new task (default FORGE)
  buildAssigneeChipsFor('nt-assignee-chips', 'nt-assignee', 'FORGE');
  openOverlay('new-task-modal');
  setTimeout(() => document.getElementById('nt-title').focus(), 80);
}

async function createNewTask() {
  const title = document.getElementById('nt-title').value.trim();
  if (!title) { document.getElementById('nt-title').focus(); return; }
  await api('/tasks/new', {
    title,
    description: document.getElementById('nt-description').value.trim(),
    priority:    document.getElementById('nt-priority').value,
    assignee:    document.getElementById('nt-assignee').value.trim() || 'FORGE',
    eta:         document.getElementById('nt-eta').value || null,
    status:      'pending',
  });
  closeOverlay('new-task-modal');
  loadMissionControl();
}

// Command palette
const CMD_ACTIONS = [
  { icon:'⊕', label:'New Task',         action: openNewTaskModal },
  { icon:'◎', label:'Mission Control',  action: ()=>switchView('mission') },
  { icon:'◎', label:'Chat with Forge', action: ()=>switchView('chat') },
  { icon:'◎', label:'Agents',            action: ()=>switchView('agents') },
  { icon:'◎', label:'Memory',           action: ()=>switchView('memory') },
  { icon:'◎', label:'Heartbeat',        action: ()=>switchView('heartbeat') },
  { icon:'◎', label:'Channels',         action: ()=>switchView('channels') },
  { icon:'◎', label:'Alarms',           action: ()=>switchView('alarms') },
  { icon:'◎', label:'New Alarm',        action: ()=>{ switchView('alarms'); openAlarmModal(); } },
  { icon:'◎', label:'API Key Vault',    action: ()=>{ switchView('settings'); setTimeout(()=>{ const t=document.querySelector('.settings-tab[onclick*="keys"]'); if(t) switchSettingsTab(t,'keys'); },100); } },
  { icon:'◎', label:'Settings',         action: ()=>switchView('settings') },
  { icon:'⊕', label:'Spawn Agent',      action: ()=>openOverlay('spawn-modal') },
  { icon:'◑', label:'Toggle Theme',     action: toggleTheme },
];

function openCmdPalette() {
  document.getElementById('cmd-palette').classList.add('open');
  const inp = document.getElementById('cmd-input');
  inp.value = '';
  cmdSelIdx = 0;
  renderCmdResults('');
  setTimeout(() => inp.focus(), 40);
}
function closeCmdPalette() {
  document.getElementById('cmd-palette').classList.remove('open');
}
function renderCmdResults(q) {
  const filtered = q
    ? CMD_ACTIONS.filter(a => a.label.toLowerCase().includes(q.toLowerCase()))
    : CMD_ACTIONS;
  document.getElementById('cmd-results').innerHTML = filtered.length
    ? filtered.map((it, i) => `<div class="cmd-item${i===cmdSelIdx?' sel':''}" data-i="${i}" onmouseenter="cmdSelIdx=${i};renderCmdResults(document.getElementById('cmd-input').value)" onclick="execCmd(${CMD_ACTIONS.indexOf(it)})">
        <span class="cmd-item-icon">${it.icon}</span>${it.label}
      </div>`).join('')
    : '<div style="padding:14px;font-size:12px;color:var(--tx4);text-align:center">No results</div>';
}
function execCmd(idx) {
  CMD_ACTIONS[idx]?.action?.();
  closeCmdPalette();
}
function handleCmdKey(e) {
  const items = document.querySelectorAll('#cmd-results .cmd-item');
  if (e.key === 'ArrowDown') { cmdSelIdx = Math.min(cmdSelIdx+1, items.length-1); renderCmdResults(e.target.value); }
  else if (e.key === 'ArrowUp') { cmdSelIdx = Math.max(cmdSelIdx-1, 0); renderCmdResults(e.target.value); }
  else if (e.key === 'Enter') { const sel = document.querySelector('#cmd-results .sel'); if (sel) sel.click(); }
  else if (e.key === 'Escape') { closeCmdPalette(); }
}

// Global keyboard shortcuts
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCmdPalette(); return; }
  if (e.key === 'Escape') {
    ['task-detail-modal','new-task-modal','spawn-modal'].forEach(closeOverlay);
    closeCmdPalette();
    return;
  }
  const tag = document.activeElement.tagName;
  if (['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
  if (e.key === 'n' || e.key === 'N') { openNewTaskModal(); return; }
  if (e.key === 'a' || e.key === 'A') { openOverlay('spawn-modal'); return; }
});

// Live clock
(function tickClock() {
  const el = document.getElementById('top-clock');
  if (el) el.textContent = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  setTimeout(tickClock, 1000);
})();

// ══════════════════════════════════════════
//  SETTINGS TABS
// ══════════════════════════════════════════
function switchSettingsTab(btn, section) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.stab-pane').forEach(p => p.classList.remove('visible'));
  const pane = document.getElementById('stab-' + section);
  if (pane) pane.classList.add('visible');
  if (section === 'appearance') syncThemePreviews();
  if (section === 'system') loadSystemStats();
  if (section === 'model') {
    renderModelCards(curProvider || 'anthropic', curModel);
    const lbl = document.getElementById('cfg-current-model-label');
    if (lbl) lbl.textContent = curModel || '—';
  }
  if (section === 'heartbeat') loadHeartbeats();
  if (section === 'keys') loadKeyVault();
}

function selectModel(card) {
  document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  const model = card.getAttribute('data-model');
  curModel = model;
  document.getElementById('cfg-primary-model').value = model;
}

function setTheme(t, el) {
  applyTheme(t, true);
  document.querySelectorAll('.theme-prev').forEach(p => p.classList.remove('selected'));
  document.getElementById('prev-' + t)?.classList.add('selected');
}

function syncThemePreviews() {
  const pl = document.getElementById('prev-light');
  const pd = document.getElementById('prev-dark');
  if (pl) pl.classList.toggle('selected', theme === 'light');
  if (pd) pd.classList.toggle('selected', theme === 'dark');
}

function setAccent(name, el) {
  const map = { purple:'#6d28d9', indigo:'#4f46e5', blue:'#2563eb', teal:'#0d9488', rose:'#e11d48' };
  const col = map[name];
  if (!col) return;
  document.documentElement.style.setProperty('--acc', col);
  document.documentElement.style.setProperty('--acc2', col);
  document.querySelectorAll('.accent-swatch').forEach(s => { s.style.boxShadow = ''; s.classList.remove('selected'); });
  el.classList.add('selected');
  el.style.boxShadow = `0 0 0 3px ${col}40`;
  localStorage.setItem('forge-accent', name);
}

function updateSettingsStatusBadges() {
  // Use /config — actual channel data lives there, not in /status
  api('/config').then(cfg => {
    const tg = !!(cfg.channels?.telegram?.bot_token && cfg.channels?.telegram?.user_id);
    const dc = !!(cfg.channels?.discord?.webhook_url || cfg.channels?.discord?.bot_token);
    const tgBadge = document.getElementById('stab-tg-badge');
    const dcBadge = document.getElementById('stab-dc-badge');
    if (tgBadge) { tgBadge.className = 'badge ' + (tg ? 'badge-ok' : 'badge-error'); tgBadge.textContent = tg ? 'active' : 'not set'; }
    if (dcBadge) { dcBadge.className = 'badge ' + (dc ? 'badge-ok' : 'badge-error'); dcBadge.textContent = dc ? 'active' : 'not set'; }
  }).catch(()=>{});
}

// ══════════════════════════════════════════
//  MEMORY FILTER
// ══════════════════════════════════════════
let allMemories = [];
let activeMemCat = 'all';

async function loadMemory() {
  const data = await api('/learnings').catch(()=>[]);
  allMemories = data;
  const lbl = document.getElementById('memory-count-label');
  if (lbl) lbl.textContent = `${(window._forgeName||'Forge')}'s persistent knowledge base`;

  // Build category chips
  const cats = ['all', ...new Set(data.map(m => m.category || 'general'))];
  const filtersEl = document.getElementById('mem-filters');
  if (filtersEl) {
    filtersEl.innerHTML = cats.map(c =>
      `<button class="mem-chip${c === activeMemCat ? ' active' : ''}" data-cat="${c}" onclick="filterMemoryByCategory('${c}',this)">${c}</button>`
    ).join('');
  }

  // Update memory stats bar
  const total = data.length;
  const uniqueCats = [...new Set(data.map(m => m.category).filter(Boolean))].length;
  const syncEl = document.getElementById('mem-stat-sync');
  if (syncEl) syncEl.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const tv = document.getElementById('mem-stat-total'); if(tv) animateNumber(tv, total);
  const cv = document.getElementById('mem-stat-cats');  if(cv) animateNumber(cv, uniqueCats);
  const lv = document.getElementById('mem-stat-learnings'); if(lv) animateNumber(lv, total);

  renderMemoryList(data);
}

function getCatClass(cat) {
  const map = {
    synfiction: 'mc-synfiction', code: 'mc-code', system: 'mc-system',
    user: 'mc-user', forge: 'mc-forge', general: 'mc-general'
  };
  return map[(cat||'').toLowerCase()] || 'mc-default';
}

function renderMemoryList(data) {
  const list = document.getElementById('memory-list');
  const iconMap = {
    synfiction: '🎬', code: '⌨', system: '⚙', user: '👤', forge: '⚡', general: '💡'
  };
  list.innerHTML = data.length
    ? data.map(m => {
        const catIcon = iconMap[(m.category||'').toLowerCase()] || '📌';
        const catClass = getCatClass(m.category);
        const ts = (m.timestamp||'').slice(0,16);
        const xss = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<div class="memory-item">
          <div class="memory-icon-col">${catIcon}</div>
          <div class="memory-content-col">
            <div class="memory-cat-row">
              <span class="memory-cat ${catClass}">${m.category||'general'}</span>
            </div>
            <div class="memory-text">${xss(m.insight||m.content||m.text||'')}</div>
            <div class="memory-ts">${ts}</div>
          </div>
        </div>`;
      }).join('')
    : '<div class="no-data">No learnings match. Forge learns from every conversation.</div>';
}

function filterMemory(q) {
  const filtered = allMemories.filter(m => {
    const text = (m.insight || '') + ' ' + (m.category || '');
    return text.toLowerCase().includes(q.toLowerCase());
  }).filter(m => activeMemCat === 'all' || (m.category || 'general') === activeMemCat);
  renderMemoryList(filtered);
}

function filterMemoryByCategory(cat, btn) {
  activeMemCat = cat;
  document.querySelectorAll('.mem-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  const q = document.getElementById('mem-search')?.value || '';
  filterMemory(q);
}

// ══════════════════════════════════════════
//  CHANNELS
// ══════════════════════════════════════════
function selectChannel(id, btn) {
  document.querySelectorAll('.ch-rail-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  ['telegram','discord','whatsapp','slack','gmail','icloud'].forEach(c => {
    const p = document.getElementById('ch-panel-' + c);
    if (!p) return;
    p.style.display = (c === id) ? 'flex' : 'none';
    if (c === id) p.style.flexDirection = 'column';
  });
}

async function loadChannelStatuses() {
  const cfg = await api('/config').catch(()=>({}));
  const ch  = cfg.channels || {};
  const tgCfg = ch.telegram || {};
  const dcCfg = ch.discord  || {};
  const waCfg = ch.whatsapp || {};
  const slCfg = ch.slack    || {};
  const gmCfg = ch.gmail    || {};
  const icCfg = ch.icloud   || {};
  const ntCfg = ch.notion   || {};

  const tg = !!(tgCfg.bot_token && tgCfg.user_id);
  const dc = !!(dcCfg.bot_token && dcCfg.guild_id);
  const wa = !!(waCfg.sid && waCfg.token);
  const sl = !!(slCfg.bot_token);
  const gm = !!(gmCfg.email && gmCfg.password);
  const ic = !!(icCfg.email && icCfg.password);
  const nt = !!(ntCfg.token);

  function applyChannelStatus(dotId, lblId, badgeId, railId, active) {
    const dot   = document.getElementById(dotId);
    const lbl   = document.getElementById(lblId);
    const badge = document.getElementById(badgeId);
    const rail  = document.getElementById(railId);
    if (dot)   { dot.style.cssText = `background:${active?'var(--green)':'var(--red)'};box-shadow:0 0 6px ${active?'rgba(22,163,74,.5)':'rgba(220,38,38,.3)'};width:8px;height:8px;border-radius:50%;flex-shrink:0`; }
    if (lbl)   { lbl.textContent = active ? 'Connected' : 'Not configured'; lbl.style.color = active ? 'var(--green)' : 'var(--red)'; lbl.style.fontWeight = '600'; }
    if (badge) { badge.className = 'badge ' + (active ? 'badge-ok' : 'badge-error'); badge.textContent = active ? 'active' : 'not set'; }
    if (rail)  { rail.className = 'ch-rail-dot' + (active ? ' active' : ''); }
  }

  applyChannelStatus('ch-tg-dot','ch-tg-status-label','ch-tg-badge','rail-dot-telegram', tg);
  applyChannelStatus('ch-dc-dot','ch-dc-status-label','ch-dc-badge','rail-dot-discord',  dc);
  applyChannelStatus('ch-wa-dot','ch-wa-status-label','ch-wa-badge','rail-dot-whatsapp', wa);
  applyChannelStatus('ch-sl-dot','ch-sl-status-label','ch-sl-badge','rail-dot-slack',    sl);
  applyChannelStatus('ch-gm-dot','ch-gm-status-label','ch-gm-badge','rail-dot-gmail',   gm);
  applyChannelStatus('ch-ic-dot','ch-ic-status-label','ch-ic-badge','rail-dot-icloud',  ic);
  applyChannelStatus('ch-nt-dot','ch-nt-status-label','ch-nt-badge','rail-dot-notion',  nt);

  // Pre-fill saved values
  const prefill = (id, val, mask) => { const el = document.getElementById(id); if (el && val) { if (mask) el.placeholder = val; else el.value = val; } };
  prefill('ch-tg-token', tgCfg.bot_token, true);
  prefill('ch-tg-chat',  tgCfg.user_id,   false);
  prefill('ch-dc-token', dcCfg.bot_token, true);
  prefill('ch-dc-guild', dcCfg.guild_id,  false);
  prefill('ch-dc-channel', dcCfg.channel_id, false);
  prefill('ch-sl-token', slCfg.bot_token, true);
  prefill('ch-sl-channel', slCfg.channel, false);
  prefill('ch-gm-email', gmCfg.email, false);
  prefill('ch-gm-password', gmCfg.password, true);
  prefill('ch-ic-email', icCfg.email, false);
  prefill('ch-ic-password', icCfg.password, true);
  prefill('ch-nt-token', ntCfg.token, true);
}

async function testChannel(type) {
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = 'Testing…';
  btn.disabled = true;
  try {
    if (type === 'telegram') {
      const token = document.getElementById('ch-tg-token')?.value?.trim();
      if (!token) throw new Error('Enter bot token first');
      const r = await fetch(`https://api.telegram.org/bot${token}/getMe`);
      const j = await r.json();
      btn.textContent = j.ok ? `✓ @${j.result.username}` : 'Invalid token';
    } else if (type === 'discord') {
      const token = document.getElementById('ch-dc-token')?.value?.trim();
      if (!token) throw new Error('Enter bot token first');
      const r = await fetch('https://discord.com/api/v10/users/@me', { headers: { Authorization: `Bot ${token}` } });
      const j = await r.json();
      btn.textContent = j.username ? `✓ ${j.username}` : 'Invalid token';
    } else if (type === 'slack') {
      const token = document.getElementById('ch-sl-token')?.value?.trim();
      if (!token) throw new Error('Enter bot token first');
      const r = await fetch('https://slack.com/api/auth.test', { headers: { Authorization: `Bearer ${token}` } });
      const j = await r.json();
      btn.textContent = j.ok ? `✓ ${j.team}` : (j.error || 'Invalid token');
    } else if (type === 'notion') {
      const token = document.getElementById('ch-nt-token')?.value?.trim();
      if (!token) throw new Error('Enter integration token first');
      const r = await fetch('https://api.notion.com/v1/users/me', { headers: { Authorization: `Bearer ${token}`, 'Notion-Version': '2022-06-28' } });
      const j = await r.json();
      btn.textContent = j.object === 'user' ? `✓ Connected` : 'Invalid token';
    } else {
      btn.textContent = 'Save & test via Forge';
    }
  } catch(e) {
    btn.textContent = e.message || 'Failed';
  }
  btn.disabled = false;
  setTimeout(() => { btn.textContent = orig; }, 3000);
}

async function saveChannel(type) {
  let data = { enabled: true };
  const v = id => document.getElementById(id)?.value?.trim() || '';
  if (type === 'telegram') {
    const token = v('ch-tg-token'), user_id = v('ch-tg-chat');
    if (!token || !user_id) { alert('Bot token and Chat ID are both required.'); return; }
    data.bot_token = token; data.user_id = user_id;
  } else if (type === 'discord') {
    const token = v('ch-dc-token'), guild_id = v('ch-dc-guild');
    if (!token || !guild_id) { alert('Bot Token and Server ID are required.'); return; }
    data.bot_token = token; data.guild_id = guild_id;
    const channel_id = v('ch-dc-channel');
    if (channel_id) data.channel_id = channel_id;
  } else if (type === 'whatsapp') {
    data.sid = v('ch-wa-sid'); data.token = v('ch-wa-token');
    data.from = v('ch-wa-from'); data.to = v('ch-wa-to');
  } else if (type === 'slack') {
    const token = v('ch-sl-token');
    if (!token) { alert('Bot Token is required.'); return; }
    data.bot_token = token; data.channel = v('ch-sl-channel');
  } else if (type === 'gmail') {
    const email = v('ch-gm-email'), password = v('ch-gm-password');
    if (!email || !password) { alert('Gmail address and App Password are required.'); return; }
    data.email = email; data.password = password;
  } else if (type === 'icloud') {
    const email = v('ch-ic-email'), password = v('ch-ic-password');
    if (!email || !password) { alert('Apple ID and App Password are required.'); return; }
    data.email = email; data.password = password;
  } else if (type === 'notion') {
    const token = v('ch-nt-token');
    if (!token) { alert('Integration Token is required.'); return; }
    data.token = token;
  }
  const btn = event.target;
  btn.textContent = 'Saving…';
  btn.disabled = true;
  const result = await api('/channel/update', { channel: type, data }).catch(()=>null);
  btn.disabled = false;
  if (result?.success) {
    btn.textContent = 'Saved ✓';
    setTimeout(() => { btn.textContent = 'Save'; loadChannelStatuses(); }, 1800);
  } else {
    btn.textContent = 'Failed — daemon offline?';
    setTimeout(() => { btn.textContent = 'Save'; }, 2500);
  }
}

// ══════════════════════════════════════════
//  PARALLEL — premium rebuild
// ══════════════════════════════════════════
function makeParallelCard(agent, idx) {
  const displayName = agent.name === 'FORGE' ? 'CORTEX' : agent.name;
  return `
  <div class="ptc-card" id="ptc-${idx}" data-agent="${agent.name}">
    <div class="ptc-titlebar">
      <div class="ptc-dot ptc-dot-r"></div>
      <div class="ptc-dot ptc-dot-y"></div>
      <div class="ptc-dot ptc-dot-g"></div>
      <span class="ptc-agent-label">${displayName} <span style="color:var(--tx4);font-weight:400;font-size:10px">/ ${agent.role||'agent'}</span></span>
      <span class="ptc-status-line">
        <span class="ptc-status-dot idle" id="ptc-dot-${idx}"></span>
        <span id="ptc-status-${idx}">idle</span>
      </span>
    </div>
    <div class="ptc-body">
      <textarea class="ptc-input" id="pt-${agent.name}" placeholder="// Task for ${displayName}…" oninput="updateTokenEst(${idx}, this.value)"></textarea>
      <div class="ptc-meta-row">
        <span class="ptc-token-est">
          <svg width="10" height="10" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="12" height="10" rx="2"/><path d="M5 7h6M5 10h4"/></svg>
          ~<span id="ptc-tokens-${idx}">0</span> tokens
        </span>
      </div>
      <div class="ptc-response" id="pr-${agent.name}"></div>
    </div>
  </div>`;
}

function buildParallelGrid() {
  const all = [{ name:'FORGE', role:'Master' }, ...agents];
  const grid = document.getElementById('parallel-grid');
  if (!grid) return;
  grid.innerHTML = all.slice(0, 6).map((a, i) => makeParallelCard(a, i)).join('');
}

function updateTokenEst(idx, val) {
  const el = document.getElementById('ptc-tokens-' + idx);
  if (el) el.textContent = Math.round(val.length / 4);
}

function updateParallelProgress(done, total) {
  const bar   = document.getElementById('parallel-progress');
  const fill  = document.getElementById('parallel-prog-fill');
  const label = document.getElementById('parallel-prog-label');
  if (!bar) return;
  if (total > 0) {
    bar.classList.add('visible');
    const pct = Math.round((done / total) * 100);
    if (fill)  fill.style.width = pct + '%';
    if (label) label.textContent = `${done} / ${total} agents complete`;
    if (done === total) setTimeout(() => bar.classList.remove('visible'), 2000);
  } else {
    bar.classList.remove('visible');
  }
}

// Override runParallel to use new terminal card structure
window.runParallel = async function() {
  const tasks = {};
  const agentMap = {};
  document.querySelectorAll('[id^="pt-"]').forEach((el, i) => {
    const v = el.value.trim();
    const agentName = el.id.slice(3);
    if (v) { tasks[agentName] = v; agentMap[agentName] = i; }
  });
  if (!Object.keys(tasks).length) { alert('Add at least one task'); return; }

  const total = Object.keys(tasks).length;
  updateParallelProgress(0, total);

  // Set running state on cards
  Object.entries(agentMap).forEach(([agentName, idx]) => {
    const card = document.getElementById('ptc-' + idx);
    const dot  = document.getElementById('ptc-dot-' + idx);
    const stat = document.getElementById('ptc-status-' + idx);
    const resp = document.getElementById('pr-' + agentName);
    if (card) card.classList.add('running');
    if (dot)  { dot.className = 'ptc-status-dot running'; }
    if (stat) stat.textContent = 'running';
    if (resp) { resp.textContent = '// running…'; resp.className = 'ptc-response has-content ptc-response-running'; }
  });

  const data = await api('/parallel', { tasks }).catch(()=>({results:{}}));
  let done = 0;

  Object.entries(data.results || {}).forEach(([key, r]) => {
    const idx  = agentMap[key];
    const card = document.getElementById('ptc-' + idx);
    const dot  = document.getElementById('ptc-dot-' + idx);
    const stat = document.getElementById('ptc-status-' + idx);
    const resp = document.getElementById('pr-' + key);
    if (card) { card.classList.remove('running'); card.classList.add('done'); }
    if (dot)  dot.className = 'ptc-status-dot done';
    if (stat) stat.textContent = 'done';
    if (resp) { resp.textContent = r.result || '// no response'; resp.className = 'ptc-response has-content'; }
    done++;
    updateParallelProgress(done, total);
  });
};

window.clearParallel = function() {
  document.querySelectorAll('[id^="pt-"]').forEach(el => el.value = '');
  document.querySelectorAll('[id^="pr-"]').forEach(el => { el.textContent = ''; el.className = 'ptc-response'; });
};

// ══════════════════════════════════════════
//  MEMORY UTILITIES
// ══════════════════════════════════════════
function animateNumber(el, target) {
  const start = parseInt(el.textContent) || 0;
  const dur = 600;
  const t0 = performance.now();
  const tick = now => {
    const p = Math.min((now - t0) / dur, 1);
    const ease = p < 0.5 ? 2*p*p : -1+(4-2*p)*p;
    el.textContent = Math.round(start + (target - start) * ease);
    if (p < 1) requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}

function exportMemory() {
  api('/learnings').then(data => {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `forge-memory-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    addToast('Memory exported');
  }).catch(() => addToast('Export failed — check API connection'));
}

// ══════════════════════════════════════════
//  API KEY VAULT
// ══════════════════════════════════════════
const KEY_MAP = [
  { id: 'google-client-id',     path: 'integrations.google.client_id' },
  { id: 'google-client-secret', path: 'integrations.google.client_secret' },
  { id: 'github-token',         path: 'integrations.github.token' },
  { id: 'notion-token',         path: 'integrations.notion.token' },
  { id: 'slack-bot-token',      path: 'integrations.slack.bot_token' },
  { id: 'serper-key',           path: 'integrations.serper.api_key' },
  { id: 'brave-key',            path: 'integrations.brave.api_key' },
  { id: 'cursor-key',           path: 'providers.cursor.api_key' },
  { id: 'icloud-email',         path: 'integrations.icloud.email' },
  { id: 'icloud-app-password',  path: 'integrations.icloud.app_password' },
  { id: 'weather-key',          path: 'integrations.weather.api_key' },
  { id: 'weather-city',         path: 'integrations.weather.default_city' },
  { id: 'kimi-key',             path: 'providers.kimi.api_key' },
];

async function loadKeyVault() {
  const data = await api('/keys').catch(() => ({}));
  KEY_MAP.forEach(({ id, path }) => {
    const inp = document.getElementById('key-' + id);
    if (!inp) return;
    const val = path.split('.').reduce((o, k) => (o && o[k] !== undefined ? o[k] : ''), data);
    inp.value = val || '';
    setDot(id, val ? 'saved' : '');
  });
  // Custom keys
  const custom = data.integrations?.custom || {};
  const list = document.getElementById('custom-keys-list');
  if (list) {
    list.innerHTML = '';
    Object.entries(custom).forEach(([k, v]) => addCustomKeyRow(k, v));
  }
}

const EYE_OPEN = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;
const EYE_SHUT = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`;
function toggleKeyVis(inputId, btn) {
  const inp = typeof inputId === 'string' ? document.getElementById(inputId) : inputId;
  if (!inp) return;
  inp.type = inp.type === 'password' ? 'text' : 'password';
  btn.innerHTML = inp.type === 'password' ? EYE_OPEN : EYE_SHUT;
}

function markKeyDirty(id) { setDot(id, 'dirty'); }

function setDot(id, state) {
  const dot = document.getElementById('dot-' + id);
  if (!dot) return;
  dot.className = 'key-save-dot' + (state ? ' ' + state : '');
}

function addCustomKeyRow(name = '', value = '') {
  const list = document.getElementById('custom-keys-list');
  if (!list) return;
  const row = document.createElement('div');
  row.className = 'custom-key-row';
  row.innerHTML = `
    <input class="custom-key-name" type="text" placeholder="KEY_NAME" value="${name}">
    <div class="key-input-wrap" style="flex:1">
      <input class="key-input" type="password" placeholder="value" value="${value}" oninput="markKeyDirty('custom-all')">
      <button class="key-eye" onclick="toggleKeyVis(this.previousElementSibling,this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
    </div>
    <div class="key-save-dot" id="dot-custom-all"></div>
    <button class="btn-icon-del" onclick="this.closest('.custom-key-row').remove();markKeyDirty('custom-all')">✕</button>
  `;
  // Fix: wire eye button to sibling input properly
  const eye = row.querySelector('.key-eye');
  eye.onclick = function() {
    toggleKeyVis(this.previousElementSibling, this);
  };
  list.appendChild(row);
}

async function saveAllKeys() {
  const payload = { integrations: { google: {}, github: {}, notion: {}, slack: {}, serper: {}, brave: {}, icloud: {}, weather: {}, custom: {} }, providers: { cursor: {} } };
  KEY_MAP.forEach(({ id, path }) => {
    const inp = document.getElementById('key-' + id);
    if (!inp) return;
    const keys = path.split('.');
    let obj = payload;
    keys.slice(0, -1).forEach(k => { obj = obj[k] = obj[k] || {}; });
    obj[keys[keys.length - 1]] = inp.value.trim();
  });
  // Custom keys
  document.querySelectorAll('#custom-keys-list .custom-key-row').forEach(row => {
    const k = row.querySelector('.custom-key-name')?.value?.trim();
    const v = row.querySelector('.key-input')?.value?.trim();
    if (k) payload.integrations.custom[k] = v || '';
  });
  const res = await api('/keys', payload).catch(() => null);
  if (res) {
    KEY_MAP.forEach(({ id }) => setDot(id, 'saved'));
    setDot('custom-all', 'saved');
    addToast('API keys saved');
  } else {
    addToast('Save failed — check API connection');
  }
}

// ══════════════════════════════════════════
//  ALARMS
// ══════════════════════════════════════════
let alarmEditId = null;

async function loadAlarms() {
  const alarms = await api('/alarms').catch(() => []);
  const list = document.getElementById('alarms-list');
  const badge = document.getElementById('alarms-count-badge');
  if (!list) return;

  const enabled = alarms.filter(a => a.enabled !== false);
  if (badge) { badge.textContent = enabled.length + ' active'; badge.style.display = enabled.length ? '' : 'none'; }

  if (!alarms.length) {
    list.innerHTML = `<div class="alarm-empty">
      <div class="alarm-empty-icon">⏰</div>
      <div class="alarm-empty-text">No alarms set yet.<br>Add one to schedule recurring tasks.</div>
    </div>`;
    return;
  }

  list.innerHTML = alarms.map(a => {
    const schedLabel = cronToHuman(a.cron || '');
    const statusClass = a.last_status === 'completed' ? 'status-ok' : a.last_status === 'failed' ? 'status-err' : 'status-pending';
    const statusLabel = a.last_status
      ? `${a.last_status === 'completed' ? '✓' : '✗'} Last run: ${a.last_run ? new Date(a.last_run).toLocaleTimeString() : '—'}`
      : 'Not yet run';
    return `<div class="alarm-card ${a.enabled === false ? 'disabled' : ''}" id="alarm-card-${a.id}">
      <div class="alarm-icon">⏰</div>
      <div class="alarm-info">
        <div class="alarm-name">${escHtml(a.name || 'Untitled')}</div>
        <div class="alarm-sched">${schedLabel}</div>
        <div class="alarm-task">${escHtml(a.task || '')}</div>
        <div class="alarm-status ${statusClass}">${statusLabel}</div>
      </div>
      <div class="alarm-actions">
        <label class="alarm-toggle" title="${a.enabled !== false ? 'Disable' : 'Enable'}">
          <input type="checkbox" ${a.enabled !== false ? 'checked' : ''} onchange="toggleAlarm(${a.id}, this.checked)">
          <span class="alarm-toggle-slider"></span>
        </label>
        <button class="btn btn-ghost" style="font-size:10px;height:26px;padding:0 8px" onclick="showAlarmLog(${a.id})">View Log</button>
        <button class="btn btn-ghost" style="font-size:10px;height:26px;padding:0 8px" onclick="editAlarm(${a.id})">Edit</button>
        <button class="btn-icon-del" onclick="deleteAlarm(${a.id})" title="Delete">✕</button>
      </div>
    </div>`;
  }).join('');
}

function cronToHuman(cron) {
  if (!cron) return 'Custom schedule';
  const parts = cron.split(' ');
  if (parts.length < 5) return cron;
  const [min, hr, , , dow] = parts;
  const pad = n => String(n).padStart(2, '0');
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  if (dow === '*' && hr !== '*') return `Every day at ${pad(hr)}:${pad(min)}`;
  if (dow === '1-5') return `Weekdays at ${pad(hr)}:${pad(min)}`;
  if (dow !== '*' && hr !== '*') return `Every ${days[+dow] || dow} at ${pad(hr)}:${pad(min)}`;
  if (hr === '*') return `Every hour at :${pad(min)}`;
  return cron;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function showAlarmLog(alarmId) {
  try {
    const res = await fetch(`/api/alarm-logs?alarm_id=${alarmId}`);
    const logs = await res.json();
    if (!logs.length) { alert('No execution logs yet.'); return; }
    const html = logs.map(l =>
      `[${l.fired_at}] ${l.status.toUpperCase()}\nTask: ${l.triggered_msg}\nResult: ${(l.result||'').substring(0,300)}`
    ).join('\n\n---\n\n');
    alert(html);
  } catch (err) {
    alert('Failed to load alarm logs: ' + err.message);
  }
}

function openAlarmModal(alarm) {
  alarmEditId = null;
  document.getElementById('alarm-edit-id').value = '';
  document.getElementById('alarm-modal-title').textContent = 'New Alarm';
  document.getElementById('alarm-name').value = '';
  document.getElementById('alarm-freq').value = 'daily';
  document.getElementById('alarm-time').value = '09:00';
  document.getElementById('alarm-task').value = '';
  document.getElementById('alarm-channel').value = 'telegram';
  document.getElementById('alarm-cron-wrap').style.display = 'none';
  document.getElementById('alarm-day-wrap').style.display = 'none';
  document.getElementById('alarm-time-wrap').style.display = '';
  updateAlarmCronPreview();
  openOverlay('alarm-modal');
}

function closeAlarmModal() {
  closeOverlay('alarm-modal');
}

async function editAlarm(id) {
  const alarms = await api('/alarms').catch(() => []);
  const a = alarms.find(x => x.id === id);
  if (!a) return;
  alarmEditId = id;
  document.getElementById('alarm-edit-id').value = id;
  document.getElementById('alarm-modal-title').textContent = 'Edit Alarm';
  document.getElementById('alarm-name').value = a.name || '';
  document.getElementById('alarm-task').value = a.task || '';
  document.getElementById('alarm-channel').value = a.channel || 'telegram';
  // Parse cron back to freq/time
  const parts = (a.cron || '').split(' ');
  if (parts.length === 5) {
    const [min, hr, , , dow] = parts;
    if (dow === '*' && hr !== '*') { document.getElementById('alarm-freq').value = 'daily'; document.getElementById('alarm-time').value = `${String(hr).padStart(2,'0')}:${String(min).padStart(2,'0')}`; }
    else if (dow === '1-5') { document.getElementById('alarm-freq').value = 'weekdays'; document.getElementById('alarm-time').value = `${String(hr).padStart(2,'0')}:${String(min).padStart(2,'0')}`; }
    else if (hr === '*') { document.getElementById('alarm-freq').value = 'hourly'; }
    else { document.getElementById('alarm-freq').value = 'custom'; document.getElementById('alarm-cron').value = a.cron; }
  } else {
    document.getElementById('alarm-freq').value = 'custom';
    document.getElementById('alarm-cron').value = a.cron || '';
  }
  updateAlarmCronPreview();
  openOverlay('alarm-modal');
}

function updateAlarmCronPreview() {
  const freq = document.getElementById('alarm-freq')?.value;
  const time = document.getElementById('alarm-time')?.value || '09:00';
  const [h, m] = time.split(':');
  const day  = document.getElementById('alarm-day')?.value || '1';
  const cronWrap = document.getElementById('alarm-cron-wrap');
  const dayWrap  = document.getElementById('alarm-day-wrap');
  const timeWrap = document.getElementById('alarm-time-wrap');
  const preview  = document.getElementById('alarm-cron-preview');

  let cron = '0 9 * * *', label = '';
  if (freq === 'daily')    { cron = `${+m} ${+h} * * *`;    label = `Every day at ${time}`; cronWrap.style.display='none'; dayWrap.style.display='none'; timeWrap.style.display=''; }
  if (freq === 'weekdays') { cron = `${+m} ${+h} * * 1-5`;  label = `Weekdays at ${time}`;  cronWrap.style.display='none'; dayWrap.style.display='none'; timeWrap.style.display=''; }
  if (freq === 'weekly')   { cron = `${+m} ${+h} * * ${day}`; const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; label = `Every ${days[+day]} at ${time}`; cronWrap.style.display='none'; dayWrap.style.display=''; timeWrap.style.display=''; }
  if (freq === 'hourly')   { cron = `${+m} * * * *`;        label = `Every hour at :${String(m).padStart(2,'0')}`; cronWrap.style.display='none'; dayWrap.style.display='none'; timeWrap.style.display=''; }
  if (freq === 'custom')   { cron = document.getElementById('alarm-cron')?.value || ''; label = cron || 'Enter cron expression'; cronWrap.style.display=''; dayWrap.style.display='none'; timeWrap.style.display='none'; }
  if (preview) preview.textContent = 'Schedule: ' + label;
}

async function submitAlarm() {
  const freq = document.getElementById('alarm-freq').value;
  const time = document.getElementById('alarm-time').value || '09:00';
  const [h, m] = time.split(':');
  const day = document.getElementById('alarm-day').value;
  let cron;
  if (freq === 'daily')    cron = `${+m} ${+h} * * *`;
  else if (freq === 'weekdays') cron = `${+m} ${+h} * * 1-5`;
  else if (freq === 'weekly')   cron = `${+m} ${+h} * * ${day}`;
  else if (freq === 'hourly')   cron = `${+m} * * * *`;
  else cron = document.getElementById('alarm-cron').value.trim();

  const payload = {
    id: alarmEditId || undefined,
    name: document.getElementById('alarm-name').value.trim() || 'Untitled Alarm',
    cron,
    task: document.getElementById('alarm-task').value.trim(),
    channel: document.getElementById('alarm-channel').value,
    enabled: true,
  };
  if (!payload.task) { addToast('Please enter a task / prompt'); return; }

  const res = await api('/alarms', payload).catch(() => null);
  if (res) {
    closeAlarmModal();
    loadAlarms();
    addToast(alarmEditId ? 'Alarm updated' : 'Alarm created');
  } else {
    addToast('Save failed — check API connection');
  }
}

async function toggleAlarm(id, enabled) {
  await api('/alarms/toggle', { id, enabled }).catch(() => null);
  loadAlarms();
}

async function deleteAlarm(id) {
  if (!confirm('Delete this alarm?')) return;
  await api('/alarms/delete', { id }).catch(() => null);
  loadAlarms();
  addToast('Alarm deleted');
}

// ══════════════════════════════════════════
//  SKILL CREATOR
// ══════════════════════════════════════════
const SKILL_ICONS = {
  search:'🔍', web:'🌐', fetch:'🌐', url:'🌐', brave:'🔍',
  gmail:'📧', mail:'📧', email:'📧', icloud:'📧', send:'📤',
  slack:'💬', telegram:'💬', notion:'📝', github:'🐙',
  gcal:'📅', calendar:'📅', gsheets:'📊', sheets:'📊',
  weather:'🌤', cursor:'💻', gsd:'⚡', default:'🔧'
};
function skillIcon(name) {
  const n = (name||'').toLowerCase();
  for (const [k,v] of Object.entries(SKILL_ICONS)) { if (n.includes(k)) return v; }
  return SKILL_ICONS.default;
}

let _skillsCache = [];
// Skills that are channel integrations — shown in Channels, not Skills
const CHANNEL_SKILLS = new Set(['slack_send','gmail_send','gmail_auth','icloud_send','notion_create']);
// Skills that need API keys — map to config path
const SKILL_KEY_MAP = {
  brave_search: [{ label: 'Brave Search API Key', path: 'integrations.brave.api_key', type: 'password', link: 'brave.com/search/api' }],
  web_search:   [{ label: 'Serper API Key', path: 'integrations.serper.key', type: 'password', link: 'serper.dev' }],
  weather:      [{ label: 'OpenWeatherMap API Key', path: 'integrations.weather.api_key', type: 'password', link: 'openweathermap.org/api' }, { label: 'Default City', path: 'integrations.weather.default_city', type: 'text' }],
  cursor_ask:   [{ label: 'Cursor API Key', path: 'integrations.cursor.api_key', type: 'password', link: 'cursor.com/settings' }],
  github_issue: [{ label: 'GitHub Personal Token', path: 'integrations.github.token', type: 'password', link: 'github.com/settings/tokens' }],
  gcal:         [{ label: 'Google Client ID', path: 'integrations.google.client_id', type: 'text' }, { label: 'Google Client Secret', path: 'integrations.google.client_secret', type: 'password', link: 'console.cloud.google.com' }],
  gsheets:      [{ label: 'Google Client ID', path: 'integrations.google.client_id', type: 'text' }, { label: 'Google Client Secret', path: 'integrations.google.client_secret', type: 'password', link: 'console.cloud.google.com' }],
};

async function loadSkillsView() {
  const all = await api('/skills/list').catch(() => []);
  const skills = all.filter(s => !CHANNEL_SKILLS.has(s.stem));
  _skillsCache = skills;
  const grid   = document.getElementById('skills-grid');
  const label  = document.getElementById('skills-count-label');
  if (!grid) return;
  if (label) label.textContent = `${skills.length} skill${skills.length !== 1 ? 's' : ''} installed`;
  if (!skills.length) {
    grid.innerHTML = '<div style="color:var(--tx4);font-size:13px;padding:40px;grid-column:1/-1;text-align:center">No skills installed yet.<br><span style="opacity:.6;font-size:11px">Click + New Skill to add one.</span></div>';
    return;
  }
  grid.innerHTML = skills.map((s, i) => {
    const icon = skillIcon(s.name || s.stem);
    const name = s.name || s.stem;
    const desc = s.description || 'No description';
    return `<div onclick="openSkillDetail(${i})" style="background:var(--bg2);border:1px solid var(--bd);border-radius:12px;padding:14px 16px;display:flex;flex-direction:column;gap:8px;transition:border-color .15s,box-shadow .15s;cursor:pointer" onmouseover="this.style.borderColor='var(--acc)';this.style.boxShadow='0 0 0 1px var(--acc)'" onmouseout="this.style.borderColor='var(--bd)';this.style.boxShadow='none'">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:9px">
          <div style="width:32px;height:32px;border-radius:8px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">${icon}</div>
          <div>
            <div style="font-size:12px;font-weight:600;color:var(--tx1);letter-spacing:.01em">${xss(name)}</div>
            <div style="font-size:10px;color:var(--tx4);font-family:var(--font-m);margin-top:1px">${xss(s.file)}</div>
          </div>
        </div>
        <button onclick="event.stopPropagation();deleteSkill('${xss(name)}')" style="width:26px;height:26px;border:none;background:var(--bg3);cursor:pointer;color:var(--tx4);font-size:12px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s,color .15s" onmouseover="this.style.background='rgba(220,38,38,.12)';this.style.color='#dc2626'" onmouseout="this.style.background='var(--bg3)';this.style.color='var(--tx4)'">✕</button>
      </div>
      <div style="font-size:11px;color:var(--tx3);line-height:1.55;padding-left:41px">${xss(desc)}</div>
    </div>`;
  }).join('');
}

async function openSkillDetail(idx) {
  const s = _skillsCache[idx];
  if (!s) return;
  const name = s.name || s.stem;
  document.getElementById('sdm-title').textContent = name;
  document.getElementById('sdm-desc').textContent = s.description || 'No description';
  document.getElementById('sdm-file').textContent = s.file;
  document.getElementById('sdm-code').value = 'Loading…';

  // API key config section
  const keys = SKILL_KEY_MAP[s.stem] || [];
  let keySection = document.getElementById('sdm-keys-section');
  if (!keySection) {
    keySection = document.createElement('div');
    keySection.id = 'sdm-keys-section';
    // Insert before the modal-actions div
    const modalActions = document.querySelector('#skill-detail-modal .modal-actions');
    if (modalActions) modalActions.parentNode.insertBefore(keySection, modalActions);
  }
  if (keys.length) {
    const cfg = await api('/config').catch(()=>({}));
    const getVal = path => path.split('.').reduce((o,k) => o?.[k], cfg) || '';
    keySection.innerHTML = `<div class="field" style="margin-bottom:16px;padding:14px;background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);border-radius:8px">
      <label style="color:var(--amber);margin-bottom:10px;display:block">API Configuration</label>
      <div style="display:flex;flex-direction:column;gap:8px">
        ${keys.map((k,i) => `<div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:11px;color:var(--tx3);min-width:150px;flex-shrink:0">${k.label}</span>
          <input id="sdm-key-${i}" type="${k.type}" value="${xss(getVal(k.path))}" placeholder="${k.type==='password'?'Enter key…':''}" style="flex:1;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;padding:7px 10px;font-size:11.5px;color:var(--tx);font-family:var(--font-b);min-width:0;box-sizing:border-box">
          ${k.link ? `<a href="https://${k.link}" target="_blank" style="font-size:10px;color:var(--acc);white-space:nowrap;text-decoration:none;flex-shrink:0">Get ↗</a>` : ''}
        </div>`).join('')}
      </div>
      <button onclick="saveSkillKeys(${idx})" style="margin-top:10px;height:28px;padding:0 14px;border-radius:6px;border:none;background:var(--acc);color:#fff;font-size:11px;font-weight:600;cursor:pointer;letter-spacing:.02em">Save Keys</button>
    </div>`;
  } else {
    keySection.innerHTML = '';
  }

  openOverlay('skill-detail-modal');
  const res = await api(`/skills/get?name=${encodeURIComponent(s.stem)}`).catch(() => null);
  document.getElementById('sdm-code').value = res?.code || '# Code not available';

  const btn = document.getElementById('sdm-delete-btn');
  btn.onclick = async () => {
    if (!confirm(`Delete skill '${name}'?`)) return;
    const del = await api('/skills/delete', { name: s.stem }).catch(() => null);
    if (del?.success) { closeOverlay('skill-detail-modal'); addToast(`Skill '${name}' deleted`); loadSkillsView(); }
    else addToast('Delete failed');
  };
}

async function saveSkillKeys(idx) {
  const s = _skillsCache[idx];
  if (!s) return;
  const keys = SKILL_KEY_MAP[s.stem] || [];
  const cfg = await api('/config').catch(()=>({}));
  const integrations = JSON.parse(JSON.stringify(cfg.integrations || {}));
  keys.forEach((k, i) => {
    const val = document.getElementById(`sdm-key-${i}`)?.value?.trim();
    if (!val || val.includes('••')) return;
    const parts = k.path.split('.'); // integrations.X.Y
    const section = parts[1]; const field = parts[2];
    if (!integrations[section]) integrations[section] = {};
    integrations[section][field] = val;
  });
  const res = await api('/keys', integrations).catch(()=>null);
  if (res?.success) addToast('API keys saved');
  else addToast('Save failed — check daemon');
}

async function deleteSkill(name) {
  if (!confirm(`Delete skill '${name}'?`)) return;
  const res = await api('/skills/delete', { name }).catch(() => null);
  if (res?.success) { addToast(`Skill '${name}' deleted`); loadSkillsView(); }
  else addToast('Delete failed — check daemon');
}

function openSkillCreator() { openOverlay('skill-creator-modal'); }
function closeSkillCreator() {
  closeOverlay('skill-creator-modal');
}

async function saveNewSkill() {
  const nameRaw  = document.getElementById('skill-name-input')?.value?.trim() || '';
  const name     = nameRaw.toLowerCase().replace(/[^a-z0-9_]/g, '_');
  const desc     = document.getElementById('skill-desc-input')?.value?.trim() || '';
  const behavior = document.getElementById('skill-behavior-input')?.value?.trim() || '';
  const paramsRaw = document.getElementById('skill-params-input')?.value?.trim() || '';

  if (!name) { addToast('Skill name required'); return; }
  if (!behavior) { addToast('Please describe what this skill should do'); return; }

  // Auto-generate a stub with docstring + param extraction so daemon can wire it up
  const paramList = paramsRaw
    ? paramsRaw.split(',').map(p => p.trim()).filter(Boolean)
    : [];
  const paramLines = paramList.map(p =>
    `    ${p} = kwargs.get('${p}', '')`
  ).join('\n');
  const code = `"""\nSkill: ${name}\n${desc || behavior}\n\nBehavior:\n${behavior}\n"""\ndef run(**kwargs) -> str:\n${paramLines || '    pass  # no required inputs'}\n    # TODO: implement skill logic\n    return f"Skill '${name}' executed"\n`;

  const res = await api('/skills/save', { name, code }).catch(() => null);
  if (res?.success) {
    closeSkillCreator();
    loadSkillsView();
    addToast(`Skill '${name}' created`);
    ['skill-name-input','skill-desc-input','skill-behavior-input','skill-params-input'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
  } else {
    addToast('Save failed — check daemon connection');
  }
}

// ══════════════════════════════════════════
//  START
// ══════════════════════════════════════════
init();
</script>
</body>
</html>
